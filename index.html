<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SCAPE ROOM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêÖ</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              cyber: {
                black: '#050505',
                green: '#00ff41',
                blue: '#00f3ff',
                red: '#ff003c',
                dim: 'rgba(0, 255, 65, 0.1)',
                gold: '#ffd700',
              }
            },
            fontFamily: {
              mono: ['"Share Tech Mono"', 'monospace'],
            },
            animation: {
              'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'glitch': 'glitch 1s linear infinite',
            },
            keyframes: {
              glitch: {
                '2%, 64%': { transform: 'translate(2px,0) skew(0deg)' },
                '4%, 60%': { transform: 'translate(-2px,0) skew(0deg)' },
                '62%': { transform: 'translate(0,0) skew(5deg)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #050505;
        color: #00ff41;
        overflow-x: hidden;
      }
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #050505; }
      ::-webkit-scrollbar-thumb { background: #00ff41; }
      .glitch-effect { text-shadow: 2px 0 #ff003c, -2px 0 #00f3ff; }
      .crt-line {
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 2px, 3px 100%;
        pointer-events: none;
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "peerjs": "https://esm.sh/peerjs@^1.5.5"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>
    <div class="fixed inset-0 crt-line z-50 pointer-events-none opacity-20"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback } = React;
      
      const SQUADS = [
        { name: 'Cobra', icon: 'üêç' },
        { name: 'Tigre', icon: 'üêÖ' },
        { name: 'Halc√≥n', icon: 'ü¶Ö' },
        { name: 'Lobo', icon: 'üê∫' },
        { name: 'Tibur√≥n', icon: 'ü¶à' },
        { name: '√Åguila', icon: 'ü¶Ö' },
        { name: 'Pantera', icon: 'üêÜ' },
        { name: 'Oso', icon: 'üêª' },
      ];

      const MUSIC_URL = "https://cdn.pixabay.com/audio/2023/12/03/audio_82c610484a.mp3"; // Lo-fi Cyberpunk style track

      const EXAMPLE_CSV_CONTENT = `Tipo;Pregunta;R1;R2;R3;R4;Tiempo;Correcta;URL Imagen
quiz;¬øQu√© operador repite cadenas en Python?;\*  ;x;repeat();\**;30;1;
quiz;¬øQu√© m√©todo especial se ejecuta al crear un objeto?;\_\_init\_\_;\_\_start\_\_;constructor;\_\_new\_\_;30;1;
quiz;¬øQu√© operador concatena cadenas en Python?;\+  ;concat();join;.;30;1;
quiz;¬øQu√© operador verifica "mayor o igual que" en Python?>;\>=;= >;mayor_igual;ge();30;1;
quiz;¬øC√≥mo se escribe un comentario de una l√≠nea en Python?;\#;//;--;/*;20;1;
quiz;¬øSobre qu√© itera normalmente un bucle for en Python?;Secuencias;Solo n√∫meros;Condiciones booleanas;Solo cadenas;30;1;
quiz;¬øC√≥mo se definen cadenas de m√∫ltiples l√≠neas en Python?;Triples comillas;Comillas simples con \\n;Corchetes con saltos;Par√©ntesis con comas;30;1;
quiz;¬øCu√°l es una caracter√≠stica principal de Python?;Interpretado;Compilado est√°ticamente;Solo soporta POO;Exclusivo de Windows;30;1;
quiz;¬øQu√© es una clase en POO seg√∫n el material?;Plantilla;Instancia concreta;Variable global;Funci√≥n especial;30;1;
quiz;¬øQu√© funci√≥n convierte cualquier valor a cadena?;str();string();toString();to_str();30;1;
quiz;¬øQu√© palabra clave define una funci√≥n en Python?;def;function;func;define;20;1;
quiz;¬øQu√© estructura de datos almacena pares clave-valor?;Diccionario;Lista;Tupla;Conjunto;30;1;
quiz;¬øQu√© operador realiza divisi√≥n entera en Python?;//;/;div;%;30;1;
quiz;¬øQu√© significa elif en Python?;Else if;Else en if;End if;If else;30;1;
quiz;¬øQu√© tipo de dato devuelve input()?;Cadena;Entero;Depende;Lista de caracteres;30;1;
quiz;¬øQu√© hace range(5) en un bucle for?;0 a 4;1 a 5;0 a 5;5 n√∫meros aleatorios;30;1;
quiz;¬øQu√© permite la herencia en POO?;Crear clases basadas en otras;Ocultar datos internos;Ejecutar m√∫ltiples m√©todos;Convertir objetos en clases;30;1;
quiz;¬øC√≥mo se describen las listas en Python?;Ordenadas y modificables;Inmutables y ordenadas;No ordenadas y modificables;Solo almacenan n√∫meros;30;1;
quiz;¬øQu√© operador verifica desigualdad en Python?;!=;=!;not=;ne();30;1;
quiz;¬øQu√© operador se usa para exponentes en Python?;**;^;exp();//;30;1;`;

      const parseCSV = (csvText) => {
        const lines = csvText.trim().split('\n');
        const questions = [];
        const startIndex = lines[0].toLowerCase().includes('tipo') ? 1 : 0;
        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          const parts = line.split(';').map(p => p.trim().replace(/^"|"$/g, ''));
          if (parts.length < 8) continue;
          const originalOptions = [parts[2], parts[3], parts[4], parts[5]].filter(o => o !== '');
          const correctIndexRaw = parseInt(parts[7], 10);
          let correctIndex = isNaN(correctIndexRaw) ? 0 : correctIndexRaw - 1;
          const correctAnswer = originalOptions[correctIndex];
          const options = [...originalOptions].sort(() => Math.random() - 0.5);
          questions.push({
            id: `q-${i}`,
            question: parts[1],
            options,
            timeLimit: parseInt(parts[6], 10) || 45,
            correctIndex: options.indexOf(correctAnswer),
            imageUrl: parts[8] || undefined
          });
        }
        return questions;
      };

      const Typewriter = ({ text, speed = 30, onComplete, className }) => {
        const [displayedText, setDisplayedText] = useState('');
        useEffect(() => {
          setDisplayedText('');
          let index = 0;
          const timer = setInterval(() => {
            if (index < text.length) {
              setDisplayedText((prev) => prev + text.charAt(index));
              index++;
            } else {
              clearInterval(timer);
              if (onComplete) onComplete();
            }
          }, speed);
          return () => clearInterval(timer);
        }, [text]);
        return <div className={`font-mono ${className}`}>{displayedText}<span className="animate-pulse inline-block w-2 h-4 bg-cyber-green ml-1 align-middle"></span></div>;
      };

      const SectorModal = ({ sector, isOpen, onSectorSolved, onSectorLocked }) => {
        const [qIndex, setQIndex] = useState(0);
        const [selectedOption, setSelectedOption] = useState(null);
        const [feedback, setFeedback] = useState('neutral');
        const currentQ = sector.questions[qIndex];

        if (!isOpen || !currentQ) return null;

        const handleOptionClick = (idx) => {
          if (feedback !== 'neutral') return;
          setSelectedOption(idx);
          if (idx === currentQ.correctIndex) {
            setFeedback('correct');
            setTimeout(() => {
              if (qIndex + 1 < sector.questions.length) {
                setQIndex(prev => prev + 1);
                setFeedback('neutral');
                setSelectedOption(null);
              } else { onSectorSolved(sector.id); }
            }, 1000);
          } else {
            setFeedback('wrong');
            setTimeout(() => { onSectorLocked(sector.id); }, 1500);
          }
        };

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/95 p-4">
            <div className="w-full max-w-2xl border-2 border-cyber-green bg-black p-6 shadow-[0_0_20px_rgba(0,255,65,0.3)]">
              <h2 className="text-xl font-bold text-cyber-green mb-6 border-b border-cyber-green/30 pb-2 uppercase tracking-tighter">
                {sector.name} // ENIGMA {qIndex + 1}/{sector.questions.length}
              </h2>
              <p className="text-xl text-white mb-8">{currentQ.question}</p>
              <div className="grid grid-cols-1 gap-4">
                {currentQ.options.map((opt, idx) => {
                  let colorClass = "border-cyber-green/50 text-cyber-green hover:bg-cyber-green/10";
                  if (selectedOption === idx) {
                    colorClass = feedback === 'correct' ? "bg-cyber-green text-black font-bold border-white" : "bg-cyber-red/20 text-cyber-red border-cyber-red";
                  }
                  return <button key={idx} onClick={() => handleOptionClick(idx)} className={`p-4 border text-left font-mono transition-all ${colorClass}`}>{opt}</button>;
                })}
              </div>
            </div>
          </div>
        );
      };

      function App() {
        const [gameState, setGameState] = useState({ stage: 'selection', sectors: [], connectedSquads: [], takenSquads: [], finishedSquads: [] });
        const [isMuted, setIsMuted] = useState(true);
        const [isConnecting, setIsConnecting] = useState(false);
        const [roomId, setRoomId] = useState('');
        const [activeSectorId, setActiveSectorId] = useState(null);
        const [vaultInputs, setVaultInputs] = useState(['', '', '', '', '']);
        const audioRef = useRef(null);
        const peerRef = useRef(null);
        const connRef = useRef(null);

        useEffect(() => {
          audioRef.current = new Audio(MUSIC_URL);
          audioRef.current.loop = true;
          audioRef.current.volume = 0.3;
          return () => { if (audioRef.current) audioRef.current.pause(); };
        }, []);

        useEffect(() => {
          if (!audioRef.current) return;
          if (isMuted) { audioRef.current.pause(); } 
          else { audioRef.current.play().catch(e => console.log("User interaction required")); }
        }, [isMuted]);

        const toggleAudio = () => setIsMuted(!isMuted);

        const downloadExampleCSV = () => {
          const blob = new Blob([EXAMPLE_CSV_CONTENT], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.setAttribute('download', 'ejemplo_scape_room.csv');
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        const connectToRoom = (id) => {
          setIsConnecting(true);
          const peer = new Peer();
          peer.on('open', () => {
            const conn = peer.connect(`scaperoom-host-${id.toUpperCase().trim()}`);
            conn.on('open', () => { connRef.current = conn; });
            conn.on('data', (data) => {
              if (data.type === 'SYNC_SQUADS') {
                setIsConnecting(false);
                setGameState(prev => ({ ...prev, stage: 'squad-selection', takenSquads: data.taken }));
              }
              if (data.type === 'SQUAD_ACCEPTED') setGameState(prev => ({ ...prev, stage: 'squad-lobby' }));
              if (data.type === 'START_MISSION') {
                setGameState(prev => ({ ...prev, stage: 'squad-intro', adminKeyword: data.payload.keyword, sectors: data.payload.sectors }));
              }
            });
          });
          peerRef.current = peer;
        };

        const selectSquad = (name) => {
          if (connRef.current) {
            setGameState(prev => ({ ...prev, squadAnimal: name }));
            connRef.current.send({ type: 'REQUEST_SQUAD', squadName: name });
          }
        };

        if (gameState.stage === 'selection') {
          return (
            <div className="min-h-screen flex flex-col items-center justify-center p-4 font-mono bg-cyber-black relative overflow-hidden">
              <button onClick={toggleAudio} className={`fixed top-4 right-4 z-[100] p-3 border-2 transition-all ${isMuted ? 'border-cyber-red/50 text-cyber-red/50' : 'border-cyber-green text-cyber-green shadow-[0_0_10px_#00ff41]'}`}>
                {isMuted ? 'üîá M√öSICA_OFF' : 'üîä M√öSICA_ON'}
              </button>
              <div className="absolute inset-0 bg-[url('https://cdn.pixabay.com/photo/2018/06/06/11/47/technology-3457279_1280.jpg')] opacity-10 bg-cover bg-center"></div>
              <h1 className="text-6xl md:text-8xl font-black text-cyber-green glitch-effect mb-12 text-center">SCAPE ROOM</h1>
              <div className="flex flex-col md:flex-row gap-8 z-10">
                <button onClick={() => setGameState(p => ({...p, stage: 'admin-setup'}))} className="px-8 py-4 border-2 border-cyber-green text-cyber-green text-2xl font-bold hover:bg-cyber-green hover:text-black transition-all">ADMINISTRADOR</button>
                <button onClick={() => setGameState(p => ({...p, stage: 'squad-setup'}))} className="px-8 py-4 border-2 border-cyber-blue text-cyber-blue text-2xl font-bold hover:bg-cyber-blue hover:text-black transition-all">ESCUADR√ìN</button>
              </div>
              <div className="mt-12 z-10 text-center">
                <button onClick={downloadExampleCSV} className="text-cyber-blue hover:text-white underline decoration-dotted uppercase tracking-widest bg-black/60 px-6 py-3 border border-cyber-blue/30 text-sm">
                  [ Descargar CSV de ejemplo ]
                </button>
                <p className="mt-3 text-[10px] text-gray-500 uppercase">Utiliza esta plantilla para cargar tus propias preguntas de misi√≥n</p>
              </div>
            </div>
          );
        }

        if (gameState.stage === 'squad-setup') {
          return (
            <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-black font-mono">
              <h2 className="text-3xl text-cyber-blue mb-8 uppercase tracking-widest">ENLACE AL SISTEMA</h2>
              <div className="w-full max-w-xs space-y-4">
                <input type="text" placeholder="ID DE SALA" maxLength={5} value={roomId} onChange={(e) => setRoomId(e.target.value.toUpperCase())} className="w-full bg-black border-2 border-cyber-blue p-4 text-center text-2xl text-white focus:border-cyber-green outline-none" />
                <button onClick={() => connectToRoom(roomId)} disabled={isConnecting} className="w-full bg-cyber-blue text-black font-bold py-4 text-xl hover:bg-white transition-colors">{isConnecting ? 'CONECTANDO...' : 'CONECTAR'}</button>
              </div>
            </div>
          );
        }

        if (gameState.stage === 'squad-selection') {
          return (
            <div className="min-h-screen flex flex-col items-center justify-center p-8 bg-black font-mono">
              <h2 className="text-3xl text-cyber-blue mb-2 uppercase tracking-tighter font-bold">SELECCIONA TU UNIDAD</h2>
              <p className="text-gray-500 mb-10 text-xs uppercase tracking-widest">Registrando escuadr√≥n en la red local...</p>
              {gameState.squadAnimal && (
                  <div className="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center backdrop-blur-sm">
                      <h3 className="text-2xl text-cyber-green font-bold animate-pulse uppercase">REGISTRANDO {gameState.squadAnimal}...</h3>
                      <p className="text-cyber-blue mt-2 text-xs uppercase">Estableciendo enlace con comando</p>
                  </div>
              )}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {SQUADS.map((s) => {
                  const taken = gameState.takenSquads.includes(s.name);
                  return <button key={s.name} onClick={() => selectSquad(s.name)} disabled={taken} className={`p-6 border-2 flex flex-col items-center gap-2 transition-all ${taken ? 'border-gray-800 bg-gray-900 opacity-20 grayscale cursor-not-allowed' : 'border-gray-700 hover:border-cyber-blue hover:shadow-[0_0_15px_#00f3ff]'}`}>
                    <span className="text-4xl">{s.icon}</span>
                    <span className="font-bold uppercase text-xs">{s.name}</span>
                  </button>
                })}
              </div>
            </div>
          );
        }

        if (gameState.stage === 'squad-lobby') {
          return (
            <div className="min-h-screen flex items-center justify-center p-4 bg-black font-mono text-center">
              <div className="w-full max-w-md border border-cyber-green/30 bg-cyber-green/5 p-12 relative overflow-hidden">
                <div className="text-6xl mb-6 animate-bounce">‚è≥</div>
                <h2 className="text-2xl font-bold text-cyber-green mb-2 uppercase tracking-widest">ESCUADR√ìN {gameState.squadAnimal}</h2>
                <p className="text-cyber-blue animate-pulse mt-8 uppercase font-bold">Esperando se√±al de inicio del Administrador...</p>
                <p className="text-[10px] text-gray-500 mt-4 uppercase">No cierres esta terminal. Protocolo de sincronizaci√≥n en curso.</p>
              </div>
            </div>
          );
        }

        if (gameState.stage === 'squad-intro') {
          return <div className="min-h-screen flex items-center justify-center p-8 bg-black"><div className="max-w-2xl border border-cyber-green p-8"><Typewriter text={`>>> ATENCI√ìN ESCUADR√ìN ${gameState.squadAnimal}.\n\nSeguridad comprometida. Ten√©is 5 sectores que desbloquear.\nCada sector os dar√° un fragmento del c√≥digo.\nIngresadlos en la B√ìVEDA MAESTRA para obtener la CLAVE FINAL.\n\nEL FRACASO NO ES OPCI√ìN.`} speed={25} onComplete={() => {}} className="text-lg text-cyber-green leading-relaxed whitespace-pre-wrap" /><button onClick={() => setGameState(p => ({...p, stage: 'squad-game'}))} className="mt-8 px-6 py-3 bg-cyber-green text-black font-bold uppercase tracking-widest hover:bg-white transition-colors">ACEPTAR MISI√ìN</button></div></div>;
        }

        if (gameState.stage === 'squad-game') {
          const activeSector = gameState.sectors.find(s => s.id === activeSectorId);
          return (
            <div className="min-h-screen bg-black text-white font-mono p-4 md:p-8 flex flex-col md:flex-row gap-8">
               <div className="flex-1">
                  <header className="mb-8 border-b border-cyber-green/30 pb-4">
                    <h1 className="text-3xl font-bold text-cyber-green glitch-effect uppercase tracking-tighter">Panel de Misi√≥n</h1>
                    <p className="text-xs text-cyber-blue font-bold uppercase tracking-widest mt-1">Escuadr√≥n: {gameState.squadAnimal}</p>
                  </header>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    {gameState.sectors.map((s) => (
                      <div key={s.id} onClick={() => !s.isSolved && setActiveSectorId(s.id)} className={`border-2 p-6 cursor-pointer transition-all ${s.isSolved ? 'border-cyber-green bg-cyber-green/20' : 'border-cyber-blue/50 hover:bg-cyber-blue/10'}`}>
                        <div className="flex justify-between items-start mb-4 uppercase font-bold text-sm"><span>{s.name}</span><span>{s.isSolved ? '‚úî' : '‚¶ø'}</span></div>
                        <div className="mt-2 text-3xl font-black text-white">{s.isSolved ? s.accessCode : '??'}</div>
                      </div>
                    ))}
                  </div>
               </div>
               <div className="w-full md:w-80 border-l border-cyber-green/30 md:pl-8">
                  <div className="border-2 border-cyber-blue p-6 bg-cyber-blue/5">
                    <h2 className="text-xl text-cyber-blue font-bold mb-6 flex items-center gap-2 uppercase tracking-widest">üîí B√≥veda</h2>
                    <div className="space-y-4">
                       {vaultInputs.map((val, idx) => (
                         <div key={idx} className="flex items-center justify-between"><label className="text-[10px] text-cyber-green uppercase">Sector 0{idx+1}</label><input type="text" maxLength={2} value={val} onChange={(e) => { const n = [...vaultInputs]; n[idx] = e.target.value; setVaultInputs(n); }} className="w-12 bg-black border border-gray-700 text-center text-white py-1" /></div>
                       ))}
                       <button onClick={() => {
                         const correct = gameState.sectors.every((s, i) => vaultInputs[i] === s.accessCode);
                         if (correct) setGameState(p => ({...p, stage: 'squad-win'}));
                         else alert("C√ìDIGOS INCORRECTOS");
                       }} className="w-full mt-6 bg-cyber-blue text-black font-bold py-3 uppercase tracking-tighter hover:bg-white transition-colors">DESBLOQUEAR</button>
                    </div>
                  </div>
               </div>
               {activeSector && <SectorModal sector={activeSector} isOpen={!!activeSector} onSectorSolved={(id) => { setGameState(p => ({...p, sectors: p.sectors.map(s => s.id === id ? {...s, isSolved: true} : s)})); setActiveSectorId(null); }} onSectorLocked={() => setActiveSectorId(null)} />}
            </div>
          );
        }

        if (gameState.stage === 'squad-win') {
          return (
            <div className="min-h-screen flex items-center justify-center p-8 bg-black text-center font-mono">
              <div className="border-4 border-cyber-green p-12 bg-cyber-green/10 shadow-[0_0_50px_#00ff41]">
                <h2 className="text-5xl font-black text-cyber-green mb-4 glitch-effect uppercase">¬°MISI√ìN COMPLETADA!</h2>
                <p className="text-cyber-blue mb-8 uppercase font-bold tracking-widest">Clave Final Decriptada:</p>
                <div className="text-6xl bg-cyber-green text-black font-black py-6 px-12 mb-8 border-4 border-white shadow-[0_0_20px_#fff]">{gameState.adminKeyword}</div>
                <p className="text-white text-xl animate-pulse font-bold uppercase">¬°GRITA ESTA CLAVE AL ADMINISTRADOR PARA GANAR!</p>
              </div>
            </div>
          );
        }

        return <div className="p-8 text-cyber-red font-mono">Vista "{gameState.stage}" en desarrollo o no disponible en esta demo interactiva.</div>;
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
