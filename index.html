<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SCAPE ROOM</title>
     <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêÖ</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD versions for direct browser usage) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- Babel Standalone for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              cyber: {
                black: '#050505',
                green: '#00ff41',
                blue: '#00f3ff',
                red: '#ff003c',
                dim: 'rgba(0, 255, 65, 0.1)',
                gold: '#ffd700',
              }
            },
            fontFamily: {
              mono: ['"Share Tech Mono"', '"Courier Prime"', 'monospace'],
            },
            animation: {
              'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'glitch': 'glitch 1s linear infinite',
            },
            keyframes: {
              glitch: {
                '2%, 64%': { transform: 'translate(2px,0) skew(0deg)' },
                '4%, 60%': { transform: 'translate(-2px,0) skew(0deg)' },
                '62%': { transform: 'translate(0,0) skew(5deg)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #050505;
        color: #00ff41;
        overflow-x: hidden;
      }
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #050505; }
      ::-webkit-scrollbar-thumb { background: #00ff41; }
      .glitch-effect { text-shadow: 2px 0 #ff003c, -2px 0 #00f3ff; }
      .crt-line {
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 2px, 3px 100%;
        pointer-events: none;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "peerjs": "https://esm.sh/peerjs@^1.5.5"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>
    <div class="fixed inset-0 crt-line z-50 pointer-events-none opacity-20"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-presets="typescript,react">
      const { useState, useEffect, useRef, useCallback } = React;
      
      /* ------------------------------------------------------------
         CONSTANTS & TYPES
         ------------------------------------------------------------ */
      
      const SQUADS = [
        { name: 'Cobra', icon: 'üêç' },
        { name: 'Tigre', icon: 'üêÖ' },
        { name: 'Halc√≥n', icon: 'ü¶Ö' },
        { name: 'Lobo', icon: 'üê∫' },
        { name: 'Tibur√≥n', icon: 'ü¶à' },
        { name: '√Åguila', icon: 'ü¶Ö' },
        { name: 'Pantera', icon: 'üêÜ' },
        { name: 'Oso', icon: 'üêª' },
      ];

      /* ------------------------------------------------------------
         UTILS
         ------------------------------------------------------------ */
      const parseCSV = (csvText) => {
        const lines = csvText.trim().split('\n');
        const questions = [];
        const startIndex = lines[0].toLowerCase().includes('tipo') ? 1 : 0;

        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          const parts = line.split(';').map(p => p.trim().replace(/^"|"$/g, ''));
          if (parts.length < 8) continue;

          const type = parts[0];
          const questionText = parts[1];
          const originalOptions = [parts[2], parts[3], parts[4], parts[5]].filter(o => o !== '');
          const timeLimit = parseInt(parts[6], 10) || 45;
          const correctIndexRaw = parseInt(parts[7], 10);
          let correctIndex = isNaN(correctIndexRaw) ? 0 : correctIndexRaw - 1;
          
          if (correctIndex < 0) correctIndex = 0;
          if (correctIndex >= originalOptions.length) correctIndex = originalOptions.length - 1;
          
          const correctAnswer = originalOptions[correctIndex];
          const imageUrl = parts[8] || undefined;

          const options = [...originalOptions];
          for (let k = options.length - 1; k > 0; k--) {
              const j = Math.floor(Math.random() * (k + 1));
              [options[k], options[j]] = [options[j], options[k]];
          }
          
          const newCorrectIndex = options.indexOf(correctAnswer);

          questions.push({
            id: `q-${i}`,
            type,
            question: questionText,
            options,
            timeLimit,
            correctIndex: newCorrectIndex,
            imageUrl
          });
        }
        return questions;
      };

      const generateShortId = () => {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let result = '';
        for (let i = 0; i < 5; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      };

      const formatTime = (ms) => {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
      };

      /* ------------------------------------------------------------
         COMPONENTS
         ------------------------------------------------------------ */
      
      const Typewriter = ({ text, speed = 30, onComplete, className }) => {
        const [displayedText, setDisplayedText] = useState('');
        const onCompleteRef = useRef(onComplete);
        useEffect(() => { onCompleteRef.current = onComplete; }, [onComplete]);

        useEffect(() => {
          setDisplayedText('');
          let index = 0;
          const timer = setInterval(() => {
            if (index < text.length) {
              setDisplayedText((prev) => prev + text.charAt(index));
              index++;
            } else {
              clearInterval(timer);
              if (onCompleteRef.current) onCompleteRef.current();
            }
          }, speed);

          return () => clearInterval(timer);
        }, [text, speed]); 

        return (
          <div className={`font-mono ${className}`}>
            {displayedText}
            <span className="animate-pulse inline-block w-2 h-4 bg-cyber-green ml-1 align-middle"></span>
          </div>
        );
      };

      const MissionTimer = ({ startTime, endTime }) => {
        const [elapsed, setElapsed] = useState(0);

        useEffect(() => {
            if (!startTime) return;
            const calc = () => {
                const end = endTime || Date.now();
                setElapsed(Math.floor((end - startTime) / 1000));
            };
            calc();
            if (endTime) return;
            const interval = setInterval(calc, 1000);
            return () => clearInterval(interval);
        }, [startTime, endTime]);

        const format = (secs) => {
            const m = Math.floor(secs / 60).toString().padStart(2, '0');
            const s = (secs % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        };

        return (
            <div className="flex flex-col items-end">
                <span className="text-xs text-cyber-blue tracking-widest">TIEMPO MISI√ìN</span>
                <div className="text-3xl md:text-4xl font-black font-mono text-cyber-green border-2 border-cyber-green px-4 py-1 bg-black/50 shadow-[0_0_15px_#00ff41]">
                    {format(elapsed)}
                </div>
            </div>
        );
      };

      const MissionIntro = ({ onStart }) => {
          const [finished, setFinished] = useState(false);
          const introText = ">>> CONEXI√ìN ESTABLECIDA.\n\n>>> PROTOCOLO DE MISI√ìN:\n1. SUPERAD LAS 5 FASES DE SEGURIDAD.\n2. CUIDADO: SI FALL√ÅIS, SE ACTIVAR√Å UN BLOQUEO TOTAL DE 10 SEGUNDOS.\n3. OBTENED LOS C√ìDIGOS DE CADA SECTOR.\n4. DESBLOQUEAD LA B√ìVEDA MAESTRA.\n5. ¬°AL FINAL, GRITAD LA PALABRA CLAVE AL ADMINISTRADOR PARA GANAR!\n\n>>> ¬øEST√ÅIS LISTOS?";

          return (
              <div className="min-h-screen p-8 flex items-center justify-center font-mono bg-black">
                  <div className="max-w-3xl border border-cyber-green p-8 shadow-[0_0_30px_rgba(0,255,65,0.1)] bg-black/90">
                      <Typewriter 
                        text={introText}
                        speed={20}
                        className="text-lg md:text-xl text-cyber-green leading-relaxed whitespace-pre-wrap"
                        onComplete={() => setFinished(true)}
                      />
                      
                      <div className="mt-8 h-16 flex justify-center">
                          {finished ? (
                              <button 
                                  onClick={onStart}
                                  className="px-8 py-3 bg-cyber-green text-black font-bold text-xl hover:bg-white hover:scale-105 transition-all shadow-[0_0_15px_#00ff41]"
                              >
                                  [ COMENZAR MISI√ìN ]
                              </button>
                          ) : (
                              <span className="text-cyber-dim animate-pulse">RECIBIENDO TRANSMISI√ìN...</span>
                          )}
                      </div>
                  </div>
              </div>
          );
      };

      const SectorModal = ({ sector, isOpen, onSectorSolved, onSectorLocked }) => {
        const [qIndex, setQIndex] = useState(0);
        const [selectedOption, setSelectedOption] = useState(null);
        const [feedback, setFeedback] = useState('neutral');

        useEffect(() => {
          if (isOpen) {
            setQIndex(sector.currentQuestionIndex);
            setFeedback('neutral');
            setSelectedOption(null);
          }
        }, [isOpen, sector]);

        if (!isOpen) return null;
        if (sector.isLocked) return null;

        const currentQ = sector.questions[qIndex];

        if (!currentQ) {
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
              <div className="border border-cyber-red text-cyber-red p-8 font-mono text-xl animate-pulse">
                ERROR: DATOS DE SECTOR NO ENCONTRADOS
              </div>
            </div>
          );
        }

        const handleOptionClick = (index) => {
          if (feedback !== 'neutral') return;
          setSelectedOption(index);

          if (index === currentQ.correctIndex) {
            setFeedback('correct');
            setTimeout(() => {
              if (qIndex + 1 < sector.questions.length) {
                setQIndex(prev => prev + 1);
                setFeedback('neutral');
                setSelectedOption(null);
              } else {
                  onSectorSolved(sector.id);
              }
            }, 1000);
          } else {
            setFeedback('wrong');
            setTimeout(() => {
              onSectorLocked(sector.id);
            }, 1500);
          }
        };

        return (
          <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-cyber-black bg-opacity-95 p-4">
            <div className="w-full max-w-2xl border-2 border-cyber-green shadow-[0_0_20px_rgba(0,255,65,0.3)] bg-black p-6 relative overflow-hidden">
              <div className="flex justify-between items-center mb-6 border-b border-cyber-green/30 pb-2">
                <h2 className="text-2xl font-bold font-mono text-cyber-green">
                  SECTOR {sector.id} // PREGUNTA {qIndex + 1}/{sector.questions.length}
                </h2>
                <div className="text-cyber-blue text-sm animate-pulse">ENCRIPTACI√ìN ACTIVA</div>
              </div>

              <div className="mb-8">
                  {currentQ.imageUrl && (
                      <div className="mb-4 border border-cyber-green/50 p-1">
                          <img src={currentQ.imageUrl} alt="Data Visual" className="w-full h-48 object-cover opacity-80" />
                      </div>
                  )}
                  <p className="text-xl font-mono text-white mb-2 leading-relaxed">
                  {currentQ.question}
                  </p>
              </div>

              <div className="grid grid-cols-1 gap-4">
                {currentQ.options.map((opt, idx) => {
                  let btnClass = "border border-cyber-green/50 p-4 text-left font-mono hover:bg-cyber-green/10 transition-colors text-cyber-green relative group";
                  
                  if (selectedOption === idx) {
                    if (feedback === 'correct') btnClass = "border-2 border-cyber-green bg-cyber-green text-black font-bold";
                    if (feedback === 'wrong') btnClass = "border-2 border-cyber-red bg-cyber-red/20 text-cyber-red";
                  } else if (selectedOption !== null) {
                      btnClass = "border border-gray-800 text-gray-600 opacity-50"; 
                  }

                  return (
                    <button
                      key={idx}
                      onClick={() => handleOptionClick(idx)}
                      className={btnClass}
                      disabled={selectedOption !== null}
                    >
                      <span className="mr-4 opacity-50">&gt;</span>
                      {opt}
                      <div className="absolute inset-0 bg-cyber-green opacity-0 group-hover:opacity-5 pointer-events-none"></div>
                    </button>
                  );
                })}
              </div>
              
              <div className="mt-6 flex justify-between text-xs text-cyber-blue font-mono uppercase">
                <span>ID: {currentQ.id}</span>
                <span>Time Limit: {currentQ.timeLimit}s</span>
              </div>
            </div>
          </div>
        );
      };

      /* ------------------------------------------------------------
         MAIN APPLICATION LOGIC
         ------------------------------------------------------------ */
      const INITIAL_STATE = {
        stage: 'selection',
        role: null,
        roomId: '',
        adminKeyword: '',
        sectors: [],
        squadName: '',
        squadAnimal: null,
        connectedSquads: [],
        finishedSquads: [],
        takenSquads: [] // New: Track taken
      };

      function App() {
        const [gameState, setGameState] = useState(INITIAL_STATE);
        const [errorMsg, setErrorMsg] = useState('');
        
        // Timer State
        const [missionStartTime, setMissionStartTime] = useState(null);
        const [missionEndTime, setMissionEndTime] = useState(null);
        const [tick, setTick] = useState(0);

        // Admin state
        const [csvFile, setCsvFile] = useState(null);
        const [keywordInput, setKeywordInput] = useState('');
        
        // Squad state
        const [joinRoomId, setJoinRoomId] = useState('');
        const [activeSectorId, setActiveSectorId] = useState(null);
        const [vaultInputs, setVaultInputs] = useState(['', '', '', '', '']);
        const [vaultMessage, setVaultMessage] = useState('BLOQUEADO');
        const [finalRevealed, setFinalRevealed] = useState(false);
        const [isConnecting, setIsConnecting] = useState(false);

        // Networking
        const peerRef = useRef(null);
        const connectionsRef = useRef([]); 
        const adminConnRef = useRef(null);
        const adminStartTimeRef = useRef(null);

        // Audio Helper
        const playBeep = (freq = 440, type = 'square') => {
          try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
          } catch(e) { console.warn("Audio error", e); }
        };

        // --- GAME LOGIC ---
        const updateSectorLockout = useCallback(() => {
          setGameState(prev => {
              if (prev.role !== 'squad') return prev;
              const now = Date.now();
              let changed = false;
              
              const newSectors = prev.sectors.map(s => {
                  if (s.isLocked && s.lockoutEndTime && now >= s.lockoutEndTime) {
                      changed = true;
                      return { ...s, isLocked: false, lockoutEndTime: null };
                  }
                  return s;
              });

              return changed ? { ...prev, sectors: newSectors } : prev;
          });
        }, []);

        useEffect(() => {
          const interval = setInterval(() => {
             setTick(t => t + 1);
             updateSectorLockout();
          }, 1000);
          return () => clearInterval(interval);
        }, [updateSectorLockout]);

        const broadcastSquadUpdate = (squads) => {
            connectionsRef.current.forEach(conn => {
                if (conn.open) {
                    conn.send({ type: 'SYNC_SQUADS', taken: squads });
                }
            });
        };

        const startHosting = () => {
          if (!keywordInput || !csvFile) {
              setErrorMsg("FALTA ARCHIVO O PALABRA CLAVE");
              return;
          }

          const shortId = generateShortId();
          const peer = new window.Peer(`scaperoom-host-${shortId}`);
          
          peer.on('open', (id) => {
            console.log('Host Open with ID:', id);
            setGameState(prev => ({ 
              ...prev, 
              role: 'admin', 
              stage: 'admin-lobby', 
              roomId: shortId,
              adminKeyword: keywordInput.toUpperCase() 
            }));
          });

          peer.on('connection', (conn) => {
            connectionsRef.current.push(conn);
            
            conn.on('open', () => {
                // Send current list
                setGameState(prev => {
                    conn.send({ type: 'SYNC_SQUADS', taken: prev.connectedSquads });
                    return prev;
                });
            });

            conn.on('data', (data) => {
              if (data.type === 'REQUEST_SQUAD') {
                  setGameState(prev => {
                      if (prev.connectedSquads.includes(data.squadName)) {
                          conn.send({ type: 'SQUAD_DENIED' });
                          return prev;
                      }
                      
                      const newSquads = [...prev.connectedSquads, data.squadName];
                      conn.send({ type: 'SQUAD_ACCEPTED' });
                      playBeep(880);
                      
                      broadcastSquadUpdate(newSquads);

                      return {
                          ...prev,
                          connectedSquads: newSquads
                      };
                  });
              }

              if (data.type === 'SQUAD_FINISHED') {
                  const now = Date.now();
                  const startTime = adminStartTimeRef.current || now;
                  const duration = now - startTime;

                  setGameState(prev => {
                      if (prev.finishedSquads.some(s => s.name === data.squadName)) return prev;
                      playBeep(1200, 'triangle');
                      return {
                          ...prev,
                          finishedSquads: [...prev.finishedSquads, { name: data.squadName, time: duration }]
                      };
                  });
              }
            });
            
            conn.on('close', () => {
                 connectionsRef.current = connectionsRef.current.filter(c => c !== conn);
            });
          });

          peer.on('error', (err) => {
             console.error(err);
             setErrorMsg("ERROR HOST: " + (err.type || err));
          });

          peerRef.current = peer;
        };

        // NEW LOGIC: Connect First
        const connectToRoom = () => {
          if (!joinRoomId) {
              setErrorMsg("INTRODUCE EL ID");
              return;
          }
          
          setIsConnecting(true); 
          setErrorMsg('');

          const peer = new window.Peer(); 
          peer.on('open', () => {
              const conn = peer.connect(`scaperoom-host-${joinRoomId.toUpperCase().trim()}`);
              
              conn.on('open', () => {
                  adminConnRef.current = conn;
                  // Just wait for sync
              });

              conn.on('data', (data) => {
                  if (data.type === 'SYNC_SQUADS') {
                       setIsConnecting(false);
                       setGameState(prev => ({ 
                           ...prev, 
                           role: 'squad', 
                           stage: 'squad-selection', 
                           takenSquads: data.taken 
                       }));
                  }
                  
                  if (data.type === 'SQUAD_ACCEPTED') {
                      setGameState(prev => ({ ...prev, stage: 'squad-lobby' }));
                  }
                  
                  if (data.type === 'SQUAD_DENIED') {
                      setErrorMsg("¬°ESCUADR√ìN YA OCUPADO!");
                      setGameState(prev => ({ ...prev, squadAnimal: null }));
                  }

                  if (data.type === 'START_MISSION') {
                      setGameState(prev => ({
                          ...prev,
                          stage: 'squad-intro',
                          adminKeyword: data.payload.keyword,
                          sectors: data.payload.sectors
                      }));
                      playBeep(200);
                  }
              });

              conn.on('error', (err) => {
                  setIsConnecting(false);
                  setErrorMsg("ERROR CONEXI√ìN: ID NO ENCONTRADO O ERROR DE RED");
              });
              
              conn.on('close', () => {
                  setIsConnecting(false);
              });
          });
          
          peer.on('error', (err) => {
              setIsConnecting(false);
              if (err.type === 'peer-unavailable') {
                 setErrorMsg("SALA NO ENCONTRADA. VERIFICA EL ID.");
              } else {
                 setErrorMsg("ERROR PEER: " + err.type);
              }
          });

          peerRef.current = peer;
        };
        
        const selectSquad = (animal) => {
            if (gameState.takenSquads.includes(animal)) return;
            setGameState(prev => ({ ...prev, squadAnimal: animal }));
            
            if (adminConnRef.current) {
                adminConnRef.current.send({ type: 'REQUEST_SQUAD', squadName: animal });
            } else {
                setErrorMsg("CONEXI√ìN PERDIDA");
                setGameState(prev => ({ ...prev, squadAnimal: null }));
            }
        };

        const handleStartMission = async () => {
           if (!csvFile) return;
           
           const text = await csvFile.text();
           const allQuestions = parseCSV(text);
           const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
           const totalSectors = 5;
           const newSectors = [];
           const chunkSize = Math.ceil(shuffled.length / totalSectors);
           
           for(let i=0; i<totalSectors; i++) {
              const code = Math.floor(Math.random() * 90 + 10).toString();
              newSectors.push({
                  id: i + 1,
                  name: `SECTOR_0${i+1}`,
                  isLocked: false,
                  lockoutEndTime: null,
                  isSolved: false,
                  questions: shuffled.slice(i*chunkSize, (i+1)*chunkSize),
                  currentQuestionIndex: 0,
                  accessCode: code
              });
           }

           const payload = { keyword: gameState.adminKeyword, sectors: newSectors };
           connectionsRef.current.forEach(conn => {
               conn.send({ type: 'START_MISSION', payload });
           });

           // Set Start Time
           adminStartTimeRef.current = Date.now();

           setGameState(prev => ({ ...prev, stage: 'admin-monitor' }));
        };

        // --- SQUAD LOGIC WITH GLOBAL LOCKOUT ---

        // Check for global lockout
        const activeLockoutSector = gameState.sectors.find(s => s.isLocked && s.lockoutEndTime > Date.now());

        const handleSectorClick = (id) => {
            if (activeLockoutSector) return; // Prevent interaction during global lockout

            const sector = gameState.sectors.find(s => s.id === id);
            if(sector && !sector.isLocked && !sector.isSolved) {
                setActiveSectorId(id);
            }
        };

        const handleSectorSolved = (id) => {
            setActiveSectorId(null);
            setGameState(prev => ({
                ...prev,
                sectors: prev.sectors.map(s => s.id === id ? { ...s, isSolved: true } : s)
            }));
            playBeep(600, 'sine');
        };

        const handleSectorLocked = (id) => {
          setActiveSectorId(null);
          const lockoutTime = Date.now() + 10000; 
          setGameState(prev => ({
              ...prev,
              sectors: prev.sectors.map(s => s.id === id ? { ...s, isLocked: true, lockoutEndTime: lockoutTime } : s)
          }));
          playBeep(150, 'sawtooth');
        };

        const handleVaultInput = (index, val) => {
            if (activeLockoutSector) return; // Prevent vault input during lockout
            if (val.length > 2) return;
            const newInputs = [...vaultInputs];
            newInputs[index] = val;
            setVaultInputs(newInputs);
        };

        const attemptVaultUnlock = () => {
            if (activeLockoutSector) return; 

            let allCorrect = true;
            gameState.sectors.forEach((sec, idx) => {
                if (vaultInputs[idx] !== sec.accessCode) allCorrect = false;
            });

            if (allCorrect) {
                setFinalRevealed(true);
                setMissionEndTime(Date.now()); // Stop timer
                setVaultMessage("ACCESO CONCEDIDO");
                playBeep(1000, 'sine');
                // NOTIFY ADMIN
                if (adminConnRef.current) {
                    adminConnRef.current.send({ type: 'SQUAD_FINISHED', squadName: gameState.squadAnimal });
                }
            } else {
                setVaultMessage("ACCESO DENEGADO");
                playBeep(100, 'sawtooth');
                setTimeout(() => setVaultMessage("BLOQUEADO"), 2000);
            }
        };

        // MEMOIZED to prevent unnecessary re-renders in MissionIntro
        const beginGame = useCallback(() => {
            setMissionStartTime(Date.now());
            setGameState(prev => ({...prev, stage: 'squad-game'}));
        }, []);

        // --- VIEWS ---
        
        if (gameState.stage === 'selection') {
            return (
                <div className="min-h-screen flex items-center justify-center bg-cyber-black relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://cdn.pixabay.com/photo/2018/06/06/11/47/technology-3457279_1280.jpg')] opacity-10 bg-cover bg-center"></div>
                    <div className="z-10 text-center space-y-8 p-4 w-full max-w-6xl">
                        <h1 className="text-6xl md:text-8xl font-black text-cyber-green glitch-effect font-mono mb-12">
                            SCAPE ROOM
                        </h1>
                        <div className="flex flex-col md:flex-row gap-8 justify-center items-center">
                            
                            {/* ADMIN CARD */}
                            <button 
                              onClick={() => setGameState(prev => ({...prev, role: 'admin', stage: 'admin-setup'}))}
                              className="group relative w-72 h-96 border-2 border-cyber-green overflow-hidden hover:scale-105 transition-all duration-300 focus:outline-none"
                            >
                                <div className="absolute inset-0 bg-black/60 group-hover:bg-black/30 transition-colors z-10"></div>
                                <img 
                                    src="https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070&auto=format&fit=crop" 
                                    alt="Admin" 
                                    className="absolute inset-0 w-full h-full object-cover" 
                                />
                                <div className="absolute inset-0 z-20 flex flex-col items-center justify-center">
                                    <div className="bg-black/80 p-4 w-full text-center border-y border-cyber-green">
                                        <h2 className="text-3xl font-bold text-cyber-green font-mono">ADMINISTRADOR</h2>
                                        <p className="text-xs text-cyber-green mt-1">CONTROL DE MISI√ìN</p>
                                    </div>
                                </div>
                            </button>

                            {/* SQUAD CARD */}
                            <button 
                              onClick={() => setGameState(prev => ({...prev, role: 'squad', stage: 'squad-setup'}))}
                              className="group relative w-72 h-96 border-2 border-cyber-blue overflow-hidden hover:scale-105 transition-all duration-300 focus:outline-none"
                            >
                                <div className="absolute inset-0 bg-black/60 group-hover:bg-black/30 transition-colors z-10"></div>
                                <img 
                                    src="https://images.unsplash.com/photo-1515630278258-407f66498911?q=80&w=1998&auto=format&fit=crop" 
                                    alt="Squad" 
                                    className="absolute inset-0 w-full h-full object-cover" 
                                />
                                <div className="absolute inset-0 z-20 flex flex-col items-center justify-center">
                                    <div className="bg-black/80 p-4 w-full text-center border-y border-cyber-blue">
                                        <h2 className="text-3xl font-bold text-cyber-blue font-mono">ESCUADR√ìN</h2>
                                        <p className="text-xs text-cyber-blue mt-1">OPERATIVOS DE CAMPO</p>
                                    </div>
                                </div>
                            </button>

                        </div>
                    </div>
                </div>
            );
        }

        if (gameState.stage === 'admin-setup') {
            return (
                <div className="min-h-screen p-8 flex flex-col items-center justify-center font-mono">
                    <div className="w-full max-w-lg border border-cyber-green p-8 bg-black/80 shadow-[0_0_15px_rgba(0,255,65,0.2)]">
                        <h2 className="text-2xl text-cyber-green mb-6 border-b border-cyber-green pb-2">CONFIGURACI√ìN DE MISI√ìN</h2>
                        
                        <div className="mb-6">
                            <label className="block text-cyber-blue mb-2">PALABRA CLAVE FINAL</label>
                            <input 
                              type="password" 
                              className="w-full bg-black border border-cyber-green p-3 text-white focus:outline-none focus:shadow-[0_0_10px_#00ff41]"
                              placeholder="EJ: ATOMO"
                              value={keywordInput}
                              onChange={(e) => setKeywordInput(e.target.value)}
                            />
                        </div>

                        <div className="mb-6">
                            <label className="block text-cyber-blue mb-2">ARCHIVO DE DATOS (.CSV)</label>
                            <input 
                              type="file" 
                              accept=".csv"
                              onChange={(e) => setCsvFile(e.target.files ? e.target.files[0] : null)}
                              className="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:border-0 file:text-sm file:font-semibold file:bg-cyber-green file:text-black hover:file:bg-green-400"
                            />
                        </div>

                        {errorMsg && <p className="text-cyber-red mb-4 animate-pulse">{errorMsg}</p>}

                        <button 
                          onClick={startHosting}
                          className="w-full bg-cyber-green text-black font-bold py-3 hover:bg-white transition-colors"
                        >
                            INICIAR SERVIDOR
                        </button>
                    </div>
                </div>
            );
        }

        if (gameState.stage === 'admin-lobby') {
            return (
                <div className="min-h-screen p-8 font-mono bg-black text-cyber-green">
                    <div className="max-w-4xl mx-auto">
                      <header className="mb-8 border-b border-cyber-green pb-4 flex justify-between items-end">
                          <h1 className="text-4xl font-bold">SALA DE CONTROL</h1>
                          <div className="text-right">
                              <p className="text-cyber-blue text-sm">C√ìDIGO DE ENLACE</p>
                              <p className="text-4xl font-black bg-cyber-green/10 px-4 py-1 border border-cyber-green">{gameState.roomId}</p>
                          </div>
                      </header>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                          <div className="border border-cyber-green/50 p-4 min-h-[300px]">
                              <h3 className="text-cyber-blue mb-4 text-xl">ESCUADRONES CONECTADOS</h3>
                              <ul className="space-y-2">
                                  {gameState.connectedSquads.length === 0 && <li className="text-gray-500 italic">Esperando se√±al...</li>}
                                  {gameState.connectedSquads.map((sq, i) => (
                                      <li key={i} className="flex items-center gap-2 text-xl">
                                          <span className="w-2 h-2 bg-cyber-green animate-pulse rounded-full"></span>
                                          {sq}
                                      </li>
                                  ))}
                              </ul>
                          </div>
                          <div className="flex flex-col justify-center items-center p-8 border border-cyber-green/50 bg-cyber-green/5">
                              <p className="mb-4 text-center">Una vez todos los escuadrones est√©n en l√≠nea, inicia la secuencia.</p>
                              <button 
                                  onClick={handleStartMission}
                                  className="px-12 py-6 bg-cyber-green text-black font-bold text-2xl hover:scale-105 transition-transform shadow-[0_0_20px_rgba(0,255,65,0.5)]"
                              >
                                  INICIAR MISI√ìN
                              </button>
                          </div>
                      </div>
                    </div>
                </div>
            );
        }

        if (gameState.stage === 'admin-monitor') {
            // Filter active squads (connected but not finished)
            const activeSquads = gameState.connectedSquads.filter(s => !gameState.finishedSquads.some(f => f.name === s));
            
            return (
                <div className="min-h-screen p-8 font-mono bg-black text-white">
                    <div className="max-w-6xl mx-auto">
                        <header className="mb-12 border-b-2 border-cyber-green pb-6 flex justify-between items-center">
                            <h1 className="text-4xl md:text-5xl font-bold text-cyber-green glitch-effect">ESTADO DE MISI√ìN</h1>
                            <div className="animate-pulse">
                                <span className="inline-block w-4 h-4 rounded-full bg-cyber-red mr-2"></span>
                                <span className="text-cyber-red tracking-widest">EN VIVO</span>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                            {/* LEADERBOARD */}
                            <div className="bg-gray-900/50 border border-cyber-green/50 p-6 shadow-[0_0_20px_rgba(0,255,65,0.1)]">
                                <h2 className="text-2xl font-bold text-cyber-gold mb-6 border-b border-cyber-gold/30 pb-2 flex items-center">
                                    <span className="mr-3">üèÜ</span> TABLA DE CLASIFICACI√ìN
                                </h2>
                                
                                <div className="space-y-4">
                                    {gameState.finishedSquads.length === 0 ? (
                                        <p className="text-gray-500 italic text-center py-8">Esperando datos de finalizaci√≥n...</p>
                                    ) : (
                                        gameState.finishedSquads.map((squad, index) => {
                                            const isFirst = index === 0;
                                            return (
                                                <div key={squad.name} className={`flex items-center justify-between p-4 border ${isFirst ? 'border-cyber-gold bg-cyber-gold/10 scale-105' : 'border-cyber-green bg-cyber-green/5'} transition-all`}>
                                                    <div className="flex items-center gap-4">
                                                        <span className={`text-2xl font-black ${isFirst ? 'text-cyber-gold' : 'text-cyber-green'}`}>#{index + 1}</span>
                                                        <div className="flex flex-col">
                                                            <span className="text-xl font-bold">{squad.name}</span>
                                                            <span className={`text-sm ${isFirst ? 'text-cyber-gold' : 'text-cyber-green'} opacity-80`}>TIEMPO: {formatTime(squad.time)}</span>
                                                        </div>
                                                    </div>
                                                    {isFirst && <span className="text-xs text-cyber-gold animate-pulse">OPERACI√ìN COMPLETADA</span>}
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>

                            {/* ACTIVE SQUADS */}
                            <div className="border border-cyber-blue/30 p-6">
                                <h2 className="text-2xl font-bold text-cyber-blue mb-6 border-b border-cyber-blue/30 pb-2 flex items-center">
                                    <span className="mr-3">üì°</span> EN PROGRESO
                                </h2>
                                
                                <div className="space-y-2">
                                    {activeSquads.length === 0 && gameState.finishedSquads.length > 0 ? (
                                        <p className="text-cyber-green text-center py-4">¬°TODOS LOS ESCUADRONES HAN TERMINADO!</p>
                                    ) : activeSquads.length === 0 ? (
                                        <p className="text-gray-500 italic">Sin escuadrones activos.</p>
                                    ) : (
                                        activeSquads.map((squad) => (
                                            <div key={squad} className="flex items-center gap-3 text-gray-400 p-2 border-l-2 border-cyber-blue/50 pl-4">
                                                <span className="w-2 h-2 bg-cyber-blue animate-pulse rounded-full"></span>
                                                <span className="text-lg">{squad}</span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- NEW SQUAD STAGES ---

        // STEP 1: ENTER ROOM ID & CONNECT
        if (gameState.stage === 'squad-setup') {
            return (
                <div className="min-h-screen p-4 flex flex-col items-center justify-center font-mono bg-black">
                    <h2 className="text-3xl text-cyber-blue mb-8">ENLACE AL SISTEMA</h2>
                    
                    <div className="w-full max-w-md space-y-4">
                        <input 
                          type="text" 
                          placeholder="ID DE SALA (5 LETRAS)" 
                          maxLength={5}
                          value={joinRoomId}
                          onChange={(e) => setJoinRoomId(e.target.value.toUpperCase().trim())}
                          className="w-full bg-black border-2 border-cyber-blue p-4 text-center text-2xl text-white tracking-[0.5em] focus:outline-none focus:border-cyber-green disabled:opacity-50"
                          disabled={isConnecting}
                        />
                        {errorMsg && <p className="text-cyber-red text-center">{errorMsg}</p>}
                        <button 
                          onClick={connectToRoom}
                          disabled={isConnecting}
                          className={`w-full text-black font-bold py-4 text-xl transition-colors ${isConnecting ? 'bg-gray-500 cursor-wait' : 'bg-cyber-blue hover:bg-white'}`}
                        >
                            {isConnecting ? 'CONECTANDO...' : 'CONECTAR'}
                        </button>
                    </div>
                </div>
            );
        }

        // STEP 2: SELECT SQUAD (SYNCED)
        if (gameState.stage === 'squad-selection') {
             return (
                <div className="min-h-screen p-4 flex flex-col items-center justify-center font-mono bg-black">
                    <h2 className="text-3xl text-cyber-blue mb-8">SELECCIONA TU UNIDAD</h2>
                    <p className="text-gray-500 mb-6">Unidades en gris est√°n ocupadas.</p>
                    
                    {/* REGISTERING OVERLAY */}
                    {gameState.squadAnimal && (
                        <div className="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center backdrop-blur-sm">
                            <div className="text-6xl mb-6 animate-pulse">
                                {SQUADS.find(s => s.name === gameState.squadAnimal)?.icon}
                            </div>
                            <h3 className="text-2xl text-cyber-green font-bold animate-pulse">
                                REGISTRANDO {gameState.squadAnimal}...
                            </h3>
                            <p className="text-cyber-blue mt-2 text-sm tracking-widest">ESTABLECIENDO ENLACE CON COMANDO</p>
                        </div>
                    )}

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        {SQUADS.map((squad) => {
                            const isTaken = gameState.takenSquads.includes(squad.name);
                            // Disable interaction if already taken OR if we are currently registering one
                            const isDisabled = isTaken || gameState.squadAnimal !== null;
                            
                            return (
                                <button 
                                  key={squad.name}
                                  onClick={() => selectSquad(squad.name)}
                                  disabled={isDisabled}
                                  className={`p-4 border-2 flex flex-col items-center gap-2 transition-all 
                                      ${isTaken 
                                          ? 'border-gray-800 bg-gray-900 opacity-30 cursor-not-allowed grayscale' 
                                          : 'border-gray-700 hover:border-cyber-blue hover:scale-105 hover:shadow-[0_0_15px_#00f3ff]'
                                      }`}
                                >
                                    <span className="text-4xl">{squad.icon}</span>
                                    <span className={`font-bold ${isTaken ? 'text-gray-600' : 'text-gray-500'}`}>{squad.name}</span>
                                </button>
                            );
                        })}
                    </div>
                     {errorMsg && <p className="text-cyber-red text-center mb-4">{errorMsg}</p>}
                </div>
            );
        }

        if (gameState.stage === 'squad-lobby') {
            const currentSquad = SQUADS.find(s => s.name === gameState.squadAnimal);
      
            return (
                <div className="min-h-screen flex items-center justify-center font-mono bg-black p-4">
                    <div className="w-full max-w-lg border border-cyber-green/30 bg-cyber-green/5 p-8 text-center relative overflow-hidden">
                        {/* Decorative corner */}
                        <div className="absolute top-0 right-0 w-16 h-16 border-t-4 border-r-4 border-cyber-green/50"></div>
                        <div className="absolute bottom-0 left-0 w-16 h-16 border-b-4 border-l-4 border-cyber-green/50"></div>
                        
                        <div className="text-6xl mb-6 animate-bounce">
                            {currentSquad?.icon || '‚è≥'}
                        </div>
                        
                        <h2 className="text-3xl font-bold text-cyber-green mb-2 uppercase">
                            ESCUADR√ìN {gameState.squadAnimal}
                        </h2>
                        <div className="inline-block px-4 py-1 border border-cyber-green/50 text-cyber-green text-sm mb-6 bg-black">
                            REGISTRO CONFIRMADO
                        </div>

                        <div className="h-px w-full bg-cyber-green/30 my-6"></div>

                        <h3 className="text-xl text-cyber-blue animate-pulse mb-4">
                            ESPERANDO SE√ëAL DE INICIO...
                        </h3>
                        
                        <p className="text-gray-400 font-mono text-sm leading-relaxed">
                            NO CIERRES ESTA VENTANA.<br/>
                            EL ADMINISTRADOR ACTIVAR√Å EL PROTOCOLO EN BREVE.
                        </p>
                    </div>
                </div>
            );
        }

        if (gameState.stage === 'squad-intro') {
            return (
                <MissionIntro onStart={beginGame} />
            );
        }

        if (gameState.stage === 'squad-game') {
            const activeSector = gameState.sectors.find(s => s.id === activeSectorId);

            return (
                <div className="min-h-screen bg-black text-white font-mono p-4 md:p-8 flex flex-col md:flex-row gap-8 relative">
                    
                    {/* GLOBAL LOCKOUT OVERLAY */}
                    {activeLockoutSector && (
                         <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center backdrop-blur-sm pointer-events-auto cursor-not-allowed">
                             <div className="text-center animate-pulse">
                                <h2 className="text-cyber-red text-6xl md:text-8xl font-black glitch-effect mb-4">¬°SISTEMA BLOQUEADO!</h2>
                                <p className="text-white text-xl md:text-2xl mb-12 tracking-widest uppercase">
                                    INTRUSI√ìN DETECTADA EN {activeLockoutSector.name}
                                </p>
                                <div className="text-9xl font-mono text-cyber-red border-4 border-cyber-red rounded-full w-64 h-64 flex items-center justify-center mx-auto bg-black shadow-[0_0_50px_#ff003c]">
                                   {Math.max(0, Math.ceil((activeLockoutSector.lockoutEndTime - Date.now()) / 1000))}
                                </div>
                             </div>
                         </div>
                    )}

                    {/* Main Game Area: Sectors */}
                    <div className="flex-1">
                        <header className="mb-8 border-b border-cyber-green/30 pb-4 flex justify-between items-center">
                          <div>
                              <h1 className="text-3xl font-bold text-cyber-green glitch-effect">PANEL DE CONTROL</h1>
                              <p className="text-sm text-cyber-blue">ESCUADR√ìN: {gameState.squadAnimal}</p>
                          </div>
                          
                          {/* MISSION TIMER */}
                          <MissionTimer startTime={missionStartTime} endTime={missionEndTime} />
                        </header>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            {gameState.sectors.map((sector) => {
                                let statusClass = "border-cyber-blue/50 text-cyber-blue hover:bg-cyber-blue/10";
                                let statusText = "ACTIVO";
                                let statusIcon = "‚¶ø";

                                if (sector.isSolved) {
                                    statusClass = "border-cyber-green bg-cyber-green/20 text-cyber-green shadow-[0_0_15px_rgba(0,255,65,0.3)]";
                                    statusText = "RESUELTO";
                                    statusIcon = "‚úî";
                                } else if (sector.isLocked) {
                                    statusClass = "border-cyber-red bg-cyber-red/10 text-cyber-red opacity-80 cursor-not-allowed";
                                    statusText = "BLOQUEADO";
                                    statusIcon = "‚úñ";
                                }

                                return (
                                    <div 
                                      key={sector.id}
                                      onClick={() => handleSectorClick(sector.id)}
                                      className={`border-2 p-6 min-h-[160px] flex flex-col justify-between transition-all relative overflow-hidden group cursor-pointer ${statusClass}`}
                                    >
                                        <div className="flex justify-between items-start">
                                            <h3 className="text-2xl font-bold">{sector.name}</h3>
                                            <span className="text-xl">{statusIcon}</span>
                                        </div>
                                        
                                        <div className="mt-4">
                                            <p className="text-xs tracking-widest">{statusText}</p>
                                            {sector.isSolved && (
                                                <div className="mt-2 text-3xl font-black text-white bg-black inline-block px-2 border border-cyber-green">
                                                    {sector.accessCode}
                                                </div>
                                            )}
                                        </div>

                                        <div className="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-current opacity-50"></div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Sidebar: Master Vault */}
                    <div className="w-full md:w-80 border-l border-cyber-green/30 md:pl-8 pt-8 md:pt-0">
                        <div className="border-2 border-cyber-blue p-6 bg-cyber-blue/5 relative">
                            <h2 className="text-xl text-cyber-blue font-bold mb-6 flex items-center gap-2">
                                <span>üîí</span> B√ìVEDA MAESTRA
                            </h2>

                            {!finalRevealed ? (
                                <div className="space-y-4">
                                    <p className="text-xs text-gray-400 mb-4">INGRESA LOS C√ìDIGOS DE ACCESO</p>
                                    {gameState.sectors.map((sec, idx) => (
                                        <div key={idx} className="flex items-center justify-between">
                                            <label className="text-xs text-cyber-green w-16">SEC_0{idx+1}</label>
                                            <input 
                                              type="text" 
                                              maxLength={2}
                                              value={vaultInputs[idx]}
                                              onChange={(e) => handleVaultInput(idx, e.target.value)}
                                              className="w-16 bg-black border border-gray-700 text-center text-white py-1 focus:border-cyber-green focus:outline-none"
                                              disabled={!!activeLockoutSector}
                                            />
                                        </div>
                                    ))}
                                    
                                    <button 
                                      onClick={attemptVaultUnlock}
                                      className="w-full mt-6 bg-cyber-blue text-black font-bold py-3 hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                      disabled={!!activeLockoutSector}
                                    >
                                        DESBLOQUEAR
                                    </button>
                                    
                                    <p className="text-center text-xs text-cyber-red mt-2 h-4">{vaultMessage === 'BLOQUEADO' ? '' : vaultMessage}</p>
                                </div>
                            ) : (
                                <div className="text-center py-8 animate-pulse">
                                    <h3 className="text-cyber-green mb-2">CLAVE FINAL:</h3>
                                    <div className="bg-cyber-green text-black text-4xl font-black py-4 px-2 break-all border-4 border-white shadow-[0_0_30px_#00ff41]">
                                        {gameState.adminKeyword}
                                    </div>
                                    <p className="mt-4 text-white text-sm">¬°GRITA LA CLAVE!</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {activeSector && (
                        <SectorModal 
                          sector={activeSector}
                          isOpen={!!activeSector}
                          onSectorSolved={handleSectorSolved}
                          onSectorLocked={handleSectorLocked}
                        />
                    )}

                </div>
            );
        }

        return null;
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
