<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scape Room - Protocolo Hydra v5.7</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    
    <script src="./js/react.js"></script>
    <script src="./js/react-dom.js"></script>
    <script src="./js/babel.js"></script>
    <script src="./js/peerjs.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --c-black: #020202;
            --c-green: #00ff41;
            --c-green-glow: rgba(0, 255, 65, 0.4);
            --c-blue: #00f3ff;
            --c-blue-glow: rgba(0, 243, 255, 0.4);
            --c-red: #ff003c;
            --c-gold: #ffd700;
            --font-main: 'Share Tech Mono', 'Courier New', monospace;
        }

        * { box-sizing: border-box; }
        body { 
            background-color: var(--c-black); 
            color: var(--c-green); 
            font-family: var(--font-main); 
            margin: 0; padding: 0;
            overflow: hidden; height: 100vh;
        }

        /* --- BACKGROUND & FX --- */
        .bg-layer { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%); }
        .circuit-bg {
            position: fixed; inset: 0; z-index: -1; opacity: 0.05; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'%3E%3Cpath d='M0 100h100v100h100v100h100v100M100 0v100h100v100h100v100h100' fill='none' stroke='%2300ff41' stroke-width='1'/%3E%3C/svg%3E");
            animation: moveBg 120s linear infinite;
        }
        @keyframes moveBg { from { background-position: 0 0; } to { background-position: 400px 400px; } }
        .crt-scan {
            position: fixed; inset: 0; z-index: 1001; pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 3px, 3px 100%;
        }

        /* --- UI COMPONENTS --- */
        .cyber-border {
            position: relative; border: 1px solid var(--c-green);
            background: rgba(0, 0, 0, 0.9); box-shadow: 0 0 20px var(--c-green-glow);
            padding: 2rem; border-radius: 4px;
        }
        .cyber-border::before {
            content: attr(data-label); position: absolute; top: -10px; left: 15px;
            font-size: 10px; background: var(--c-black); padding: 0 8px; color: var(--c-green); letter-spacing: 2px;
        }

        .title-huge {
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 900; color: var(--c-green);
            text-shadow: 0 0 15px var(--c-green);
            text-transform: uppercase; margin-bottom: 2rem; text-align: center;
        }

        .btn-cyber {
            background: var(--c-blue); color: #000;
            padding: 1rem 1.5rem; font-family: var(--font-main); font-weight: 900;
            text-transform: uppercase; border: none; cursor: pointer;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: 0.2s; font-size: 1rem;
        }
        .btn-cyber:hover:not(:disabled) { transform: scale(1.03); background: #fff; box-shadow: 0 0 25px var(--c-blue); }
        .btn-cyber:disabled { background: #333; color: #666; cursor: not-allowed; opacity: 0.5; }

        .btn-outline { background: transparent; border: 1px solid var(--c-blue); color: var(--c-blue); box-shadow: none; }
        .btn-outline:hover { background: rgba(0, 243, 255, 0.1); color: var(--c-blue); }

        .input-cyber {
            width: 100%; background: #000; border: 2px solid var(--c-blue);
            padding: 1rem; color: #fff; font-family: var(--font-main); font-size: 1.5rem;
            text-align: center; outline: none; margin-bottom: 1rem;
        }

        /* --- AUDIO PLAYER (ADMIN ONLY) --- */
        .audio-player-admin {
            position: fixed; top: 1rem; right: 1rem; z-index: 5000;
            background: rgba(0,0,0,0.95); border: 1px solid var(--c-blue);
            padding: 8px 15px; border-radius: 4px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 0 15px var(--c-blue-glow);
        }
        .audio-ctrl-btn {
            background: none; border: none; color: var(--c-blue); 
            cursor: pointer; font-size: 1.4rem; font-family: var(--font-main);
            transition: 0.2s; padding: 0 5px;
        }
        .audio-ctrl-btn:hover { color: #fff; text-shadow: 0 0 10px var(--c-blue); transform: scale(1.1); }
        .volume-slider { cursor: pointer; accent-color: var(--c-blue); width: 80px; }

        /* --- SQUAD SELECTION MATRIX 6x5 --- */
        .squad-grid-6x5 {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 0.5rem; padding: 1rem;
            max-width: 850px; margin: 0 auto;
        }
        .squad-card {
            background: rgba(0,0,0,0.8); border: 1px solid rgba(0, 255, 65, 0.2);
            padding: 0.5rem; cursor: pointer; text-align: center; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 85px; position: relative;
        }
        .squad-card:hover:not(:disabled) { border-color: var(--c-blue); transform: translateY(-3px); background: rgba(0, 243, 255, 0.05); }
        .squad-card.selected { border-color: var(--c-blue); box-shadow: 0 0 15px var(--c-blue); background: rgba(0, 243, 255, 0.1); }
        .squad-card:disabled { 
            opacity: 0.1; 
            cursor: not-allowed !important; 
            filter: grayscale(1) brightness(0.3); 
            border-color: #111;
            background: #050505;
        }
        .squad-card:disabled::after {
            content: "BLOCKED"; position: absolute; bottom: 5px; font-size: 7px; color: var(--c-red); letter-spacing: 1px;
        }
        .squad-icon { font-size: 2rem; display: block; }
        .squad-name { font-size: 0.55rem; font-weight: bold; letter-spacing: 1px; color: var(--c-green); text-transform: uppercase; margin-top: 4px; }

        /* --- GAME LAYOUT --- */
        .game-layout { display: flex; height: 100vh; width: 100vw; }
        .main-panel { flex: 1; display: flex; flex-direction: column; padding: 1.5rem; gap: 1rem; overflow-y: auto; }
        .vault-panel { width: 340px; border-left: 1px solid var(--c-blue); background: #000; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }

        .sector-vertical-list { display: flex; flex-direction: column; gap: 1rem; }
        .sector-row {
            background: #050505; border: 1px solid var(--c-blue); padding: 1.25rem;
            cursor: pointer; display: flex; align-items: center; justify-content: space-between;
            transition: 0.3s;
        }
        .sector-row.solved { border-color: var(--c-green); background: rgba(0, 255, 65, 0.1); cursor: default; }
        .sector-label { font-weight: 900; font-size: 1.2rem; color: var(--c-blue); }
        .sector-status { font-size: 0.7rem; color: #666; letter-spacing: 2px; margin-top: 4px; }
        .sector-code { font-size: 2.5rem; font-weight: 900; color: var(--c-gold); text-shadow: 0 0 10px var(--gold); }

        /* --- DETAILED QUESTION MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.95);
            display: flex; align-items: center; justify-content: center; padding: 2rem;
            backdrop-filter: blur(8px);
        }
        .detailed-modal {
            width: 100%; max-width: 750px; background: #050505; border: 1px solid var(--c-blue);
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.2); border-radius: 4px; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .modal-header-bar {
            background: var(--c-blue); color: #000; padding: 0.5rem 1rem; display: flex;
            justify-content: space-between; font-weight: 900; font-size: 0.75rem; letter-spacing: 2px;
        }
        .modal-body { padding: 2rem; position: relative; }
        .question-text { font-size: 1.3rem; line-height: 1.5; color: #fff; margin-bottom: 2rem; border-left: 4px solid var(--c-blue); padding-left: 1.5rem; }
        
        /* SINGLE COLUMN ANSWERS */
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
        
        .option-btn {
            background: rgba(0, 243, 255, 0.03); border: 1px solid rgba(0, 243, 255, 0.2);
            padding: 1.1rem 1.5rem; text-align: left; color: var(--c-blue); font-family: var(--font-main);
            font-size: 0.95rem; cursor: pointer; transition: 0.2s; position: relative;
            overflow: hidden;
            text-transform: none; /* NO forced uppercase */
        }
        .option-btn:hover:not(:disabled) { background: rgba(0, 243, 255, 0.1); border-color: var(--c-blue); color: #fff; }
        .option-btn.correct { background: var(--c-green); color: #000; border-color: var(--c-green); font-weight: 900; }
        .option-btn.wrong { background: var(--c-red); color: #fff; border-color: var(--c-red); }
        
        .modal-footer-stats {
            margin-top: 1.5rem; padding: 1rem; border-top: 1px solid #1a1a1a;
            display: flex; justify-content: space-between; font-size: 0.7rem; color: #444;
        }

        /* --- VAULT --- */
        .vault-input {
            background: #111; border: 1px solid var(--c-blue); color: var(--c-blue);
            width: 100%; height: 60px; font-size: 2rem; text-align: center; font-weight: 900;
        }

        .screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
        .pulse { animation: pulseAnim 2s infinite; }
        @keyframes pulseAnim { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .rules-modal-content {
            max-width: 600px; width: 100%;
        }
    </style>

<script type="importmap">
{
  "imports": {
    "react": "./js/react.js",
    "react/": "./js/react.js"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div class="bg-layer"></div>
    <div class="circuit-bg"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SQUADS = [
            { name: 'Cobra', icon: 'üêç' }, { name: 'Tigre', icon: 'üêÖ' }, { name: 'Halc√≥n', icon: 'ü¶Ö' }, 
            { name: 'Lobo', icon: 'üê∫' }, { name: 'Tibur√≥n', icon: 'ü¶à' }, { name: '√Åguila', icon: 'ü¶Ö' },
            { name: 'Pantera', icon: 'üêÜ' }, { name: 'Oso', icon: 'üêª' }, { name: 'Le√≥n', icon: 'ü¶Å' }, 
            { name: 'Drag√≥n', icon: 'üêâ' }, { name: 'F√©nix', icon: 'üê¶‚Äçüî•' }, { name: 'Toro', icon: 'üêÇ' },
            { name: 'Zorro', icon: 'ü¶ä' }, { name: 'B√∫ho', icon: 'ü¶â' }, { name: 'Ara√±a', icon: 'üï∑Ô∏è' },
            { name: 'Escorpi√≥n', icon: 'ü¶Ç' }, { name: 'Cuervo', icon: 'üê¶‚Äç‚¨õ' }, { name: 'Pulpo', icon: 'üêô' },
            { name: 'Elefante', icon: 'üêò' }, { name: 'Caballo', icon: 'üêé' }, { name: 'Rinoceronte', icon: 'ü¶è' },
            { name: 'Gorila', icon: 'ü¶ç' }, { name: 'Murci√©lago', icon: 'ü¶á' }, { name: 'Cisne', icon: 'ü¶¢' },
            { name: 'Ping√ºino', icon: 'üêß' }, { name: 'Medusa', icon: 'ü™º' }, { name: 'Cangrejo', icon: 'ü¶Ä' },
            { name: 'Tortuga', icon: 'üê¢' }, { name: 'Camale√≥n', icon: 'ü¶é' }, { name: 'Venado', icon: 'ü¶å' }
        ];

        const TRACKS = {
            LOBBY: ["./audio/cyber.mp3", "./audio/music.mp3"],
            GAME: ["./audio/track1.mp3", "./audio/track2.mp3", "./audio/track3.mp3", "./audio/track4.mp3", "./audio/track5.mp3"],
            WIN: ["./audio/ganador01.mp3", "./audio/ganador02.mp3", "./audio/background.mp3"]
        };

        const EXAMPLE_CSV = `Tipo;Pregunta;R1;R2;R3;R4;Tiempo;Correcta;URL Imagen
quiz;¬øPara qu√© se utiliza com√∫nmente la IA en gesti√≥n de redes?;Generar IP;Optimizar tr√°fico;Instalar conectores;Fabricar cables;45;2;
quiz;¬øQu√© describe la automatizaci√≥n de sistemas en el hogar?;IoT Industrial;Dom√≥tica;Ciberseguridad;Rob√≥tica;45;2;
quiz;¬øQu√© banda WiFi tiene mayor alcance?;2.4 GHz;900 MHz;6 GHz;5 GHz;45;1;
quiz;¬øQu√© banda WiFi es m√°s r√°pida y menos congestionada?;900 MHz;5 GHz;10 GHz;2.4 GHz;45;2;
quiz;¬øCu√°l es el beneficio principal del PLC?;Eliminar router;Usar cable el√©ctrico existente;Conexi√≥n segura;M√°xima velocidad;45;2;
quiz;¬øEn qu√© capa TCP/IP opera HTTP?;Transporte;Acceso a Red;Internet;Aplicaci√≥n;45;4;
quiz;¬øQu√© caracter√≠stica permite redirigir tr√°fico en WiFi Mesh?;Autoreparaci√≥n;WPA3;Roaming fluido;Conmutaci√≥n;45;1;
quiz;¬øQu√© es clave en una red WiFi Mesh?;Servidor de impresi√≥n;Cable UTP;Un punto central;Roaming autom√°tico;45;4;
quiz;¬øQu√© NO es ventaja de redes cableadas?;Menor latencia;Mayor seguridad;Libertad de movimiento;Mayor fiabilidad;45;3;
quiz;¬øQu√© categor√≠a de cable UTP soporta 1 Gbps?;Cat 5e;Cat 7;Cat 3;Cat 6;45;1;
quiz;¬øQu√© hardware necesita un PC para comunicarse en red?;Router;CPU;Fuente;Adaptador de red;45;4;
quiz;¬øQu√© t√©rmino describe dispositivos f√≠sicos conectados a Internet?;IoT;Big Data;Fog Computing;LAN;45;1;
quiz;¬øQu√© conector se usa para UTP en Ethernet?;USB-C;HDMI;RJ11;RJ45;45;4;
quiz;¬øUno de los desaf√≠os del Deep Learning y Big Data es?;Coste de fibra;Incompatibilidad Bluetooth;Problemas de privacidad;Velocidad baja PLC;45;3;
quiz;¬øDiferencia entre switch y hub?;Hub es inal√°mbrico;Hub es m√°s r√°pido;Switch dirige a destino;Switch tiene un puerto;45;3;
quiz;¬øQu√© dispositivo retransmite datos a todos los puertos?;Hub;Router;Punto de acceso;Switch;45;1;
quiz;¬øQu√© dispositivo traduce entre redes con protocolos diferentes?;Gateway;Repetidor;Puente;Switch;45;1;
quiz;¬øQu√© dispositivo amplifica se√±al WiFi?;Puente;Servidor impresi√≥n;Repetidor WiFi;Switch;45;3;
quiz;¬øQu√© dispositivo interconecta equipos en una LAN?;Puente;Repetidor;Router;Switch;45;4;
quiz;¬øQu√© dispositivo conecta segmentos de red en una l√≥gica?;Router;Repetidor;Hub;Bridge;45;4;`;

        const formatTime = (ms) => {
            const totalSec = Math.floor(ms / 1000);
            const min = Math.floor(totalSec / 60);
            const sec = totalSec % 60;
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        };

        const downloadCSV = () => {
            const blob = new Blob([EXAMPLE_CSV], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "plantilla_mision_escape.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const useAudioManager = (stage, role, hasFinished) => {
            const audioRef = useRef(new Audio());
            const [volume, setVolume] = useState(0.4);
            const [muted, setMuted] = useState(false);
            const [trackIdx, setTrackIdx] = useState(0);
            const playlist = hasFinished ? TRACKS.WIN : (stage === 'admin-monitor' ? TRACKS.GAME : TRACKS.LOBBY);

            useEffect(() => { audioRef.current.volume = muted ? 0 : volume; }, [volume, muted]);
            useEffect(() => {
                if (role !== 'admin') return;
                const track = playlist[trackIdx % playlist.length];
                audioRef.current.src = track;
                audioRef.current.loop = true;
                audioRef.current.play().catch(() => {});
            }, [trackIdx, playlist, role]);

            return { volume, setVolume, muted, setMuted, next: () => setTrackIdx(i => i + 1), prev: () => setTrackIdx(i => i > 0 ? i - 1 : playlist.length - 1) };
        };

        function App() {
            const [gameState, setGameState] = useState({ 
                stage: 'selection', role: null, roomId: '', connectedSquads: [], 
                finishedSquads: [], takenSquads: [], sectors: [], 
                squadAnimal: null, isSquadSelecting: false, finalRank: 0, finalTime: 0,
                squadProgress: {} // { 'Cobra': [1,3], 'Tigre': [2] }
            });
            const stateRef = useRef(gameState);
            useEffect(() => { stateRef.current = gameState; }, [gameState]);

            const [vaultCodes, setVaultCodes] = useState(['','','','','']);
            const [lockout, setLockout] = useState(0);
            const [activeSectorId, setActiveSectorId] = useState(null);
            const [showRules, setShowRules] = useState(false);
            
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const adminConns = useRef([]);
            const startTimeRef = useRef(null);

            const { volume, setVolume, muted, setMuted, next, prev } = useAudioManager(gameState.stage, gameState.role, gameState.finishedSquads.length > 0);

            useEffect(() => { if (lockout > 0) { const t = setInterval(() => setLockout(l => l-1), 1000); return () => clearInterval(t); } }, [lockout]);

            const reset = () => { 
                if(peerRef.current) peerRef.current.destroy(); 
                setGameState({ 
                    stage: 'selection', role: null, roomId: '', connectedSquads: [], 
                    finishedSquads: [], takenSquads: [], sectors: [], 
                    squadAnimal: null, isSquadSelecting: false, finalRank: 0, finalTime: 0,
                    squadProgress: {}
                }); 
                setVaultCodes(['','','','','']); 
            };

            const startAdmin = (fileOrText, isExample = false) => {
                const initPeer = (questions) => {
                    const id = Math.floor(10000 + Math.random() * 90000).toString();
                    const peer = new Peer(`sr-host-${id}`);
                    peer.on('open', () => setGameState(s => ({...s, role: 'admin', stage: 'admin-lobby', roomId: id, rawQuestions: questions})));
                    peer.on('connection', c => {
                        c.on('open', () => { adminConns.current.push(c); c.send({type:'SYNC', taken: stateRef.current.connectedSquads}); });
                        c.on('data', d => {
                            if(d.type==='REQ') {
                                setGameState(prevS => {
                                    if(prevS.connectedSquads.includes(d.name)) { c.send({type:'NO'}); return prevS; }
                                    c.send({type:'OK'});
                                    const nextS = [...prevS.connectedSquads, d.name];
                                    adminConns.current.forEach(ac => { if (ac.open) ac.send({type:'SYNC', taken: nextS}); });
                                    return {...prevS, connectedSquads: nextS};
                                });
                            }
                            if(d.type==='FIN') {
                                const time = Date.now() - startTimeRef.current;
                                setGameState(prevS => {
                                    const nextFin = [...prevS.finishedSquads, {name:d.name, time}];
                                    c.send({type:'WIN_DATA', rank: nextFin.length, time});
                                    return {...prevS, finishedSquads: nextFin};
                                });
                            }
                            if(d.type==='SECTOR_UPDATE') {
                                setGameState(prevS => {
                                    const current = prevS.squadProgress[d.name] || [];
                                    if(current.includes(d.sectorId)) return prevS;
                                    return {
                                        ...prevS,
                                        squadProgress: {
                                            ...prevS.squadProgress,
                                            [d.name]: [...current, d.sectorId]
                                        }
                                    };
                                });
                            }
                        });
                    });
                    peerRef.current = peer;
                };
                if (isExample) initPeer(processCSV(EXAMPLE_CSV));
                else if (fileOrText) { const r = new FileReader(); r.onload = (e) => initPeer(processCSV(e.target.result)); r.readAsText(fileOrText); }
            };

            const joinRoom = (rid) => {
                if(!rid) return;
                const peer = new Peer();
                peer.on('open', () => {
                    const c = peer.connect(`sr-host-${rid}`);
                    c.on('open', () => { connRef.current = c; setGameState(s => ({...s, role: 'squad'})); });
                    c.on('data', d => {
                        if(d.type==='SYNC') setGameState(s => ({...s, takenSquads: d.taken, stage: s.stage === 'selection' ? 'squad-selection' : s.stage}));
                        if(d.type==='OK') setGameState(s => ({...s, stage: 'squad-lobby'}));
                        if(d.type==='NO') { alert("Avatar no disponible"); setGameState(s => ({...s, isSquadSelecting: false})); }
                        if(d.type==='GO') setGameState(s => ({...s, stage: 'squad-intro', sectors: d.sectors}));
                        if(d.type==='WIN_DATA') setGameState(s => ({...s, stage: 'squad-win', finalRank: d.rank, finalTime: d.time}));
                        if(d.type==='RESET') reset();
                    });
                });
                peerRef.current = peer;
            };

            const processCSV = (text) => {
                const lines = text.trim().split('\n');
                return lines.slice(1).map((l, i) => {
                    const p = l.split(';').map(x => x.trim().replace(/^"|"$/g, ''));
                    return { id: i, question: p[1], options: [p[2],p[3],p[4],p[5]], correctIndex: (parseInt(p[7])||1)-1 };
                }).filter(q => q.question);
            };

            const handleTerminate = () => { adminConns.current.forEach(c => { if(c.open) c.send({type:'RESET'}); }); reset(); setGameState(s => ({...s, stage: 'admin-setup', role: 'admin'})); };

            return (
                <div>
                    {gameState.role === 'admin' && (
                        <div className="audio-player-admin">
                            <button className="audio-ctrl-btn" onClick={prev}>&lt;&lt;</button>
                            <button className="audio-ctrl-btn" onClick={() => setMuted(!muted)}>{muted ? 'üîá' : 'üîä'}</button>
                            <button className="audio-ctrl-btn" onClick={next}>&gt;&gt;</button>
                            <input type="range" min="0" max="1" step="0.01" value={volume} onChange={(e)=>setVolume(parseFloat(e.target.value))} className="volume-slider" />
                        </div>
                    )}

                    {showRules && (
                        <div className="modal-overlay" onClick={() => setShowRules(false)}>
                            <div className="cyber-border rules-modal-content" data-label="PROTOCOL_V5.7" onClick={e=>e.stopPropagation()}>
                                <h2 className="title-huge" style={{fontSize: '2rem'}}>MANUAL DE OPERACIONES</h2>
                                <div style={{lineHeight: '1.6', fontSize: '0.9rem', color: '#fff'}}>
                                    <p><strong>1. ACCESO:</strong> Un administrador crea el ID. Agentes usan matriz 6x5 para identificarse.</p>
                                    <p><strong>2. SECTORES:</strong> Resuelve los desaf√≠os de hackeo para obtener el c√≥digo de acceso.</p>
                                    <p><strong>3. B√ìVEDA:</strong> Introduce los c√≥digos en el panel derecho en el orden secuencial (S1 a S5).</p>
                                    <p><strong>4. BLOQUEO:</strong> Cada fallo en la b√≥veda o hackeo congela el terminal 10 segundos.</p>
                                    <p><strong>5. FIN DE MISI√ìN:</strong> Det√©n el n√∫cleo antes que los dem√°s agentes para liderar el ranking.</p>
                                </div>
                                <button className="btn-cyber w-full" style={{marginTop: '2rem'}} onClick={() => setShowRules(false)}>ENTENDIDO</button>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'selection' && (
                        <div className="screen">
                            <h1 className="title-huge">SCAPE ROOM</h1>
                            <div className="cyber-border" data-label="USER_LOGIN" style={{maxWidth: '400px', width: '100%'}}>
                                <input id="rid" type="text" placeholder="ID MISI√ìN" maxLength={5} className="input-cyber" />
                                <button onClick={() => joinRoom(document.getElementById('rid').value)} className="btn-cyber w-full mb-4">INGRESAR AL SISTEMA</button>
                                <div className="flex-row" style={{display:'flex', gap:'10px'}}>
                                    <button onClick={() => setShowRules(true)} className="btn-cyber btn-outline flex-1">NORMAS</button>
                                    <button onClick={() => setGameState(s => ({...s, stage: 'admin-setup'}))} className="btn-cyber btn-outline flex-1">MODO ADMIN</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'admin-setup' && (
                        <div className="screen">
                            <div className="cyber-border flex-col" data-label="SCENARIO_LOADER" style={{maxWidth: '450px', width: '100%'}}>
                                <h2 className="text-center mb-4">PROTOCOLO DE CARGA</h2>
                                <input id="csvIn" type="file" accept=".csv" className="mb-4 w-full" />
                                <button onClick={() => startAdmin(document.getElementById('csvIn').files[0])} className="btn-cyber w-full mb-2">LANZAR MISI√ìN</button>
                                <button onClick={() => startAdmin(null, true)} className="btn-cyber btn-outline w-full mb-2">CARGAR EJEMPLO</button>
                                <button onClick={downloadCSV} className="btn-cyber btn-outline w-full mb-4" style={{borderColor:'var(--c-gold)', color:'var(--c-gold)', fontSize:'0.75rem'}}>DESCARGAR PLANTILLA CSV</button>
                                <button onClick={reset} style={{background:'none', border:'none', color:'#444', cursor:'pointer', width: '100%'}}>CERRAR</button>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'admin-lobby' && (
                        <div className="screen">
                            <p className="pulse">ID DE SE√ëAL ACTIVA:</p>
                            <div style={{fontSize: '5rem', fontWeight: 900, border: '4px solid var(--c-green)', padding: '0.5rem 3rem', background: '#000', margin: '1rem 0'}}>{gameState.roomId}</div>
                            <button onClick={() => {
                                startTimeRef.current = Date.now();
                                adminConns.current.forEach(c => {
                                    const shuffled = [...gameState.rawQuestions].sort(()=>Math.random()-.5);
                                    const sectors = [1,2,3,4,5].map(i => ({ id: i, questions: shuffled.slice((i-1)*4, i*4), accessCode: Math.floor(Math.random()*90+10).toString(), isSolved: false }));
                                    c.send({type:'GO', sectors});
                                });
                                setGameState(s => ({...s, stage: 'admin-monitor'}));
                            }} disabled={gameState.connectedSquads.length === 0} className="btn-cyber">INICIAR PROTOCOLO</button>
                            <div style={{marginTop: '2rem', fontSize: '0.8rem', opacity: 0.5}}>EQUIPOS: {gameState.connectedSquads.length}</div>
                        </div>
                    )}

                    {gameState.stage === 'squad-selection' && (
                        <div className="screen">
                            <h2 className="mb-4">IDENTIFICACI√ìN DE AGENTE</h2>
                            <div className="cyber-border w-full" data-label="AVAILABILITY_MATRIX_6X5" style={{maxWidth: '1000px'}}>
                                <div className="squad-grid-6x5">
                                    {SQUADS.map(s => {
                                        const taken = gameState.takenSquads.includes(s.name);
                                        const selected = gameState.squadAnimal === s.name;
                                        return (
                                            <button key={s.name} disabled={taken || gameState.isSquadSelecting} onClick={() => {
                                                setGameState(p => ({...p, isSquadSelecting: true, squadAnimal: s.name}));
                                                connRef.current.send({type:'REQ', name: s.name});
                                            }} className={`squad-card ${selected ? 'selected' : ''}`}>
                                                <span className="squad-icon">{s.icon}</span>
                                                <span className="squad-name">{s.name}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'squad-lobby' && (
                        <div className="screen">
                            <div style={{fontSize: '6rem'}} className="pulse">üì°</div>
                            <h2 style={{letterSpacing: '5px'}}>ENLACE ESTABLECIDO</h2>
                            <p style={{opacity: 0.5}}>Esperando orden central...</p>
                        </div>
                    )}

                    {gameState.stage === 'squad-intro' && (
                        <div className="screen">
                            <div className="cyber-border" data-label="SYSTEM_BOOT" style={{maxWidth: '500px', width: '100%'}}>
                                <p style={{fontSize: '1.2rem', lineHeight: '2', whiteSpace: 'pre-wrap'}}>{`> GENTE_${gameState.squadAnimal?.toUpperCase()}\n> OBJETIVO: B√ìVEDA HYDRA\n> ESTADO: LISTO`}</p>
                                <button onClick={() => setGameState(s => ({...s, stage: 'squad-game'}))} className="btn-cyber w-full" style={{marginTop: '2rem'}}>INICIAR HACKEO</button>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'squad-game' && (
                        <div className="game-layout">
                            {lockout > 0 && (
                                <div className="modal-overlay" style={{background: 'rgba(100,0,0,0.95)', flexDirection: 'column'}}>
                                    <div className="cyber-border" data-label="SECURITY_PROTOCOL_ALERT" style={{padding: '3rem', maxWidth: '600px', width: '90%', textAlign: 'center', borderColor: 'white', borderStyle: 'double'}}>
                                        <h2 className="pulse" style={{color: 'var(--c-red)', fontSize: '2rem', marginBottom: '1.5rem'}}>SISTEMA BLOQUEADO</h2>
                                        <p style={{color: '#fff', fontSize: '1.1rem', lineHeight: '1.6', marginBottom: '2rem', fontWeight: 'bold'}}>
                                            EL SISTEMA HA SIDO BLOQUEADO COMO MEDIDA DE SEGURIDAD AL DETECTARSE UNA INTRUSI√ìN.
                                        </p>
                                        <div style={{fontSize: '6rem', fontWeight: 900, color: '#fff', textShadow: '0 0 20px var(--c-red)'}}>{lockout}</div>
                                        <div style={{fontSize: '0.7rem', color: 'var(--c-red)', marginTop: '1.5rem', letterSpacing: '2px'}}>REINICIANDO PROTOCOLO DE DEFENSA...</div>
                                    </div>
                                </div>
                            )}
                            <div className="main-panel">
                                <div className="cyber-border" data-label="HUD_V5.7" style={{padding: '1.5rem'}}>
                                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
                                        <div style={{fontWeight: 900, color: 'var(--c-green)', fontSize: '1.8rem'}}>GENTE_{gameState.squadAnimal?.toUpperCase()}</div>
                                        <button onClick={() => setShowRules(true)} className="btn-cyber btn-outline" style={{padding:'0.5rem 1rem', fontSize:'0.7rem'}}>VER NORMAS</button>
                                    </div>
                                    <div className="instruction-panel">
                                        <strong>PROTOCOLO HYDRA:</strong><br/>
                                        1. Hackea los 5 sectores para obtener los c√≥digos.<br/>
                                        2. Introduce los 5 c√≥digos en la b√≥veda derecha en el orden secuencial.<br/>
                                        3. Solo tienes un intento por carga en la b√≥veda final.
                                    </div>
                                </div>
                                <div className="sector-vertical-list">
                                    {gameState.sectors.map(s => (
                                        <div key={s.id} onClick={() => !s.isSolved && setActiveSectorId(s.id)} className={`sector-row ${s.isSolved ? 'solved' : ''}`}>
                                            <div><div className="sector-label">SECTOR_0{s.id}</div><div className="sector-status">{s.isSolved ? 'ACCESO_CONCEDIDO' : 'ACCESO_DENEGADO'}</div></div>
                                            <div className="sector-code">{s.isSolved ? s.accessCode : '??'}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="vault-panel">
                                <h3 className="text-center" style={{fontSize: '1rem', letterSpacing: '4px'}}>B√ìVEDA_FINAL</h3>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '8px'}}>{vaultCodes.map((v, i) => <input key={i} maxLength={2} value={v} onChange={e=>{ const n=[...vaultCodes]; n[i]=e.target.value; setVaultCodes(n); }} className="vault-input" />)}</div>
                                <button onClick={() => { if(gameState.sectors.every((s,i) => vaultCodes[i] === s.accessCode)) { connRef.current.send({type:'FIN', name: gameState.squadAnimal}); } else { setLockout(10); } }} className="btn-cyber w-full" style={{marginTop: 'auto', height: '100px'}}>DETENER N√öCLEO</button>
                            </div>
                            {activeSectorId && <SectorModal sector={gameState.sectors.find(s => s.id === activeSectorId)} onSolved={(id) => { setGameState(s => ({...s, sectors: s.sectors.map(x => x.id===id ? {...x, isSolved:true} : x)})); setActiveSectorId(null); connRef.current.send({type:'SECTOR_UPDATE', name: gameState.squadAnimal, sectorId: id}); }} onLock={() => { setLockout(10); setActiveSectorId(null); }} />}
                        </div>
                    )}

                    {gameState.stage === 'squad-win' && (
                        <div className="screen">
                            <h2 className="title-huge">MISION COMPLETADA</h2>
                            <div className="cyber-border" data-label="DATA_LOG" style={{padding:'3rem', textAlign:'center'}}>
                                <p style={{color:'var(--c-gold)', fontSize:'1.5rem'}}>#RANKING: {gameState.finalRank}</p>
                                <p style={{fontSize:'3rem', margin:'1rem 0'}}>{formatTime(gameState.finalTime)}</p>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'admin-monitor' && (
                        <div className="screen" style={{padding: '2rem'}}>
                            <div style={{width:'100%', display:'flex', justifyContent:'space-between', marginBottom:'2rem'}}><h1>CENTRO_MONITOREO</h1><button onClick={handleTerminate} className="btn-cyber" style={{background:'var(--c-red)', color:'#fff'}}>TERMINAR GLOBAL</button></div>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'2rem', width:'100%', flex:1}}>
                                <div className="cyber-border" data-label="TERMINAL_WINS">{gameState.finishedSquads.map((s,i) => (<div key={i} style={{display:'flex', justifyContent:'space-between', padding:'15px', borderBottom:'1px solid #333'}}><span>#{i+1} GENTE_{s.name.toUpperCase()}</span><span style={{color:'var(--c-gold)'}}>{formatTime(s.time)}</span></div>))}</div>
                                <div className="cyber-border" data-label="LIVE_PROGRESS">
                                    <div style={{display:'grid', gridTemplateColumns:'1fr', gap:'10px'}}>
                                        {gameState.connectedSquads.filter(s => !gameState.finishedSquads.find(f=>f.name===s)).map(s => {
                                            const prog = gameState.squadProgress[s] || [];
                                            return (
                                                <div key={s} style={{padding:'10px', border:'1px solid var(--c-blue)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                                    <span style={{fontWeight:'bold'}}>{s}</span>
                                                    <div style={{display:'flex', gap:'5px'}}>
                                                        {[1,2,3,4,5].map(id => (
                                                            <div key={id} style={{
                                                                width:'20px', height:'20px',
                                                                background: prog.includes(id) ? 'var(--c-green)' : '#111',
                                                                border: '1px solid ' + (prog.includes(id) ? 'var(--c-green)' : '#333'),
                                                                display:'flex', alignItems:'center', justifyContent:'center', fontSize:'10px', color:'#000'
                                                            }}>
                                                                {prog.includes(id) ? '‚úì' : id}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {gameState.connectedSquads.filter(s => !gameState.finishedSquads.find(f=>f.name===s)).length === 0 && <p style={{opacity:0.5, textAlign:'center'}}>NO HAY AGENTES ACTIVOS</p>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const SectorModal = ({ sector, onSolved, onLock }) => {
            const [idx, setIdx] = useState(0);
            const [sel, setSel] = useState(null);
            const q = sector.questions[idx];

            const check = (i) => {
                if(sel !== null) return;
                setSel(i);
                setTimeout(() => {
                    if(i === q.correctIndex) {
                        if(idx+1 < sector.questions.length) { setIdx(idx+1); setSel(null); }
                        else onSolved(sector.id);
                    } else onLock();
                }, 800);
            };

            return (
                <div className="modal-overlay">
                    <div className="detailed-modal">
                        <div className="modal-header-bar">
                            <span>TERMINAL_BREACH_SECTOR_0{sector.id}</span>
                            <span className="pulse">ESTADO: HACKEANDO...</span>
                        </div>
                        <div className="modal-body">
                            <div style={{position: 'absolute', right: '2rem', top: '1.5rem', color: 'var(--c-blue)', fontSize: '0.6rem', opacity: 0.4}}>
                                {Array(sector.questions.length).fill(0).map((_, i) => <span key={i} style={{marginLeft: '4px'}}>{i < idx ? '‚ñ£' : (i === idx ? '‚ñ∂' : '‚ñ°')}</span>)}
                            </div>
                            <div className="question-text">{q.question}</div>
                            <div className="options-grid">
                                {q.options.map((op, i) => (
                                    <button 
                                        key={i} 
                                        onClick={() => check(i)} 
                                        disabled={sel !== null} 
                                        className={`option-btn ${sel === i ? (i === q.correctIndex ? 'correct' : 'wrong') : ''}`}
                                    >
                                        <span style={{opacity: 0.3, marginRight: '10px'}}>{String.fromCharCode(65 + i)}//</span>
                                        {op}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="modal-footer-stats">
                            <span>SISTEMA: HYDRA_V5.7</span>
                            <span>CAPA_RESEGURIDAD_{idx+1}/{sector.questions.length}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>