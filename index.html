<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scape Room - Protocolo Hydra v5.7 [MULTIPLAYER]</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    
    <script src="./js/react.js"></script>
    <script src="./js/react-dom.js"></script>
    <script src="./js/babel.js"></script>
    <script src="./js/peerjs.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --c-black: #020202;
            --c-green: #00ff41;
            --c-green-glow: rgba(0, 255, 65, 0.4);
            --c-blue: #00f3ff;
            --c-blue-glow: rgba(0, 243, 255, 0.4);
            --c-red: #ff003c;
            --c-gold: #ffd700;
            --font-main: 'Share Tech Mono', 'Courier New', monospace;
        }

        * { box-sizing: border-box; }
        body { 
            background-color: var(--c-black); 
            color: var(--c-green); 
            font-family: var(--font-main); 
            margin: 0; padding: 0;
            overflow: hidden; height: 100vh;
        }

        /* --- BACKGROUND & FX --- */
        .bg-layer { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%); }
        .circuit-bg {
            position: fixed; inset: 0; z-index: -1; opacity: 0.05; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'%3E%3Cpath d='M0 100h100v100h100v100h100v100M100 0v100h100v100h100v100h100' fill='none' stroke='%2300ff41' stroke-width='1'/%3E%3C/svg%3E");
            animation: moveBg 120s linear infinite;
        }
        @keyframes moveBg { from { background-position: 0 0; } to { background-position: 400px 400px; } }

        /* --- UI COMPONENTS --- */
        .cyber-border {
            position: relative; border: 1px solid var(--c-green);
            background: rgba(0, 0, 0, 0.9); box-shadow: 0 0 20px var(--c-green-glow);
            padding: 2rem; border-radius: 4px;
        }
        .cyber-border::before {
            content: attr(data-label); position: absolute; top: -10px; left: 15px;
            font-size: 10px; background: var(--c-black); padding: 0 8px; color: var(--c-green); letter-spacing: 2px;
        }

        .title-huge {
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 900; color: var(--c-green);
            text-shadow: 0 0 15px var(--c-green);
            text-transform: uppercase; margin-bottom: 2rem; text-align: center;
        }

        .btn-cyber {
            background: var(--c-blue); color: #000;
            padding: 1rem 1.5rem; font-family: var(--font-main); font-weight: 900;
            text-transform: uppercase; border: none; cursor: pointer;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: 0.2s; font-size: 1rem;
        }
        .btn-cyber:hover:not(:disabled) { transform: scale(1.03); background: #fff; box-shadow: 0 0 25px var(--c-blue); }
        .btn-cyber:disabled { background: #333; color: #666; cursor: not-allowed; opacity: 0.5; }

        .btn-outline { background: transparent; border: 1px solid var(--c-blue); color: var(--c-blue); box-shadow: none; }
        .btn-outline:hover { background: rgba(0, 243, 255, 0.1); color: var(--c-blue); }

        .btn-subtle {
            background: transparent; border: 1px solid #333; color: #666; 
            padding: 0.5rem 1rem; font-size: 0.8rem; cursor: pointer; transition: 0.2s;
            font-family: var(--font-main); text-transform: uppercase;
        }
        .btn-subtle:hover { border-color: var(--c-blue); color: var(--c-blue); }

        .input-cyber {
            width: 100%; background: #000; border: 2px solid var(--c-blue);
            padding: 1rem; color: #fff; font-family: var(--font-main); font-size: 1.5rem;
            text-align: center; outline: none; margin-bottom: 1rem;
        }
        .input-cyber::placeholder { color: rgba(0, 243, 255, 0.3); }

        /* --- AUDIO PLAYER (ADMIN ONLY) --- */
        .audio-player-admin {
            position: fixed; top: 1rem; right: 1rem; z-index: 5000;
            background: rgba(0,0,0,0.95); border: 1px solid var(--c-blue);
            padding: 8px 15px; border-radius: 4px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 0 15px var(--c-blue-glow);
        }
        .audio-ctrl-btn {
            background: none; border: none; color: var(--c-blue); 
            cursor: pointer; font-size: 1.4rem; font-family: var(--font-main);
            transition: 0.2s; padding: 0 5px;
        }
        .audio-ctrl-btn:hover { color: #fff; text-shadow: 0 0 10px var(--c-blue); transform: scale(1.1); }
        .volume-slider { cursor: pointer; accent-color: var(--c-blue); width: 80px; }

        /* --- SQUAD SELECTION MATRIX --- */
        .squad-grid-scroll {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem; padding: 1rem;
            max-height: 200px; overflow-y: auto;
            border: 1px solid #333; background: rgba(0,0,0,0.5);
            margin-bottom: 1rem;
        }
        .squad-card {
            background: rgba(0,0,0,0.8); border: 1px solid rgba(0, 255, 65, 0.2);
            padding: 0.5rem; cursor: pointer; text-align: center; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 70px; position: relative;
        }
        .squad-card:hover:not(:disabled) { border-color: var(--c-blue); transform: translateY(-3px); background: rgba(0, 243, 255, 0.05); }
        .squad-card.selected { border-color: var(--c-blue); box-shadow: 0 0 15px var(--c-blue); background: rgba(0, 243, 255, 0.1); }
        .squad-card:disabled { 
            opacity: 0.1; cursor: not-allowed !important; filter: grayscale(1) brightness(0.3); border-color: #111; background: #050505;
        }
        .squad-icon { font-size: 1.5rem; display: block; }
        .squad-name { font-size: 0.55rem; font-weight: bold; letter-spacing: 1px; color: var(--c-green); text-transform: uppercase; margin-top: 4px; }

        /* --- SELECTION GRIDS (ADMIN) --- */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Default 3 cols for 9 items */
            gap: 1rem;
            max-height: 450px;
            overflow-y: auto;
            padding-right: 5px;
        }
        /* Special grid for 15 items - 3 cols x 5 rows */
        .selection-grid.large {
            grid-template-columns: repeat(3, 1fr); 
        }
        @media (min-width: 800px) {
            .selection-grid.large { grid-template-columns: repeat(5, 1fr); }
        }

        .btn-select-grid {
            padding: 0.5rem;
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--c-blue);
            color: #fff;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            min-height: 80px;
            text-transform: uppercase;
            word-break: break-word;
        }
        .btn-select-grid:hover:not(.btn-empty) {
            background: rgba(0, 243, 255, 0.15);
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }
        .btn-empty {
            background: transparent;
            border: 1px dashed #333;
            color: #333;
            cursor: default;
            box-shadow: none;
            pointer-events: none;
        }

        /* --- BIG AVATAR DISPLAY --- */
        .big-avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            animation: pulseAnim 3s infinite;
        }
        .big-avatar-icon {
            font-size: 6rem;
            filter: drop-shadow(0 0 20px var(--c-green));
            margin-bottom: 1rem;
        }
        .big-avatar-name {
            font-size: 2rem;
            color: var(--c-green);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        .big-avatar-sub {
            font-size: 1rem;
            color: var(--c-blue);
            text-transform: uppercase;
        }

        /* --- GAME LAYOUT --- */
        .game-layout { display: flex; height: 100vh; width: 100vw; }
        .main-panel { flex: 1; display: flex; flex-direction: column; padding: 1.5rem; gap: 1rem; overflow-y: auto; }
        .vault-panel { width: 340px; border-left: 1px solid var(--c-blue); background: #000; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }

        .sector-vertical-list { display: flex; flex-direction: column; gap: 1rem; }
        .sector-row {
            background: #050505; border: 1px solid var(--c-blue); padding: 1.25rem;
            cursor: pointer; display: flex; align-items: center; justify-content: space-between;
            transition: 0.3s;
        }
        .sector-row.solved { border-color: var(--c-green); background: rgba(0, 255, 65, 0.1); cursor: default; }
        .sector-label { font-weight: 900; font-size: 1.2rem; color: var(--c-blue); }
        .sector-status { font-size: 0.7rem; color: #666; letter-spacing: 2px; margin-top: 4px; }
        .sector-code { font-size: 2.5rem; font-weight: 900; color: var(--c-gold); text-shadow: 0 0 10px var(--gold); }

        /* --- DETAILED QUESTION MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.95);
            display: flex; align-items: center; justify-content: center; padding: 2rem;
            backdrop-filter: blur(8px);
        }
        .detailed-modal {
            width: 100%; max-width: 750px; background: #050505; border: 1px solid var(--c-blue);
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.2); border-radius: 4px; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .modal-header-bar {
            background: var(--c-blue); color: #000; padding: 0.5rem 1rem; display: flex;
            justify-content: space-between; font-weight: 900; font-size: 0.75rem; letter-spacing: 2px;
        }
        .modal-body { padding: 2rem; position: relative; }
        .question-text { font-size: 1.3rem; line-height: 1.5; color: #fff; margin-bottom: 2rem; border-left: 4px solid var(--c-blue); padding-left: 1.5rem; }
        
        /* SINGLE COLUMN ANSWERS */
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
        
        .option-btn {
            background: rgba(0, 243, 255, 0.03); border: 1px solid rgba(0, 243, 255, 0.2);
            padding: 1.1rem 1.5rem; text-align: left; color: var(--c-blue); font-family: var(--font-main);
            font-size: 0.95rem; cursor: pointer; transition: 0.2s; position: relative;
            overflow: hidden;
            text-transform: none; /* NO forced uppercase */
        }
        .option-btn:hover:not(:disabled) { background: rgba(0, 243, 255, 0.1); border-color: var(--c-blue); color: #fff; }
        .option-btn.correct { background: var(--c-green); color: #000; border-color: var(--c-green); font-weight: 900; }
        .option-btn.wrong { background: var(--c-red); color: #fff; border-color: var(--c-red); }
        
        .modal-footer-stats {
            margin-top: 1.5rem; padding: 1rem; border-top: 1px solid #1a1a1a;
            display: flex; justify-content: space-between; font-size: 0.7rem; color: #444;
        }

        /* --- VAULT --- */
        .vault-input {
            background: #111; border: 1px solid var(--c-blue); color: var(--c-blue);
            width: 100%; height: 60px; font-size: 2rem; text-align: center; font-weight: 900;
        }

        .screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
        .pulse { animation: pulseAnim 2s infinite; }
        @keyframes pulseAnim { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .rules-modal-content {
            max-width: 600px; width: 100%;
        }

        /* Discreete Admin Bar */
        .discreet-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 1rem; display: flex; justify-content: center; gap: 1rem;
            opacity: 0.6; transition: 0.3s;
        }
        .discreet-bar:hover { opacity: 1; }
    </style>

<script type="importmap">
{
  "imports": {
    "react": "./js/react.js",
    "react/": "./js/react.js"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div class="bg-layer"></div>
    <div class="circuit-bg"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SQUADS = [
            { name: 'Cobra', icon: 'üêç' }, { name: 'Tigre', icon: 'üêÖ' }, { name: 'Halc√≥n', icon: 'ü¶Ö' }, 
            { name: 'Lobo', icon: 'üê∫' }, { name: 'Tibur√≥n', icon: 'ü¶à' }, { name: '√Åguila', icon: 'ü¶Ö' },
            { name: 'Pantera', icon: 'üêÜ' }, { name: 'Oso', icon: 'üêª' }, { name: 'Le√≥n', icon: 'ü¶Å' }, 
            { name: 'Drag√≥n', icon: 'üêâ' }, { name: 'F√©nix', icon: 'üê¶‚Äçüî•' }, { name: 'Toro', icon: 'üêÇ' },
            { name: 'Zorro', icon: 'ü¶ä' }, { name: 'B√∫ho', icon: 'ü¶â' }, { name: 'Ara√±a', icon: 'üï∑Ô∏è' },
            { name: 'Escorpi√≥n', icon: 'ü¶Ç' }, { name: 'Cuervo', icon: 'üê¶‚Äç‚¨õ' }, { name: 'Pulpo', icon: 'üêô' },
            { name: 'Elefante', icon: 'üêò' }, { name: 'Caballo', icon: 'üêé' }, { name: 'Rinoceronte', icon: 'ü¶è' },
            { name: 'Gorila', icon: 'ü¶ç' }, { name: 'Murci√©lago', icon: 'ü¶á' }, { name: 'Cisne', icon: 'ü¶¢' },
            { name: 'Ping√ºino', icon: 'üêß' }, { name: 'Medusa', icon: 'ü™º' }, { name: 'Cangrejo', icon: 'ü¶Ä' },
            { name: 'Tortuga', icon: 'üê¢' }, { name: 'Camale√≥n', icon: 'ü¶é' }, { name: 'Venado', icon: 'ü¶å' }
        ];

        const TRACKS = {
            LOBBY: ["./audio/cyber.mp3", "./audio/music.mp3"],
            GAME: ["./audio/track1.mp3", "./audio/track2.mp3", "./audio/track3.mp3", "./audio/track4.mp3", "./audio/track5.mp3"],
            WIN: ["./audio/ganador01.mp3", "./audio/ganador02.mp3", "./audio/background.mp3"]
        };

        const EXAMPLE_CSV = `Tipo;Pregunta;R1;R2;R3;R4;Tiempo;Correcta;URL Imagen
quiz;¬øQu√© requiere la uni√≥n con cola?;Presi√≥n constante;Nada especial;Calor intenso;Tiempo de secado;30;4;
quiz;¬øQu√© herramienta traza c√≠rculos o arcos?;Escuadra;Comp√°s;Metro;Regla;30;2;
quiz;¬øQu√© herramienta se usa para el acabado final?;Lija;Lima;Escofina;Martillo;30;1;
quiz;¬øCu√°l es un ejemplo de madera dura?;Roble;Cedro;Pino;Abeto;30;1;
quiz;¬øDe qu√© parte del √°rbol se obtiene principalmente?;Hojas;Tronco;Ra√≠ces;Corteza;30;2;
quiz;¬øC√≥mo se garantiza que sea renovable?;Gesti√≥n adecuada;Compr√°ndola cara;Dej√°ndola intacta;Us√°ndola poco;30;1;
quiz;¬øCu√°l es el orden correcto de trabajo?;Medir, construir, dise√±ar;Construir, medir, dise√±ar;Construir, dise√±ar, medir;Dise√±ar, medir, construir;30;4;
quiz;¬øQu√© herramienta hace cortes curvos y finos?;Lima;Serrucho;Serrucho de costilla;Segueta;30;4;
quiz;¬øCu√°l es el primer paso en el trabajo?;Medir;Cortar;Unir;Dise√±ar;30;4;
quiz;¬øQu√© herramienta da mayor precisi√≥n en piezas peque√±as?;Comp√°s;Escuadra;Metro;Regla;30;4;
quiz;¬øQu√© relaciona la densidad?;Dureza y textura;Masa y volumen;Peso y tama√±o;Color y olor;30;2;
quiz;¬øC√≥mo se fabrica el aglomerado?;Chapas finas pegadas;Madera maciza cortada;Fibras molidas;Virutas prensadas con cola;30;4;
quiz;¬øQu√© hace que sea un recurso renovable?;Es artificial;No se gasta nunca;Reforestaci√≥n;Se recicla f√°cil;30;3;
quiz;¬øPor qu√© se usan maderas procesadas?;M√°s duras siempre;M√°s bonitas;M√°s pesadas;Econ√≥micas y ecol√≥gicas;30;4;
quiz;¬øQu√© maderas suelen ser m√°s densas?;Las oscuras;Las j√≥venes;Las claras;Las verdes;30;1;
quiz;¬øQu√© herramienta hace cortes precisos con refuerzo?;Segueta;Serrucho de costilla;Lima;Serrucho com√∫n;30;2;
quiz;¬øQu√© caracteriza a las maderas tropicales?;Climas c√°lidos, humedad;Crecimiento r√°pido, con√≠feras;Crecimiento lento, hoja caduca;Livianas, econ√≥micas;30;1;
quiz;¬øQu√© t√©cnica de uni√≥n es r√°pida y sencilla?;Clavos y martillo;Ensamblaje complejo;Cola;Tornillos;30;1;
quiz;¬øQu√© es el contrachapado?;Fibras molidas;Madera maciza;Virutas prensadas;Chapas finas pegadas;30;4;
quiz;¬øQu√© herramienta elimina mucha madera r√°pidamente?;Martillo;Lima;Escofina;Lija;30;3;`;

        const formatTime = (ms) => {
            const totalSec = Math.floor(ms / 1000);
            const min = Math.floor(totalSec / 60);
            const sec = totalSec % 60;
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        };

        const downloadCSV = () => {
            const blob = new Blob([EXAMPLE_CSV], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "plantilla_mision_escape.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const useAudioManager = (stage, role, hasFinished) => {
            const audioRef = useRef(new Audio());
            const [volume, setVolume] = useState(0.4);
            const [muted, setMuted] = useState(false);
            const [trackIdx, setTrackIdx] = useState(0);
            const playlist = hasFinished ? TRACKS.WIN : (stage === 'admin-monitor' ? TRACKS.GAME : TRACKS.LOBBY);

            useEffect(() => { audioRef.current.volume = muted ? 0 : volume; }, [volume, muted]);
            useEffect(() => {
                if (role !== 'admin') return;
                const track = playlist[trackIdx % playlist.length];
                audioRef.current.src = track;
                audioRef.current.loop = true;
                audioRef.current.play().catch(() => {});
            }, [trackIdx, playlist, role]);

            return { volume, setVolume, muted, setMuted, next: () => setTrackIdx(i => i + 1), prev: () => setTrackIdx(i => i > 0 ? i - 1 : playlist.length - 1) };
        };

        function App() {
            const [gameState, setGameState] = useState({ 
                stage: 'selection', role: null, roomId: '', 
                // connectedSquads now holds Player Nicknames (strings)
                connectedSquads: [], 
                finishedSquads: [], 
                takenSquads: [], // Unused in new logic but kept for safety
                sectors: [], 
                squadAnimal: null, // Selected Animal (ID)
                squadNick: '', // Unqiue ID
                isSquadSelecting: false, finalRank: 0, finalTime: 0,
                squadProgress: {}, // Map Nickname -> Progress
                // Admin Setup Vars
                rawQuestions: [],
                allSubjects: [],
                allTopics: [],
                filteredQuestions: [],
                selectedSubject: '',
                selectedTopic: '',
                playerAvatars: {} // Map Nickname -> AnimalName
            });
            const stateRef = useRef(gameState);
            useEffect(() => { stateRef.current = gameState; }, [gameState]);

            const [vaultCodes, setVaultCodes] = useState(['','','','','']);
            const [lockout, setLockout] = useState(0);
            const [activeSectorId, setActiveSectorId] = useState(null);
            const [showRules, setShowRules] = useState(false);
            // Temp state for pre-connection selection
            const [tempSquad, setTempSquad] = useState(null);
            const [tempNick, setTempNick] = useState('');
            const [tempRoomId, setTempRoomId] = useState('');
            
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const adminConns = useRef([]);
            const startTimeRef = useRef(null);

            const { volume, setVolume, muted, setMuted, next, prev } = useAudioManager(gameState.stage, gameState.role, gameState.finishedSquads.length > 0);

            useEffect(() => { if (lockout > 0) { const t = setInterval(() => setLockout(l => l-1), 1000); return () => clearInterval(t); } }, [lockout]);

            const reset = () => { 
                if(peerRef.current) peerRef.current.destroy(); 
                setGameState({ 
                    stage: 'selection', role: null, roomId: '', connectedSquads: [], 
                    finishedSquads: [], takenSquads: [], sectors: [], 
                    squadAnimal: null, squadNick: '', isSquadSelecting: false, finalRank: 0, finalTime: 0,
                    squadProgress: {}, rawQuestions: [], allSubjects: [], allTopics: [], filteredQuestions: [],
                    selectedSubject: '', selectedTopic: '', playerAvatars: {}
                }); 
                setVaultCodes(['','','','','']); 
                setTempSquad(null);
                setTempNick('');
                setTempRoomId('');
            };

            const processCSV = (text) => {
                const lines = text.trim().split('\n');
                if (lines.length < 2) return [];

                // Detect format
                const header = lines[0].toLowerCase();
                const isShortFormat = header.startsWith('tipo');

                return lines.slice(1).map((l, i) => {
                    const trimmed = l.trim();
                    if (!trimmed || trimmed.startsWith('#')) return null;
                    
                    const p = l.split(';').map(x => x.trim().replace(/^"|"$/g, ''));
                    
                    let subject, topic, question, options, correctIndex;

                    if (isShortFormat) {
                        // MAPPING FOR SHORT FORMAT: Tipo;Pregunta;R1;R2;R3;R4;Tiempo;Correcta;URL
                        if (p.length < 8) return null;
                        subject = 'General';
                        topic = 'Misi√≥n';
                        question = p[1];
                        options = [p[2], p[3], p[4], p[5]];
                        correctIndex = (parseInt(p[7])||1)-1; 
                    } else {
                        // MAPPING FOR FULL FORMAT: Category;Topic;Type;Question;R1...
                        if (p.length < 10) return null; 
                        subject = p[0] || 'General';
                        topic = p[1] || 'General';
                        question = p[3];
                        options = [p[4],p[5],p[6],p[7]];
                        correctIndex = (parseInt(p[9])||1)-1; 
                    }

                    return { 
                        id: i, 
                        question: question, 
                        options: options, 
                        correctIndex: correctIndex,
                        category: subject,
                        topic: topic
                    };
                }).filter(q => q && q.question);
            };

            const handleFileLoad = (fileOrText, isExample) => {
                let questions = [];
                const finishLoad = (qList) => {
                    if(!qList || qList.length === 0) { alert('No se encontraron preguntas v√°lidas'); return; }
                    const subjects = [...new Set(qList.map(q => q.category))];
                    
                    if (subjects.length > 1) {
                         setGameState(s => ({...s, role: 'admin', stage: 'admin-select-subject', rawQuestions: qList, allSubjects: subjects}));
                    } else {
                         selectSubject(qList, subjects[0]);
                    }
                };

                if (isExample) {
                    finishLoad(processCSV(EXAMPLE_CSV));
                } else if (fileOrText) {
                    const r = new FileReader(); 
                    r.onload = (e) => finishLoad(processCSV(e.target.result)); 
                    r.readAsText(fileOrText);
                }
            };

            const selectSubject = (allQs, subject) => {
                const bySubj = allQs.filter(q => q.category === subject);
                const topics = [...new Set(bySubj.map(q => q.topic))];
                setGameState(s => ({...s, selectedSubject: subject}));

                if(topics.length > 1) {
                    setGameState(s => ({...s, role: 'admin', stage: 'admin-select-topic', rawQuestions: allQs, filteredQuestions: bySubj, allTopics: topics}));
                } else {
                    // Only one topic or none, use the subject list directly
                    setGameState(s => ({...s, selectedTopic: topics[0] || 'General'}));
                    initAdminPeer(bySubj); 
                }
            };

            const selectTopic = (topic) => {
                const final = gameState.filteredQuestions.filter(q => q.topic === topic);
                setGameState(s => ({...s, selectedTopic: topic}));
                initAdminPeer(final);
            };

            const initAdminPeer = (finalQuestions) => {
                const id = Math.floor(10000 + Math.random() * 90000).toString();
                const peer = new Peer(`sr-host-${id}`);
                peer.on('open', () => setGameState(s => ({...s, role: 'admin', stage: 'admin-lobby', roomId: id, filteredQuestions: finalQuestions})));
                peer.on('connection', c => {
                    // We don't send SYNC immediately anymore, we wait for REQ
                    c.on('data', d => {
                        if(d.type==='REQ') {
                            setGameState(prevS => {
                                // Check if Nickname is already taken
                                if(prevS.connectedSquads.includes(d.nick)) { 
                                    c.send({type:'NO'}); 
                                    return prevS; 
                                }
                                c.send({type:'OK'});
                                const nextS = [...prevS.connectedSquads, d.nick];
                                // Map Nick -> Avatar
                                const nextAvatars = { ...prevS.playerAvatars, [d.nick]: d.avatar };
                                return {...prevS, connectedSquads: nextS, playerAvatars: nextAvatars};
                            });
                        }
                        if(d.type==='FIN') {
                            const time = Date.now() - startTimeRef.current;
                            setGameState(prevS => {
                                // d.name here is the Nickname
                                const nextFin = [...prevS.finishedSquads, {name:d.name, time}];
                                c.send({type:'WIN_DATA', rank: nextFin.length, time});
                                return {...prevS, finishedSquads: nextFin};
                            });
                        }
                        if(d.type==='SECTOR_UPDATE') {
                            setGameState(prevS => {
                                // d.name is the Nickname
                                const current = prevS.squadProgress[d.name] || [];
                                if(current.includes(d.sectorId)) return prevS;
                                return { ...prevS, squadProgress: { ...prevS.squadProgress, [d.name]: [...current, d.sectorId] } };
                            });
                        }
                    });
                    c.on('open', () => adminConns.current.push(c));
                });
                peerRef.current = peer;
            };

            const joinRoom = (rid, selectedSquadName, selectedNick) => {
                if(!rid || !selectedSquadName || !selectedNick) {
                    alert("Por favor completa todos los campos (Nombre, Avatar y C√≥digo).");
                    return;
                }
                const peer = new Peer();
                peer.on('open', () => {
                    const c = peer.connect(`sr-host-${rid}`);
                    c.on('open', () => { 
                        connRef.current = c; 
                        // Request entry with Nickname and Avatar
                        c.send({type:'REQ', name: selectedSquadName, nick: selectedNick, avatar: selectedSquadName});
                    });
                    c.on('data', d => {
                        if(d.type==='OK') {
                            setGameState(s => ({...s, role: 'squad', squadAnimal: selectedSquadName, squadNick: selectedNick, stage: 'squad-lobby'}));
                        }
                        if(d.type==='NO') { 
                            alert(`El nombre "${selectedNick}" ya est√° en uso en esta misi√≥n. Elige otro.`); 
                            c.close();
                        }
                        if(d.type==='GO') setGameState(s => ({...s, stage: 'squad-intro', sectors: d.sectors}));
                        if(d.type==='WIN_DATA') setGameState(s => ({...s, stage: 'squad-win', finalRank: d.rank, finalTime: d.time}));
                        if(d.type==='RESET') reset();
                    });
                    
                    setTimeout(() => {
                        if(!c.open) alert("No se pudo conectar con la misi√≥n. Verifica el ID.");
                    }, 3000);
                });
                peerRef.current = peer;
            };

            const handleTerminate = () => { adminConns.current.forEach(c => { if(c.open) c.send({type:'RESET'}); }); reset(); setGameState(s => ({...s, stage: 'admin-setup', role: 'admin'})); };

            // LOGIC TO GET EXACTLY 20 QUESTIONS
            const getGameQuestions = (pool) => {
                let selected = [];
                if (pool.length >= 20) {
                    selected = [...pool].sort(() => Math.random() - 0.5).slice(0, 20);
                } else {
                    selected = [...pool];
                    while (selected.length < 20) {
                        const randomQ = pool[Math.floor(Math.random() * pool.length)];
                        selected.push({...randomQ}); 
                    }
                    selected.sort(() => Math.random() - 0.5);
                }
                return selected;
            };

            const getSquadIcon = (name) => SQUADS.find(s => s.name === name)?.icon || '‚ùì';

            return (
                <div>
                    {gameState.role === 'admin' && (
                        <div className="audio-player-admin">
                            <button className="audio-ctrl-btn" onClick={prev}>&lt;&lt;</button>
                            <button className="audio-ctrl-btn" onClick={() => setMuted(!muted)}>{muted ? 'üîá' : 'üîä'}</button>
                            <button className="audio-ctrl-btn" onClick={next}>&gt;&gt;</button>
                            <input type="range" min="0" max="1" step="0.01" value={volume} onChange={(e)=>setVolume(parseFloat(e.target.value))} className="volume-slider" />
                        </div>
                    )}

                    {showRules && (
                        <div className="modal-overlay" onClick={() => setShowRules(false)}>
                            <div className="cyber-border rules-modal-content" data-label="PROTOCOL_V5.7" onClick={e=>e.stopPropagation()}>
                                <h2 className="title-huge" style={{fontSize: '2rem'}}>MANUAL DE OPERACIONES</h2>
                                <div style={{lineHeight: '1.6', fontSize: '0.9rem', color: '#fff'}}>
                                    <p><strong>1. ACCESO:</strong> Un administrador crea el ID. Agentes usan matriz 6x5 para identificarse.</p>
                                    <p><strong>2. SECTORES:</strong> Resuelve los desaf√≠os de hackeo para obtener el c√≥digo de acceso.</p>
                                    <p><strong>3. B√ìVEDA:</strong> Introduce los c√≥digos en el panel derecho en el orden secuencial (S1 a S5).</p>
                                    <p><strong>4. BLOQUEO:</strong> Cada fallo en la b√≥veda o hackeo congela el terminal 10 segundos.</p>
                                    <p><strong>5. FIN DE MISI√ìN:</strong> Det√©n el n√∫cleo antes que los dem√°s agentes para liderar el ranking.</p>
                                </div>
                                <button className="btn-cyber w-full" style={{marginTop: '2rem'}} onClick={() => setShowRules(false)}>ENTENDIDO</button>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'selection' && (
                        <div className="screen">
                            <h1 className="title-huge" style={{marginBottom:'0.5rem'}}>SCAPE ROOM</h1>
                            <div className="cyber-border" data-label="PLAYER_LOGIN" style={{maxWidth: '500px', width: '100%', padding:'2rem', position:'relative', zIndex:10}}>
                                
                                <div style={{marginBottom:'1rem'}}>
                                    <label style={{display:'block', marginBottom:'5px', color:'var(--c-blue)', fontSize:'0.8rem'}}>1. NOMBRE AGENTE</label>
                                    <input value={tempNick} onChange={e=>setTempNick(e.target.value.toUpperCase())} type="text" placeholder="AGENTE_01" maxLength={20} className="input-cyber" style={{margin:0}} />
                                </div>

                                <div style={{marginBottom:'1.5rem'}}>
                                    <label style={{display:'block', marginBottom:'5px', color:'var(--c-blue)', fontSize:'0.8rem'}}>2. SELECCIONAR AVATAR</label>
                                    <div className="squad-grid-scroll">
                                        {SQUADS.map(s => (
                                            <div key={s.name} 
                                                 onClick={() => setTempSquad(s.name)} 
                                                 className={`squad-card ${tempSquad === s.name ? 'selected' : ''}`}>
                                                <span className="squad-icon">{s.icon}</span>
                                                <span className="squad-name">{s.name}</span>
                                            </div>
                                        ))}
                                    </div>
                                    {tempSquad && <div style={{textAlign:'center', color:'var(--c-green)', fontWeight:'bold'}}>AVATAR: {tempSquad} SELECCIONADO</div>}
                                </div>

                                <div style={{marginBottom:'1.5rem'}}>
                                    <label style={{display:'block', marginBottom:'5px', color:'var(--c-blue)', fontSize:'0.8rem'}}>3. C√ìDIGO MISI√ìN</label>
                                    <input value={tempRoomId} onChange={e=>setTempRoomId(e.target.value)} type="text" placeholder="#####" maxLength={5} className="input-cyber" style={{margin:0}} />
                                </div>

                                <button onClick={() => joinRoom(tempRoomId, tempSquad, tempNick)} className="btn-cyber w-full">CONECTAR SISTEMA</button>
                            </div>

                            {/* HIDDEN FILE INPUT FOR ADMIN */}
                            <input id="csvIn" type="file" accept=".csv" style={{display:'none'}} onChange={(e) => handleFileLoad(e.target.files[0])} />

                            <div className="discreet-bar">
                                <button onClick={() => document.getElementById('csvIn').click()} className="btn-subtle">CREAR MISI√ìN</button>
                                <button onClick={() => handleFileLoad(null, true)} className="btn-subtle">CARGAR EJEMPLO</button>
                                <button onClick={downloadCSV} className="btn-subtle">PLANTILLA</button>
                                <button onClick={() => setShowRules(true)} className="btn-subtle">NORMAS</button>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'admin-select-subject' && (
                        <div className="screen">
                             <div className="cyber-border flex-col" data-label="SELECT_CATEGORY" style={{maxWidth: '800px', width: '100%'}}>
                                <h2 className="mb-4 text-center">SELECCIONAR ASIGNATURA</h2>
                                <div className="selection-grid">
                                    {Array.from({length: 9}).map((_, i) => {
                                        const sub = gameState.allSubjects[i];
                                        return (
                                            <div 
                                                key={i} 
                                                onClick={() => sub && selectSubject(gameState.rawQuestions, sub)} 
                                                className={`btn-select-grid ${!sub ? 'btn-empty' : ''}`}
                                            >
                                                {sub || ""}
                                            </div>
                                        );
                                    })}
                                </div>
                             </div>
                        </div>
                    )}

                    {gameState.stage === 'admin-select-topic' && (
                        <div className="screen">
                             <div className="cyber-border flex-col" data-label="SELECT_TOPIC" style={{maxWidth: '1000px', width: '100%'}}>
                                <h2 className="mb-4 text-center">SELECCIONAR SITUACI√ìN</h2>
                                <div className="selection-grid large">
                                    {Array.from({length: 15}).map((_, i) => {
                                        const topic = gameState.allTopics[i];
                                        return (
                                            <div 
                                                key={i} 
                                                onClick={() => topic && selectTopic(topic)} 
                                                className={`btn-select-grid ${!topic ? 'btn-empty' : ''}`}
                                            >
                                                {topic || ""}
                                            </div>
                                        );
                                    })}
                                </div>
                             </div>
                        </div>
                    )}

                    {gameState.stage === 'admin-lobby' && (
                        <div className="screen">
                            <p className="pulse">ID DE SE√ëAL ACTIVA:</p>
                            <div style={{fontSize: '5rem', fontWeight: 900, border: '4px solid var(--c-green)', padding: '0.5rem 3rem', background: '#000', margin: '1rem 0'}}>{gameState.roomId}</div>
                            <button onClick={() => {
                                startTimeRef.current = Date.now();
                                adminConns.current.forEach(c => {
                                    // Get 20 questions based on logic (random or filled)
                                    const gameQuestions = getGameQuestions(gameState.filteredQuestions);
                                    
                                    const sectors = [1,2,3,4,5].map(i => ({ id: i, questions: gameQuestions.slice((i-1)*4, i*4), accessCode: Math.floor(Math.random()*90+10).toString(), isSolved: false }));
                                    c.send({type:'GO', sectors});
                                });
                                setGameState(s => ({...s, stage: 'admin-monitor'}));
                            }} disabled={gameState.connectedSquads.length === 0} className="btn-cyber">INICIAR PROTOCOLO</button>
                            <div style={{marginTop: '2rem', fontSize: '0.8rem', opacity: 0.5}}>EQUIPOS: {gameState.connectedSquads.length}</div>
                            <div style={{fontSize: '0.7rem', color:'var(--c-blue)', marginTop:'5px'}}>PREGUNTAS EN POOL: {gameState.filteredQuestions.length}</div>
                        </div>
                    )}

                    {gameState.stage === 'squad-lobby' && (
                        <div className="screen">
                            <div className="big-avatar-container">
                                <div className="big-avatar-icon">{getSquadIcon(gameState.squadAnimal)}</div>
                                <div className="big-avatar-name">{gameState.squadNick}</div>
                                <div className="big-avatar-sub">ESTADO: CONECTADO</div>
                            </div>
                            <h2 style={{letterSpacing: '5px'}}>ENLACE ESTABLECIDO</h2>
                            <p style={{opacity: 0.5}}>Esperando orden central...</p>
                        </div>
                    )}

                    {gameState.stage === 'squad-intro' && (
                        <div className="screen">
                            <div className="cyber-border" data-label="SYSTEM_BOOT" style={{maxWidth: '500px', width: '100%'}}>
                                <div className="big-avatar-container" style={{marginBottom:'1rem'}}>
                                    <div className="big-avatar-icon" style={{fontSize:'4rem'}}>{getSquadIcon(gameState.squadAnimal)}</div>
                                </div>
                                <p style={{fontSize: '1.2rem', lineHeight: '2', whiteSpace: 'pre-wrap', textAlign:'center'}}>{`> IDENTIDAD: ${gameState.squadNick}\n> OBJETIVO: B√ìVEDA HYDRA\n> ESTADO: LISTO`}</p>
                                <button onClick={() => setGameState(s => ({...s, stage: 'squad-game'}))} className="btn-cyber w-full" style={{marginTop: '2rem'}}>INICIAR HACKEO</button>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'squad-game' && (
                        <div className="game-layout">
                            {lockout > 0 && (
                                <div className="modal-overlay" style={{background: 'rgba(100,0,0,0.95)', flexDirection: 'column'}}>
                                    <div className="cyber-border" data-label="SECURITY_PROTOCOL_ALERT" style={{padding: '3rem', maxWidth: '600px', width: '90%', textAlign: 'center', borderColor: 'white', borderStyle: 'double'}}>
                                        <h2 className="pulse" style={{color: 'var(--c-red)', fontSize: '2rem', marginBottom: '1.5rem'}}>SISTEMA BLOQUEADO</h2>
                                        <p style={{color: '#fff', fontSize: '1.1rem', lineHeight: '1.6', marginBottom: '2rem', fontWeight: 'bold'}}>
                                            EL SISTEMA HA SIDO BLOQUEADO COMO MEDIDA DE SEGURIDAD AL DETECTARSE UNA INTRUSI√ìN.
                                        </p>
                                        <div style={{fontSize: '6rem', fontWeight: 900, color: '#fff', textShadow: '0 0 20px var(--c-red)'}}>{lockout}</div>
                                        <div style={{fontSize: '0.7rem', color: 'var(--c-red)', marginTop: '1.5rem', letterSpacing: '2px'}}>REINICIANDO PROTOCOLO DE DEFENSA...</div>
                                    </div>
                                </div>
                            )}
                            <div className="main-panel">
                                <div className="cyber-border" data-label="HUD_V5.7" style={{padding: '1.5rem'}}>
                                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
                                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                                            <span style={{fontSize:'2rem'}}>{getSquadIcon(gameState.squadAnimal)}</span>
                                            <div style={{fontWeight: 900, color: 'var(--c-green)', fontSize: '1.5rem'}}>
                                                {gameState.squadNick}
                                            </div>
                                        </div>
                                        <button onClick={() => setShowRules(true)} className="btn-cyber btn-outline" style={{padding:'0.5rem 1rem', fontSize:'0.7rem'}}>VER NORMAS</button>
                                    </div>
                                    <div className="instruction-panel">
                                        <strong>PROTOCOLO HYDRA:</strong><br/>
                                        1. Hackea los 5 sectores para obtener los c√≥digos.<br/>
                                        2. Introduce los 5 c√≥digos en la b√≥veda derecha en el orden secuencial.<br/>
                                        3. Solo tienes un intento por carga en la b√≥veda final.
                                    </div>
                                </div>
                                <div className="sector-vertical-list">
                                    {gameState.sectors.map(s => (
                                        <div key={s.id} onClick={() => !s.isSolved && setActiveSectorId(s.id)} className={`sector-row ${s.isSolved ? 'solved' : ''}`}>
                                            <div><div className="sector-label">SECTOR_0{s.id}</div><div className="sector-status">{s.isSolved ? 'ACCESO_CONCEDIDO' : 'ACCESO_DENEGADO'}</div></div>
                                            <div className="sector-code">{s.isSolved ? s.accessCode : '??'}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="vault-panel">
                                <h3 className="text-center" style={{fontSize: '1rem', letterSpacing: '4px'}}>B√ìVEDA_FINAL</h3>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '8px'}}>{vaultCodes.map((v, i) => <input key={i} maxLength={2} value={v} onChange={e=>{ const n=[...vaultCodes]; n[i]=e.target.value; setVaultCodes(n); }} className="vault-input" />)}</div>
                                <button onClick={() => { if(gameState.sectors.every((s,i) => vaultCodes[i] === s.accessCode)) { connRef.current.send({type:'FIN', name: gameState.squadNick}); } else { setLockout(10); } }} className="btn-cyber w-full" style={{marginTop: 'auto', height: '100px'}}>DETENER N√öCLEO</button>
                            </div>
                            {activeSectorId && <SectorModal sector={gameState.sectors.find(s => s.id === activeSectorId)} onSolved={(id) => { setGameState(s => ({...s, sectors: s.sectors.map(x => x.id===id ? {...x, isSolved:true} : x)})); setActiveSectorId(null); connRef.current.send({type:'SECTOR_UPDATE', name: gameState.squadNick, sectorId: id}); }} onLock={() => { setLockout(10); setActiveSectorId(null); }} />}
                        </div>
                    )}

                    {gameState.stage === 'squad-win' && (
                        <div className="screen">
                            <h2 className="title-huge">MISION COMPLETADA</h2>
                            <div className="cyber-border" data-label="DATA_LOG" style={{padding:'3rem', textAlign:'center'}}>
                                <div className="big-avatar-container">
                                    <div className="big-avatar-icon">{getSquadIcon(gameState.squadAnimal)}</div>
                                </div>
                                <p style={{color:'var(--c-gold)', fontSize:'1.5rem'}}>#RANKING: {gameState.finalRank}</p>
                                <p style={{fontSize:'3rem', margin:'1rem 0'}}>{formatTime(gameState.finalTime)}</p>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'admin-monitor' && (
                        <div className="screen" style={{padding: '2rem'}}>
                            <div style={{width:'100%', display:'flex', justifyContent:'space-between', marginBottom:'1rem', alignItems:'center'}}>
                                <div>
                                    <h1 style={{margin:0}}>CENTRO_MONITOREO</h1>
                                    <div style={{fontSize:'0.8rem', color:'var(--c-blue)', marginTop:'5px'}}>
                                        ASIGNATURA: {gameState.selectedSubject} | SITUACI√ìN: {gameState.selectedTopic}
                                    </div>
                                </div>
                                <button onClick={handleTerminate} className="btn-cyber" style={{background:'var(--c-red)', color:'#fff'}}>TERMINAR GLOBAL</button>
                            </div>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'2rem', width:'100%', flex:1}}>
                                <div className="cyber-border" data-label="TERMINAL_WINS">{gameState.finishedSquads.map((s,i) => (<div key={i} style={{display:'flex', justifyContent:'space-between', padding:'15px', borderBottom:'1px solid #333'}}><span>#{i+1} {s.name}</span><span style={{color:'var(--c-gold)'}}>{formatTime(s.time)}</span></div>))}</div>
                                <div className="cyber-border" data-label="LIVE_PROGRESS">
                                    <div style={{display:'grid', gridTemplateColumns:'1fr', gap:'10px'}}>
                                        {/* Monitor uses connectedSquads (which are now Nicks) */}
                                        {gameState.connectedSquads.filter(s => !gameState.finishedSquads.find(f=>f.name===s)).map(nick => {
                                            const prog = gameState.squadProgress[nick] || [];
                                            const avatarName = gameState.playerAvatars[nick];
                                            return (
                                                <div key={nick} style={{padding:'10px', border:'1px solid var(--c-blue)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                                    <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                                                        <span style={{fontSize:'1.5rem'}}>{getSquadIcon(avatarName)}</span>
                                                        <span style={{fontWeight:'bold', color:'var(--c-green)', fontSize: '1.2rem'}}>{nick}</span>
                                                    </div>
                                                    <div style={{display:'flex', gap:'5px'}}>
                                                        {[1,2,3,4,5].map(id => (
                                                            <div key={id} style={{
                                                                width:'20px', height:'20px',
                                                                background: prog.includes(id) ? 'var(--c-green)' : '#111',
                                                                border: '1px solid ' + (prog.includes(id) ? 'var(--c-green)' : '#333'),
                                                                display:'flex', alignItems:'center', justifyContent:'center', fontSize:'10px', color:'#000'
                                                            }}>
                                                                {prog.includes(id) ? '‚úì' : id}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {gameState.connectedSquads.filter(s => !gameState.finishedSquads.find(f=>f.name===s)).length === 0 && <p style={{opacity:0.5, textAlign:'center'}}>NO HAY AGENTES ACTIVOS</p>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const SectorModal = ({ sector, onSolved, onLock }) => {
            const [idx, setIdx] = useState(0);
            const [sel, setSel] = useState(null);
            const [shuffledOptions, setShuffledOptions] = useState([]);
            const q = sector.questions[idx];

            // Shuffle options whenever the question changes or modal re-renders (retry after lock)
            useEffect(() => {
                if (!q) return;
                const opts = q.options.map((text, i) => ({
                    text,
                    isCorrect: i === q.correctIndex
                }));
                // Simple shuffle
                setShuffledOptions(opts.sort(() => Math.random() - 0.5));
            }, [idx, q]);

            const check = (item, indexInShuffled) => {
                if(sel !== null) return;
                setSel(indexInShuffled);
                setTimeout(() => {
                    if(item.isCorrect) {
                        if(idx+1 < sector.questions.length) { 
                            setIdx(idx+1); 
                            setSel(null); 
                        }
                        else onSolved(sector.id);
                    } else {
                        onLock();
                    }
                }, 800);
            };

            if (!q) return null;

            return (
                <div className="modal-overlay">
                    <div className="detailed-modal">
                        <div className="modal-header-bar">
                            <span>TERMINAL_BREACH_SECTOR_0{sector.id}</span>
                            <span className="pulse">ESTADO: HACKEANDO...</span>
                        </div>
                        <div className="modal-body">
                            <div style={{position: 'absolute', right: '2rem', top: '1.5rem', color: 'var(--c-blue)', fontSize: '0.6rem', opacity: 0.4}}>
                                {Array(sector.questions.length).fill(0).map((_, i) => <span key={i} style={{marginLeft: '4px'}}>{i < idx ? '‚ñ£' : (i === idx ? '‚ñ∂' : '‚ñ°')}</span>)}
                            </div>
                            <div className="question-text">{q.question}</div>
                            <div className="options-grid">
                                {shuffledOptions.map((item, i) => (
                                    <button 
                                        key={i} 
                                        onClick={() => check(item, i)} 
                                        disabled={sel !== null} 
                                        className={`option-btn ${sel === i ? (item.isCorrect ? 'correct' : 'wrong') : ''}`}
                                    >
                                        <span style={{opacity: 0.3, marginRight: '10px'}}>{String.fromCharCode(65 + i)}//</span>
                                        {item.text}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="modal-footer-stats">
                            <span>SISTEMA: HYDRA_V5.7</span>
                            <span>CAPA_RESEGURIDAD_{idx+1}/{sector.questions.length}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>