<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scape Room - Protocolo Cyberpunk (OFFLINE)</title>
    <!-- Icono en Base64 para que cargue siempre -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê∫</text></svg>">
    
    <!-- 
        === IMPORTANTE: CARPETA JS ===
        Aseg√∫rate de tener la carpeta "js" al lado de este archivo con:
        - react.js
        - react-dom.js
        - babel.js
        - peerjs.js
    -->
    <script src="./js/react.js"></script>
    <script src="./js/react-dom.js"></script>
    <script src="./js/babel.js"></script>
    <script src="./js/peerjs.js"></script>
    
    <!-- Intenta cargar la fuente online, pero tenemos un fallback robusto en CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --c-black: #050505;
            --c-green: #00ff41;
            --c-green-dim: rgba(0, 255, 65, 0.1);
            --c-blue: #00f3ff;
            --c-blue-dim: rgba(0, 243, 255, 0.1);
            --c-red: #ff003c;
            --c-gold: #ffd700;
            
            /* Fuente H√≠brida: Intenta cargar la bonita, si no, usa las del sistema estilo consola */
            --font-main: 'Share Tech Mono', 'Courier New', Courier, 'Lucida Console', Monaco, monospace;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; }
        
        body { 
            background-color: var(--c-black); 
            color: var(--c-green); 
            font-family: var(--font-main); 
            margin: 0; 
            padding: 0;
            overflow-x: hidden;
            min-height: 100vh;
            /* Efecto CRT Scanlines sutil en el fondo */
            background: radial-gradient(circle at center, #111 0%, #000 100%);
        }

        /* Efecto Matrix de fondo */
        .bg-matrix {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background-image: 
                linear-gradient(rgba(0, 255, 65, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            pointer-events: none;
        }

        /* --- UTILITIES --- */
        .hidden { display: none; }
        .uppercase { text-transform: uppercase; }
        .font-black { font-weight: 900; }
        .relative { position: relative; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }

        /* --- TYPOGRAPHY & GLOWS --- */
        .text-cyber-green { color: var(--c-green); text-shadow: 0 0 5px var(--c-green-dim); }
        .text-cyber-blue { color: var(--c-blue); text-shadow: 0 0 5px var(--c-blue-dim); }
        .text-cyber-red { color: var(--c-red); text-shadow: 0 0 5px rgba(255, 0, 60, 0.3); }
        .text-cyber-gold { color: var(--c-gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }

        .title-huge {
            font-size: clamp(3rem, 10vw, 6rem);
            line-height: 1;
            font-weight: 900;
            color: var(--c-green);
            text-transform: uppercase;
            text-shadow: 0 0 10px var(--c-green), 0 0 20px var(--c-green-dim);
            margin-bottom: 2rem;
            letter-spacing: -2px;
            animation: glitch 3s infinite alternate;
        }

        /* --- COMPONENTS --- */
        
        /* Contenedores con borde ne√≥n */
        .cyber-border {
            position: relative; 
            border: 1px solid var(--c-green);
            background: rgba(0, 0, 0, 0.85);
            box-shadow: 0 0 15px var(--c-green-dim), inset 0 0 20px rgba(0,0,0,0.8);
            padding: 1.5rem;
            backdrop-filter: blur(2px);
        }
        /* Esquinas decorativas */
        .cyber-border::before, .cyber-border::after {
            content: ''; position: absolute; width: 8px; height: 8px;
            background: var(--c-green); transition: 0.3s;
        }
        .cyber-border::before { top: -1px; left: -1px; box-shadow: 2px 2px 5px var(--c-green); }
        .cyber-border::after { bottom: -1px; right: -1px; box-shadow: -2px -2px 5px var(--c-green); }

        /* Botones */
        .btn-cyber {
            background: var(--c-blue); 
            color: #000;
            font-family: var(--font-main); 
            font-weight: 800; 
            font-size: 1.2rem;
            text-transform: uppercase; 
            padding: 1rem 2rem; 
            width: 100%;
            border: 2px solid var(--c-blue); 
            cursor: pointer; 
            transition: all 0.2s;
            text-shadow: none;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            margin-top: 1rem;
            letter-spacing: 1px;
        }
        .btn-cyber:hover { 
            background: #fff; 
            box-shadow: 0 0 25px var(--c-blue); 
            transform: translateY(-2px);
        }
        .btn-cyber:disabled {
            background: #333;
            border-color: #555;
            color: #777;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-start {
            background: var(--c-green);
            border-color: var(--c-green);
            box-shadow: 0 0 15px var(--c-green-dim);
        }

        /* Inputs */
        .input-cyber {
            width: 100%; 
            background: #000; 
            border: 2px solid var(--c-green);
            padding: 1rem; 
            font-family: var(--font-main); 
            font-size: 1.5rem;
            color: var(--c-green); 
            text-align: center; 
            outline: none;
            box-shadow: inset 0 0 10px rgba(0, 255, 65, 0.1);
            transition: 0.3s;
            text-transform: uppercase;
        }
        .input-cyber:focus { 
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3), inset 0 0 10px rgba(0, 255, 65, 0.2); 
            border-color: #fff;
        }

        /* Squad Cards */
        .squad-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 0.8rem;
            padding: 0.5rem;
        }
        @media(min-width: 768px) { .squad-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); } }

        .squad-card {
            border: 1px solid rgba(0, 255, 65, 0.3);
            background: rgba(0,0,0,0.6);
            padding: 0.8rem; 
            cursor: pointer; 
            transition: 0.2s;
            display: flex; flex-direction: column; align-items: center;
        }
        .squad-card:hover:not(:disabled) { 
            border-color: var(--c-blue); 
            background: rgba(0, 243, 255, 0.1); 
            transform: scale(1.05);
        }
        .squad-card.selected { 
            border-color: var(--c-blue); 
            background: rgba(0, 243, 255, 0.25); 
            box-shadow: 0 0 15px var(--c-blue-dim); 
            transform: scale(1.1); 
            z-index: 10; 
        }
        .squad-card:disabled { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }
        .squad-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .squad-name { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; color: var(--c-green); }

        /* Pantalla central */
        .screen-center {
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            padding: 1rem;
            position: relative; 
            z-index: 10;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--c-green); border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: var(--c-blue); }

        /* Animaciones */
        @keyframes glitch {
            0% { text-shadow: 2px 0 var(--c-red), -2px 0 var(--c-blue); }
            90% { text-shadow: 2px 0 var(--c-red), -2px 0 var(--c-blue); }
            91% { text-shadow: -2px 0 var(--c-red), 2px 0 var(--c-blue); transform: skew(10deg); }
            92% { text-shadow: 0 0 0; transform: skew(0); }
            100% { text-shadow: 2px 0 var(--c-red), -2px 0 var(--c-blue); }
        }
        .animate-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Vault Inputs */
        .vault-input {
            background: #000; border: 2px solid var(--c-blue); color: var(--c-blue);
            width: 100%; height: 3.5rem; font-size: 1.5rem; text-align: center;
            font-family: var(--font-main); font-weight: 900;
            text-shadow: 0 0 5px var(--c-blue);
        }

        /* Bot√≥n Ayuda Flotante */
        .btn-help {
            position: fixed; top: 1.5rem; left: 1.5rem; width: 3.5rem; height: 3.5rem;
            border: 2px solid var(--c-blue); color: var(--c-blue);
            border-radius: 50%; font-size: 1.8rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); cursor: pointer; z-index: 3000;
            transition: 0.3s; box-shadow: 0 0 10px var(--c-blue-dim);
        }
        .btn-help:hover { background: var(--c-blue); color: #000; box-shadow: 0 0 20px var(--c-blue); }

        /* Preloader */
        #preloader {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--c-red); font-family: monospace; text-align: center;
        }
    </style>

<script type="importmap">
{
  "imports": {
    "react": "./js/react.js",
    "react/": "./js/react.js"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <!-- Capas de fondo -->
    <div class="bg-matrix"></div>
    <div style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; z-index:999;"></div>

    <!-- Preloader por si falla JS -->
    <div id="preloader">
        <h1 style="font-size:2rem; margin-bottom:1rem;">CARGANDO SISTEMA...</h1>
        <p style="color:#666;">Si esto no desaparece, verifica que la carpeta <br> <b>/js</b> existe y contiene los 4 archivos.</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // Ocultar preloader cuando React inicia
        document.getElementById('preloader').style.display = 'none';

        const { useState, useEffect, useRef } = React;

        // --- AUDIO SYSTEM ---
        const POTENTIAL_TRACKS = ["./audio/background.mp3", "./audio/music.mp3", "./audio/cyber.mp3", "./audio/track1.mp3", "./audio/track2.mp3"];
        let globalAudioCtx = null;
        let droneNodes = null;

        const getAudioContext = () => {
            if (!globalAudioCtx) globalAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (globalAudioCtx.state === 'suspended') globalAudioCtx.resume();
            return globalAudioCtx;
        };

        const startCyberpunkDrone = (vol = 0.3) => {
            const ctx = getAudioContext();
            if (!ctx || droneNodes) return;
            const osc1 = ctx.createOscillator(); osc1.type = 'sawtooth'; osc1.frequency.value = 50;
            const osc2 = ctx.createOscillator(); osc2.type = 'sawtooth'; osc2.frequency.value = 51;
            const gainNode = ctx.createGain();
            const filter = ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 250;
            osc1.connect(filter); osc2.connect(filter); filter.connect(gainNode); gainNode.connect(ctx.destination);
            gainNode.gain.setValueAtTime(0, ctx.currentTime);
            gainNode.gain.linearRampToValueAtTime(vol * 0.3, ctx.currentTime + 2);
            osc1.start(); osc2.start();
            droneNodes = { osc1, osc2, gainNode };
        };

        const stopCyberpunkDrone = () => {
            if (droneNodes) {
                try {
                    droneNodes.gainNode.gain.linearRampToValueAtTime(0, getAudioContext().currentTime + 1);
                    setTimeout(() => { droneNodes.osc1.stop(); droneNodes.osc2.stop(); }, 1000);
                } catch(e){}
                droneNodes = null;
            }
        };

        const synthSFX = (type, vol = 0.5) => {
            try {
                const ctx = getAudioContext();
                if (!ctx) return;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                const now = ctx.currentTime;
                
                if (type === 'click') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(vol*0.1, now); osc.stop(now + 0.05);
                } else if (type === 'success') {
                    osc.type = 'triangle'; osc.frequency.linearRampToValueAtTime(880, now + 0.1);
                    gain.gain.setValueAtTime(vol*0.2, now); osc.stop(now + 0.6);
                } else if (type === 'error') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+0.3);
                    gain.gain.setValueAtTime(vol*0.2, now); osc.stop(now + 0.3);
                }
                osc.start(now);
            } catch(e) {}
        };

        // --- GAME DATA ---
        const SQUADS = [
            { name: 'Cobra', icon: 'üêç' }, { name: 'Tigre', icon: 'üêÖ' }, { name: 'Halc√≥n', icon: 'ü¶Ö' }, 
            { name: 'Lobo', icon: 'üê∫' }, { name: 'Tibur√≥n', icon: 'ü¶à' }, { name: '√Åguila', icon: 'ü¶Ö' },
            { name: 'Pantera', icon: 'üêÜ' }, { name: 'Oso', icon: 'üêª' }, { name: 'Le√≥n', icon: 'ü¶Å' }, 
            { name: 'Drag√≥n', icon: 'üêâ' }, { name: 'F√©nix', icon: 'üê¶‚Äçüî•' }, { name: 'Toro', icon: 'üêÇ' },
            { name: 'Rino', icon: 'ü¶è' }, { name: 'Zorro', icon: 'ü¶ä' }, { name: 'B√∫ho', icon: 'ü¶â' }, 
            { name: 'Gorila', icon: 'ü¶ç' }, { name: 'Ara√±a', icon: 'üï∑Ô∏è' }, { name: 'Escorpi√≥n', icon: 'ü¶Ç' },
            { name: 'Cuervo', icon: 'üê¶‚Äç‚¨õ' }, { name: 'Pulpo', icon: 'üêô' }, { name: 'Elefante', icon: 'üêò' }, 
            { name: 'Caballo', icon: 'üêé' }, { name: 'Ciervo', icon: 'ü¶å' }, { name: 'Cisne', icon: 'ü¶¢' },
            { name: 'Camale√≥n', icon: 'ü¶é' }, { name: 'Tortuga', icon: 'üê¢' }, { name: 'Ping√ºino', icon: 'üêß' }, 
            { name: 'Murci√©lago', icon: 'ü¶á' }, { name: 'Cangrejo', icon: 'ü¶Ä' }, { name: 'Medusa', icon: 'ü™º' }
        ];

        const formatTime = (ms) => {
            if (!ms) return "00:00";
            const s = Math.floor(ms / 1000);
            return `${Math.floor(s / 60).toString().padStart(2,'0')}:${(s % 60).toString().padStart(2,'0')}`;
        };

        const Typewriter = ({ text, className }) => {
            const [d, setD] = useState('');
            useEffect(() => {
                let i = 0; const t = setInterval(() => {
                    if (i < text.length) setD(x => x + text.charAt(i++)); else clearInterval(t);
                }, 30);
                return () => clearInterval(t);
            }, [text]);
            return <div className={className}>{d}<span className="animate-pulse">_</span></div>;
        };

        const INITIAL_STATE = { stage: 'selection', roomId: '', connectedSquads: [], finishedSquads: [], takenSquads: [], sectors: [], squadAnimal: null, isSquadSelecting: false, finalRank: 0, finalTime: 0 };

        function App() {
            const [gameState, setGameState] = useState(INITIAL_STATE);
            const [volume, setVolume] = useState(0.4);
            const [lockout, setLockout] = useState(0);
            const [activeSectorId, setActiveSectorId] = useState(null);
            const [vaultCodes, setVaultCodes] = useState(['','','','','']);
            const [showHelp, setShowHelp] = useState(false);
            
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const adminConns = useRef([]);
            const startTimeRef = useRef(null);

            const playSFX = (t) => synthSFX(t, volume);

            useEffect(() => {
                if (lockout > 0) { const t = setInterval(() => setLockout(l => l-1), 1000); return () => clearInterval(t); }
            }, [lockout]);

            const startAdmin = (file) => {
                startCyberpunkDrone(volume);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.trim().split('\n');
                    const questions = lines.slice(1).map((l, i) => {
                        const p = l.split(';').map(x => x.trim().replace(/^"|"$/g, ''));
                        return { id: i, question: p[1], options: [p[2],p[3],p[4],p[5]], correctIndex: (parseInt(p[7])||1)-1, imageUrl: p[8] };
                    }).filter(q => q.question);
                    
                    const id = Math.floor(10000 + Math.random() * 90000).toString();
                    const peer = new Peer(`sr-host-${id}`);
                    peer.on('open', () => setGameState(s => ({...s, stage: 'admin-lobby', roomId: id, rawQuestions: questions})));
                    peer.on('connection', c => {
                        c.on('open', () => { adminConns.current.push(c); c.send({type:'SYNC', taken: gameState.connectedSquads}); });
                        c.on('data', d => {
                            if(d.type==='REQ') {
                                if(gameState.connectedSquads.includes(d.name)) c.send({type:'NO'});
                                else {
                                    c.send({type:'OK'});
                                    setGameState(prev => {
                                        const next = [...prev.connectedSquads, d.name];
                                        adminConns.current.forEach(ac => ac.open && ac.send({type:'SYNC', taken: next}));
                                        return {...prev, connectedSquads: next};
                                    });
                                }
                            }
                            if(d.type==='FIN') {
                                const time = Date.now() - startTimeRef.current;
                                setGameState(prev => {
                                    const nextFin = [...prev.finishedSquads, {name:d.name, time}];
                                    c.send({type:'WIN_DATA', rank: nextFin.length, time});
                                    return {...prev, finishedSquads: nextFin};
                                });
                            }
                        });
                    });
                    peerRef.current = peer;
                };
                reader.readAsText(file);
            };

            const joinSquad = (rid) => {
                startCyberpunkDrone(volume);
                const peer = new Peer();
                peer.on('open', () => {
                    const c = peer.connect(`sr-host-${rid}`);
                    c.on('open', () => connRef.current = c);
                    c.on('data', d => {
                        if(d.type==='SYNC') setGameState(s => ({...s, takenSquads: d.taken, stage: s.stage === 'selection' ? 'squad-selection' : s.stage}));
                        if(d.type==='OK') setGameState(s => ({...s, stage: 'squad-lobby'}));
                        if(d.type==='NO') { alert("Ocupado"); setGameState(s => ({...s, isSquadSelecting: false})); }
                        if(d.type==='GO') setGameState(s => ({...s, stage: 'squad-intro', sectors: d.sectors}));
                        if(d.type==='WIN_DATA') setGameState(s => ({...s, stage: 'squad-win', finalRank: d.rank, finalTime: d.time}));
                    });
                });
                peerRef.current = peer;
            };

            const reset = () => {
                if(peerRef.current) peerRef.current.destroy();
                stopCyberpunkDrone();
                setGameState(INITIAL_STATE);
            };

            if (lockout > 0) return (
                <div style={{position:'fixed', inset:0, background:'black', zIndex:5000, display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', color:'var(--c-red)'}}>
                    <div className="title-huge" style={{color:'var(--c-red)', fontSize:'5rem'}}>BLOQUEO</div>
                    <div style={{fontSize:'8rem', fontWeight:'900'}}>{lockout}</div>
                </div>
            );

            // RENDER LOGIC
            return (
                <div className="relative w-full h-full">
                    {/* Help Button */}
                    {gameState.stage === 'selection' && (
                        <button onClick={() => setShowHelp(true)} className="btn-help">?</button>
                    )}

                    {/* Help Modal */}
                    {showHelp && (
                        <div style={{position:'fixed', inset:0, background:'rgba(0,0,0,0.9)', zIndex:4000, display:'flex', alignItems:'center', justifyContent:'center'}}>
                            <div className="cyber-border" style={{maxWidth:'500px', width:'90%'}}>
                                <h2 className="text-cyber-blue" style={{fontSize:'2rem', marginBottom:'1rem'}}>PROTOCOLO</h2>
                                <ul style={{listStyle:'none', padding:0, lineHeight:'1.8'}}>
                                    <li>1. Ingresa ID de Misi√≥n.</li>
                                    <li>2. Elige Avatar (R√°pido, son √∫nicos).</li>
                                    <li>3. Responde preguntas para hackear.</li>
                                    <li>4. Obt√©n c√≥digos y escapa.</li>
                                </ul>
                                <button onClick={() => setShowHelp(false)} className="btn-cyber" style={{borderColor:'var(--c-red)', color:'var(--c-red)'}}>CERRAR</button>
                            </div>
                        </div>
                    )}

                    {/* STAGES */}
                    {gameState.stage === 'selection' && (
                        <div className="screen-center">
                            <h1 className="title-huge text-center">SCAPE ROOM</h1>
                            <div className="cyber-border" style={{width:'100%', maxWidth:'500px'}}>
                                <div className="flex-col" style={{gap:'1rem'}}>
                                    <input id="rid" type="text" placeholder="ID MISI√ìN" maxLength={5} className="input-cyber" />
                                    <button onClick={() => joinSquad(document.getElementById('rid').value)} className="btn-cyber">INICIAR ENLACE</button>
                                </div>
                                <div style={{marginTop:'2rem', borderTop:'1px solid #333', paddingTop:'1rem'}}>
                                    <button onClick={() => setGameState(s => ({...s, stage: 'admin-setup'}))} style={{background:'none', border:'none', color:'var(--c-green)', opacity:0.5, width:'100%', fontSize:'0.8rem', cursor:'pointer'}}>// ACCESO ADMIN //</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'admin-setup' && (
                        <div className="screen-center">
                            <div className="cyber-border" style={{width:'100%', maxWidth:'500px'}}>
                                <h2 className="text-cyber-green" style={{fontSize:'1.5rem', marginBottom:'1.5rem'}}>CONFIGURAR NODO</h2>
                                <input id="csvFile" type="file" accept=".csv" style={{color:'#888', marginBottom:'1.5rem', width:'100%'}} />
                                <button onClick={() => startAdmin(document.getElementById('csvFile').files[0])} className="btn-cyber btn-start">LANZAR SERVIDOR</button>
                                <button onClick={reset} style={{background:'none', border:'none', color:'#666', marginTop:'1rem', width:'100%', cursor:'pointer'}}>CANCELAR</button>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'admin-lobby' && (
                        <div className="screen-center">
                            <div className="uppercase text-cyber-blue" style={{marginBottom:'0.5rem'}}>ID DE MISI√ìN</div>
                            <div style={{fontSize:'4rem', fontWeight:'900', color:'var(--c-green)', border:'2px solid var(--c-green)', padding:'1rem 3rem', marginBottom:'2rem', background:'#000'}}>{gameState.roomId}</div>
                            
                            <div className="cyber-border" style={{width:'100%', maxWidth:'800px', height:'400px', display:'flex', flexDirection:'column'}}>
                                <div style={{flex:1, overflowY:'auto', padding:'1rem'}}>
                                    <h3 className="text-cyber-blue" style={{borderBottom:'1px solid #333', paddingBottom:'0.5rem', marginBottom:'1rem'}}>UNIDADES ({gameState.connectedSquads.length})</h3>
                                    <div style={{display:'flex', flexWrap:'wrap', gap:'0.5rem'}}>
                                        {gameState.connectedSquads.map(s => <span key={s} style={{background:'rgba(0,255,65,0.1)', color:'var(--c-green)', padding:'0.2rem 0.6rem', border:'1px solid var(--c-green)', fontSize:'0.9rem'}}>{s}</span>)}
                                    </div>
                                </div>
                                <button 
                                    onClick={() => {
                                        playSFX('access');
                                        startTimeRef.current = Date.now();
                                        const qs = gameState.rawQuestions;
                                        adminConns.current.forEach(c => {
                                            const shuffled = [...qs].sort(()=>Math.random()-.5);
                                            const sectors = [1,2,3,4,5].map(i => ({ id: i, questions: shuffled.slice((i-1)*4, i*4), accessCode: Math.floor(Math.random()*90+10).toString(), isSolved: false }));
                                            c.send({type:'GO', sectors});
                                        });
                                        setGameState(s => ({...s, stage: 'admin-monitor', sectors: []}));
                                    }}
                                    disabled={gameState.connectedSquads.length === 0}
                                    className="btn-cyber btn-start"
                                >
                                    INICIAR MISI√ìN
                                </button>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'squad-selection' && (
                        <div className="screen-center">
                            <h2 className="text-cyber-blue" style={{fontSize:'2rem', marginBottom:'1.5rem'}}>SELECCI√ìN DE AVATAR</h2>
                            <div className="cyber-border" style={{width:'100%', maxWidth:'900px', maxHeight:'70vh', overflowY:'auto'}}>
                                <div className="squad-grid">
                                    {SQUADS.map(s => {
                                        const taken = gameState.takenSquads.includes(s.name);
                                        const selected = gameState.squadAnimal === s.name;
                                        return (
                                            <button 
                                                key={s.name} 
                                                disabled={taken || gameState.isSquadSelecting}
                                                onClick={() => {
                                                    playSFX('click');
                                                    setGameState(p => ({...p, isSquadSelecting: true, squadAnimal: s.name}));
                                                    connRef.current.send({type:'REQ', name: s.name});
                                                }}
                                                className={`squad-card ${selected ? 'selected' : ''}`}
                                            >
                                                <div className="squad-icon">{s.icon}</div>
                                                <div className="squad-name">{s.name}</div>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'squad-lobby' && (
                        <div className="screen-center">
                            <div style={{fontSize:'6rem', animation:'pulse 1s infinite'}}>üì°</div>
                            <h2 className="text-cyber-green uppercase" style={{letterSpacing:'2px', marginTop:'1rem'}}>ESPERANDO SE√ëAL...</h2>
                        </div>
                    )}

                    {gameState.stage === 'squad-intro' && (
                        <div className="screen-center">
                            <div className="cyber-border" style={{maxWidth:'600px', padding:'2rem'}}>
                                <Typewriter text={`>>> INICIANDO PROTOCOLO HYDRA.\n>>> AGENTE: ${gameState.squadAnimal}\n>>> MISI√ìN: HACKEAR 5 SECTORES.\n>>> ESTADO: LISTO.`} className="text-cyber-green" style={{fontSize:'1.2rem', whiteSpace:'pre-wrap', lineHeight:'1.5', marginBottom:'2rem', display:'block'}} />
                                <button onClick={() => setGameState(s => ({...s, stage: 'squad-game'}))} className="btn-cyber">INFILTRARSE</button>
                            </div>
                        </div>
                    )}

                    {gameState.stage === 'squad-game' && (
                        <div style={{padding:'1rem', minHeight:'100vh', display:'flex', flexDirection:'column', gap:'1rem'}}>
                            <div className="cyber-border" style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <span className="text-cyber-green uppercase" style={{fontWeight:'bold', fontSize:'1.2rem'}}>AGENTE {gameState.squadAnimal}</span>
                                <div style={{display:'flex', gap:'0.5rem'}}>
                                    {[1,2,3,4,5].map(i => <div key={i} style={{width:'12px', height:'12px', borderRadius:'50%', background: gameState.sectors.find(s=>s.id===i)?.isSolved ? 'var(--c-green)' : '#333', boxShadow: gameState.sectors.find(s=>s.id===i)?.isSolved ? '0 0 10px var(--c-green)' : 'none'}}></div>)}
                                </div>
                            </div>

                            <div style={{display:'flex', gap:'1rem', flexWrap:'wrap', flex:1}}>
                                <div style={{flex:1, minWidth:'300px', display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(140px, 1fr))', gap:'1rem'}}>
                                    {gameState.sectors.map(s => (
                                        <div key={s.id} onClick={() => !s.isSolved && setActiveSectorId(s.id)} className="cyber-border" style={{cursor:'pointer', display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', minHeight:'120px', background: s.isSolved ? 'rgba(0,255,65,0.05)' : 'rgba(0,0,0,0.8)'}}>
                                            <span className="text-cyber-blue" style={{fontSize:'0.8rem', marginBottom:'0.5rem'}}>SECTOR 0{s.id}</span>
                                            <span style={{fontSize:'2.5rem', fontWeight:'900', color: s.isSolved ? 'var(--c-green)' : '#fff'}}>{s.isSolved ? s.accessCode : '??'}</span>
                                        </div>
                                    ))}
                                </div>

                                <div className="cyber-border" style={{width:'100%', maxWidth:'300px', display:'flex', flexDirection:'column', gap:'1rem'}}>
                                    <h3 className="text-cyber-blue text-center uppercase">B√ìVEDA HYDRA</h3>
                                    <div style={{display:'grid', gridTemplateColumns:'repeat(5, 1fr)', gap:'5px'}}>
                                        {vaultCodes.map((v, i) => <input key={i} maxLength={2} value={v} onChange={e=>{ const n=[...vaultCodes]; n[i]=e.target.value; setVaultCodes(n); }} className="vault-input" />)}
                                    </div>
                                    <button onClick={() => {
                                        if(gameState.sectors.every((s,i) => vaultCodes[i] === s.accessCode)) { playSFX('success'); connRef.current.send({type:'FIN', name: gameState.squadAnimal}); }
                                        else { playSFX('error'); setLockout(5); }
                                    }} className="btn-cyber" style={{marginTop:'auto'}}>ABRIR</button>
                                </div>
                            </div>
                            
                            {/* MODAL PREGUNTAS */}
                            {activeSectorId && (
                                <SectorModal 
                                    sector={gameState.sectors.find(s => s.id === activeSectorId)} 
                                    playSFX={playSFX}
                                    onClose={() => setActiveSectorId(null)}
                                    onSolved={(id) => {
                                        playSFX('success');
                                        setGameState(s => ({...s, sectors: s.sectors.map(x => x.id===id ? {...x, isSolved:true} : x)}));
                                        setActiveSectorId(null);
                                    }}
                                    onLock={() => { playSFX('error'); setLockout(5); setActiveSectorId(null); }}
                                />
                            )}
                        </div>
                    )}

                    {gameState.stage === 'squad-win' && (
                        <div className="screen-center">
                            <h2 className="title-huge text-center" style={{fontSize:'4rem', lineHeight:'1'}}>MISI√ìN<br/>CUMPLIDA</h2>
                            <div style={{display:'flex', gap:'2rem', marginBottom:'2rem'}}>
                                <div className="cyber-border text-center">
                                    <div style={{fontSize:'0.8rem', color:'var(--c-blue)'}}>TIEMPO</div>
                                    <div style={{fontSize:'3rem', fontFamily:'monospace'}}>{formatTime(gameState.finalTime)}</div>
                                </div>
                                <div className="cyber-border text-center">
                                    <div style={{fontSize:'0.8rem', color:'var(--c-gold)'}}>RANKING</div>
                                    <div style={{fontSize:'3rem', color:'var(--c-gold)', fontWeight:'900'}}>#{gameState.finalRank}</div>
                                </div>
                            </div>
                            <button onClick={reset} className="btn-cyber btn-start" style={{width:'auto', padding:'1rem 3rem'}}>NUEVA MISI√ìN</button>
                        </div>
                    )}

                    {gameState.stage === 'admin-monitor' && (
                        <div style={{padding:'2rem', minHeight:'100vh', display:'flex', flexDirection:'column'}}>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'2rem', borderBottom:'1px solid rgba(0,255,65,0.2)', paddingBottom:'1rem'}}>
                                <h1 className="text-cyber-green" style={{fontSize:'2rem', margin:0}}>CONTROL HYDRA</h1>
                                <button onClick={reset} style={{border:'1px solid var(--c-red)', background:'none', color:'var(--c-red)', padding:'0.5rem 1rem', cursor:'pointer'}}>TERMINAR</button>
                            </div>
                            <div style={{flex:1, display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))', gap:'2rem'}}>
                                <div className="cyber-border" style={{overflowY:'auto'}}>
                                    <h3 className="text-cyber-gold" style={{fontSize:'1.5rem', marginBottom:'1rem'}}>RANKING</h3>
                                    {gameState.finishedSquads.map((s,i) => (
                                        <div key={i} style={{display:'flex', justifyContent:'space-between', padding:'1rem', background:'rgba(255, 215, 0, 0.1)', borderLeft:'4px solid var(--c-gold)', marginBottom:'0.5rem'}}>
                                            <span style={{fontWeight:'bold'}}>#{i+1} {s.name}</span>
                                            <span style={{fontFamily:'monospace'}}>{formatTime(s.time)}</span>
                                        </div>
                                    ))}
                                </div>
                                <div className="cyber-border">
                                    <h3 className="text-cyber-blue" style={{fontSize:'1.5rem', marginBottom:'1rem'}}>EN PROGRESO</h3>
                                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.5rem'}}>
                                        {gameState.connectedSquads.filter(s => !gameState.finishedSquads.find(f=>f.name===s)).map(s => (
                                            <div key={s} style={{padding:'0.5rem', border:'1px solid var(--c-blue)', background:'rgba(0, 243, 255, 0.05)', display:'flex', justifyContent:'space-between'}}>
                                                <span>{s}</span><span style={{animation:'pulse 1s infinite'}}>...</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const SectorModal = ({ sector, playSFX, onSolved, onLock }) => {
            const [idx, setIdx] = useState(0);
            const [sel, setSel] = useState(null);
            const [shuffled, setShuffled] = useState([]);
            const q = sector.questions[idx];

            useEffect(() => {
                if(q) {
                    const ops = [...q.options];
                    for(let i=ops.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [ops[i], ops[j]] = [ops[j], ops[i]]; }
                    setShuffled(ops);
                }
            }, [q]);

            const check = (i) => {
                if(sel !== null) return;
                setSel(i);
                const isCorrect = shuffled[i] === q.options[q.correctIndex];
                if(isCorrect) {
                    playSFX('success');
                    setTimeout(() => {
                        if(idx+1 < sector.questions.length) { setIdx(idx+1); setSel(null); }
                        else onSolved(sector.id);
                    }, 800);
                } else {
                    playSFX('error');
                    setTimeout(onLock, 800);
                }
            };

            return (
                <div style={{position:'fixed', inset:0, zIndex:2000, background:'rgba(0,0,0,0.95)', display:'flex', alignItems:'center', justifyContent:'center'}}>
                    <div className="cyber-border" style={{width:'100%', maxWidth:'700px', padding:'2rem', margin:'1rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:'1.5rem', borderBottom:'1px solid rgba(0,255,65,0.3)', paddingBottom:'0.5rem'}}>
                            <span className="text-cyber-green" style={{fontSize:'1.5rem', fontWeight:'900'}}>SECTOR 0{sector.id}</span>
                            <span className="text-cyber-blue">{idx+1}/{sector.questions.length}</span>
                        </div>
                        {q.imageUrl && <img src={q.imageUrl} style={{width:'100%', height:'200px', objectFit:'cover', marginBottom:'1.5rem', border:'1px solid #333', filter:'grayscale(1)'}} />}
                        <p style={{fontSize:'1.2rem', marginBottom:'2rem', lineHeight:'1.4'}}>{q.question}</p>
                        <div style={{display:'grid', gap:'1rem'}}>
                            {shuffled.map((op, i) => (
                                <button 
                                    key={i} 
                                    onClick={() => check(i)}
                                    disabled={sel !== null}
                                    style={{
                                        padding:'1rem', textAlign:'left', fontSize:'1.1rem', cursor:'pointer',
                                        background: sel === i ? (shuffled[i] === q.options[q.correctIndex] ? 'var(--c-green)' : 'var(--c-red)') : 'transparent',
                                        color: sel === i ? '#000' : 'var(--c-green)',
                                        border: `1px solid ${sel === i ? 'transparent' : 'rgba(0,255,65,0.3)'}`,
                                        fontWeight: 'bold'
                                    }}
                                >
                                    {op}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>