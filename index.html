<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scape Room - Protocolo Cyberpunk</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê∫</text></svg>">
    
    <!-- Librer√≠as desde CDN (No requiere build) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            black: '#020202', green: '#00ff41', blue: '#00f3ff',
                            red: '#ff003c', gold: '#ffd700', dark: '#0a0a0a'
                        }
                    },
                    fontFamily: { mono: ['"Share Tech Mono"', 'monospace'] },
                    animation: {
                        'glitch': 'glitch 1s linear infinite',
                        'pulse-soft': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'alarm': 'alarm 0.5s ease-in-out infinite alternate',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'shimmer': 'shimmer 1.5s infinite linear',
                    },
                    keyframes: {
                        glitch: {
                            '2%, 64%': { transform: 'translate(2px,0) skew(0deg)' },
                            '4%, 60%': { transform: 'translate(-2px,0) skew(0deg)' },
                            '62%': { transform: 'translate(0,0) skew(5deg)' },
                        },
                        alarm: { 'from': { backgroundColor: 'rgba(255, 0, 60, 0.1)' }, 'to': { backgroundColor: 'rgba(255, 0, 60, 0.5)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(300%)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020202; color: #00ff41; overflow-x: hidden; font-family: 'Share Tech Mono', monospace; }
        .bg-matrix {
            background-image: linear-gradient(rgba(0, 255, 65, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0, 255, 65, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 999;
        }
        .cyber-border { position: relative; border: 1px solid rgba(0, 255, 65, 0.3); }
        .cyber-border::before, .cyber-border::after {
            content: ''; position: absolute; width: 10px; height: 10px;
            border: 2px solid #00ff41; pointer-events: none;
        }
        .cyber-border::before { top: -2px; left: -2px; border-right: 0; border-bottom: 0; }
        .cyber-border::after { top: -2px; right: -2px; border-left: 0; border-bottom: 0; }
        .huge-text { font-size: clamp(4rem, 15vw, 10rem); line-height: 0.8; }
        
        /* Ajuste de tama√±o para inputs de b√≥veda */
        .vault-input { 
            background: #000; 
            border: 2px solid #00f3ff; 
            color: #00f3ff; 
            width: 100%; 
            text-align: center; 
            font-size: 1.25rem; /* Reducido de 1.5rem */
            outline: none; 
            height: 3.5rem; /* Altura fija para consistencia */
        }
        
        .scan-animation { background: linear-gradient(0deg, transparent 0%, rgba(0, 243, 255, 0.1) 50%, transparent 100%); background-size: 100% 200%; animation: scan 3s linear infinite; position: absolute; inset: 0; pointer-events: none; }
        @keyframes scan { 0% { background-position: 0 -100%; } 100% { background-position: 0 100%; } }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>
    <div class="crt-overlay"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // M√∫sica de fondo (Royalty Free / Free Music Archive)
        const AUDIO_PLAYLIST = [
            "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/BoxCat_Games/Nameless_the_Hackers_RPG_Soundtrack/BoxCat_Games_-_10_-_Epic_Song.mp3",
            "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Tours/Enthusiast/Tours_-_01_-_Enthusiast.mp3",
            "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Kai_Engel/Satin/Kai_Engel_-_04_-_Sentinel.mp3"
        ];

        // Variable global para el contexto de audio
        let globalAudioCtx = null;

        const getAudioContext = () => {
            if (!globalAudioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) globalAudioCtx = new AudioContext();
            }
            // Importante: intentar reanudar siempre que sea posible
            if (globalAudioCtx && globalAudioCtx.state === 'suspended') {
                globalAudioCtx.resume();
            }
            return globalAudioCtx;
        };

        // Generador de Sonidos Web Audio API
        const synthSFX = (type, vol = 0.5) => {
            try {
                const ctx = getAudioContext();
                if (!ctx) return;

                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                const now = ctx.currentTime;
                
                if (type === 'click') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(300, now + 0.05);
                    gain.gain.setValueAtTime(vol * 0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                } 
                else if (type === 'success') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.linearRampToValueAtTime(880, now + 0.1);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(vol * 0.2, now + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                    osc.start(now);
                    osc.stop(now + 0.6);
                    
                    const osc2 = ctx.createOscillator();
                    const gain2 = ctx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(ctx.destination);
                    osc2.type = 'sine';
                    osc2.frequency.setValueAtTime(554.37, now);
                    osc2.frequency.linearRampToValueAtTime(1108.73, now + 0.1);
                    gain2.gain.setValueAtTime(0, now);
                    gain2.gain.linearRampToValueAtTime(vol * 0.1, now + 0.1);
                    gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                    osc2.start(now);
                    osc2.stop(now + 0.6);
                } 
                else if (type === 'error') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                    gain.gain.setValueAtTime(vol * 0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
                else if (type === 'access') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(1200, now);
                    osc.frequency.linearRampToValueAtTime(2400, now + 0.1);
                    gain.gain.setValueAtTime(vol * 0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                }
            } catch (e) {
                console.error("Audio Context Error", e);
            }
        };

        const SQUADS = [
            { name: 'Cobra', icon: 'üêç' }, { name: 'Tigre', icon: 'üêÖ' },
            { name: 'Halc√≥n', icon: 'ü¶Ö' }, { name: 'Lobo', icon: 'üê∫' },
            { name: 'Tibur√≥n', icon: 'ü¶à' }, { name: '√Åguila', icon: 'ü¶Ö' },
            { name: 'Pantera', icon: 'üêÜ' }, { name: 'Oso', icon: 'üêª' },
            { name: 'Le√≥n', icon: 'ü¶Å' }, { name: 'Drag√≥n', icon: 'üêâ' },
            { name: 'F√©nix', icon: 'üê¶‚Äçüî•' }, { name: 'Toro', icon: 'üêÇ' },
            { name: 'Rino', icon: 'ü¶è' }, { name: 'Zorro', icon: 'ü¶ä' },
            { name: 'B√∫ho', icon: 'ü¶â' }, { name: 'Gorila', icon: 'ü¶ç' },
        ];

        const EXAMPLE_CSV = `Tipo;Pregunta;R1;R2;R3;R4;Tiempo;Correcta;URL Imagen
quiz;¬øQu√© operador repite cadenas en Python?;*;x;repeat();**;30;1;
quiz;¬øQu√© m√©todo especial se ejecuta al crear un objeto?;__init__;__start__;constructor;__new__;30;1;
quiz;¬øQu√© operador concatena cadenas en Python?;+;concat();join;.;30;1;
quiz;¬øC√≥mo se define una funci√≥n en Python?;def;func;function;define;30;1;
quiz;¬øQu√© tipo de dato es [1, 2, 3]?;Lista;Tupla;Diccionario;Set;30;1;
quiz;¬øC√≥mo se importa un m√≥dulo?;import;use;require;include;30;1;
quiz;¬øQu√© palabra clave maneja excepciones?;try;catch;handle;error;30;1;`;

        const formatTime = (ms) => {
            if (!ms) return "00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const mins = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const secs = (totalSeconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        };

        const Typewriter = ({ text, speed = 25, className }) => {
            const [disp, setDisp] = useState('');
            useEffect(() => {
                let i = 0;
                const timer = setInterval(() => {
                    if (i < text.length) { setDisp(t => t + text.charAt(i)); i++; }
                    else clearInterval(timer);
                }, speed);
                return () => clearInterval(timer);
            }, [text]);
            return <div className={className}>{disp}<span className="animate-pulse inline-block w-2 h-5 bg-cyber-green ml-1 align-middle"></span></div>;
        };

        const INITIAL_STATE = {
            stage: 'selection',
            roomId: '',
            rawQuestions: [],
            connectedSquads: [],
            finishedSquads: [],
            takenSquads: [],
            sectors: [],
            squadAnimal: null,
            isSquadSelecting: false,
            finalRank: 0,
            finalTime: 0
        };

        function App() {
            const [gameState, setGameState] = useState(INITIAL_STATE);
            const [volume, setVolume] = useState(0.4);
            const [isMuted, setIsMuted] = useState(true);
            const [lockout, setLockout] = useState(0);
            const [activeSectorId, setActiveSectorId] = useState(null);
            const [vaultCodes, setVaultCodes] = useState(['','','','','']);
            
            const audioRef = useRef(null);
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const adminConns = useRef([]);
            const connectedSquadsRef = useRef([]); 
            const finishedSquadsRef = useRef([]);
            const startTimeRef = useRef(null);
            const playlistRef = useRef([...AUDIO_PLAYLIST].sort(() => Math.random() - 0.5));
            const currentTrackIdx = useRef(0);

            // Funci√≥n centralizada de SFX con validaci√≥n de contexto
            const playSFX = (type) => {
                getAudioContext(); // Intentar despertar el contexto
                if (isMuted) return;
                synthSFX(type, volume);
            };

            // Inicializaci√≥n de m√∫sica de fondo (SOLO ADMIN)
            const initMusic = () => {
                getAudioContext(); // Cr√≠tico: Despertar AudioContext en interacci√≥n de usuario
                if (audioRef.current) return;
                
                const playTrack = () => {
                    const track = playlistRef.current[currentTrackIdx.current];
                    const audio = new Audio(track);
                    audio.volume = volume; // Asegurar que el volumen inicial se aplica
                    
                    audio.onended = () => {
                        currentTrackIdx.current = (currentTrackIdx.current + 1) % playlistRef.current.length;
                        playTrack();
                    };
                    
                    audio.onerror = (e) => {
                        console.warn("Error reproduciendo pista, saltando...", e);
                        currentTrackIdx.current = (currentTrackIdx.current + 1) % playlistRef.current.length;
                        setTimeout(playTrack, 1000);
                    };

                    audioRef.current = audio;
                    // Play immediately to establish the stream
                    audio.play().catch(e => console.log("Autoplay prevenido por navegador, esperando clic:", e));
                };
                
                playTrack();
                setIsMuted(false); // Forzar unmute para que el admin escuche sin tocar controles
            };

            useEffect(() => {
                if (audioRef.current) {
                    audioRef.current.volume = volume;
                    if (isMuted) audioRef.current.pause();
                    else audioRef.current.play().catch(() => {});
                }
            }, [isMuted, volume]);

            useEffect(() => {
                if (lockout <= 0) return;
                const timer = setInterval(() => setLockout(p => p - 1), 1000);
                return () => clearInterval(timer);
            }, [lockout]);

            const downloadCSV = () => {
                const blob = new Blob([EXAMPLE_CSV], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'mision_ejemplo.csv'; a.click();
            };

            const handleStartAdmin = (file) => {
                initMusic(); // Iniciar m√∫sica para Admin
                if (!file) return alert("Archivo de misi√≥n requerido");
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.trim().split('\n');
                    const questions = lines.slice(1).map((line, i) => {
                        const p = line.split(';').map(x => x.trim().replace(/^"|"$/g, ''));
                        return { id: `q-${i}`, question: p[1], options: [p[2], p[3], p[4], p[5]], correctIndex: (parseInt(p[7]) || 1) - 1, imageUrl: p[8] || null };
                    }).filter(q => q.question);

                    // ID Num√©rico de 5 d√≠gitos
                    const id = Math.floor(10000 + Math.random() * 90000).toString();
                    
                    const peer = new Peer(`sr-host-${id}`);
                    
                    peer.on('open', () => {
                        setGameState(s => ({...s, stage: 'admin-lobby', roomId: id, rawQuestions: questions}));
                    });

                    peer.on('error', (err) => {
                        console.error("PeerJS Error:", err);
                        alert("Error de conexi√≥n: " + err.type);
                    });

                    peer.on('connection', c => {
                        c.on('open', () => {
                            adminConns.current.push(c);
                            c.send({type: 'SYNC', taken: connectedSquadsRef.current});
                        });
                        c.on('data', d => {
                            if (d.type === 'REQ') {
                                if (connectedSquadsRef.current.includes(d.name)) {
                                    c.send({type:'NO'});
                                } else {
                                    c.send({type:'OK'});
                                    connectedSquadsRef.current = [...connectedSquadsRef.current, d.name];
                                    setGameState(s => ({...s, connectedSquads: connectedSquadsRef.current}));
                                    adminConns.current.forEach(conn => {
                                        if(conn.open) conn.send({type:'SYNC', taken: connectedSquadsRef.current});
                                    });
                                }
                            }
                            if (d.type === 'FIN') {
                                const finalTime = Date.now() - startTimeRef.current;
                                const newFinished = [...finishedSquadsRef.current, {name: d.name, time: finalTime}];
                                finishedSquadsRef.current = newFinished; 
                                const rank = newFinished.length; 
                                
                                setGameState(s => ({...s, finishedSquads: newFinished}));
                                c.send({type: 'WIN_DATA', rank: rank, time: finalTime});
                            }
                        });
                        c.on('close', () => {
                            adminConns.current = adminConns.current.filter(conn => conn !== c);
                        });
                    });
                    peerRef.current = peer;
                };
                reader.readAsText(file);
            };

            const handleConnectSquad = (rid) => {
                // initMusic() REMOVIDO: Los escuadrones no tienen m√∫sica de fondo.
                getAudioContext(); // Solo inicializamos el contexto para SFX.
                
                if (!rid) return;
                const peer = new Peer();
                peer.on('open', () => {
                    const c = peer.connect(`sr-host-${rid.toUpperCase()}`);
                    c.on('open', () => {
                        connRef.current = c;
                    });
                    c.on('data', d => {
                        if (d.type === 'SYNC') {
                            setGameState(s => {
                                const canUpdateStage = s.stage === 'selection' || s.stage === 'squad-selection';
                                return {
                                    ...s,
                                    stage: canUpdateStage ? 'squad-selection' : s.stage,
                                    takenSquads: d.taken
                                };
                            });
                        }
                        if (d.type === 'OK') setGameState(s => ({...s, stage: 'squad-lobby'}));
                        if (d.type === 'NO') {
                            alert("Esa unidad ya ha sido tomada.");
                            setGameState(s => ({...s, isSquadSelecting: false, squadAnimal: null}));
                        }
                        if (d.type === 'GO') setGameState(s => ({...s, stage: 'squad-intro', sectors: d.sectors}));
                        if (d.type === 'WIN_DATA') {
                             setGameState(s => ({
                                 ...s, 
                                 stage: 'squad-win', 
                                 finalRank: d.rank, 
                                 finalTime: d.time 
                             }));
                        }
                    });
                });
                peer.on('error', (err) => {
                    console.error("PeerJS Error:", err);
                    alert("Error al conectar: " + err.type);
                });
                peerRef.current = peer;
            };

            const resetGame = () => {
                if(peerRef.current) peerRef.current.destroy();
                adminConns.current = [];
                connectedSquadsRef.current = [];
                finishedSquadsRef.current = [];
                setGameState(INITIAL_STATE);
            };

            if (lockout > 0) return (
                <div className="fixed inset-0 z-[5000] bg-black animate-alarm flex flex-col items-center justify-center font-mono">
                    <div className="text-cyber-red text-8xl font-black mb-8 animate-glitch">BLOQUEO</div>
                    <div className="text-white text-9xl">{lockout}</div>
                </div>
            );

            // Determinar si mostrar controles de audio (Solo ADMIN)
            const showAudioControls = gameState.stage.startsWith('admin');

            const renderContent = () => {
                switch(gameState.stage) {
                    case 'selection':
                        return (
                            <div className="text-center z-10 px-4 w-full max-w-4xl">
                                <h1 className="text-7xl md:text-[8rem] font-black text-cyber-green animate-glitch mb-10 uppercase font-mono tracking-tighter leading-none">Scape Room</h1>
                                
                                <div className="cyber-border p-12 bg-black/80 backdrop-blur-md shadow-[0_0_50px_rgba(0,255,65,0.1)] mb-12">
                                    <h2 className="text-3xl text-cyber-blue mb-8 font-black uppercase tracking-[0.2em] border-b border-cyber-blue/30 pb-4">Unirse a la Red</h2>
                                    <div className="flex flex-col gap-6">
                                        <input id="landing-room-id" type="number" maxLength={5} placeholder="C√ìDIGO DE MISI√ìN (ID)" className="w-full bg-black border-2 border-cyber-blue p-6 text-center text-4xl font-black text-white outline-none focus:shadow-[0_0_30px_#00f3ff] transition-all" />
                                        <button onClick={() => handleConnectSquad(document.getElementById('landing-room-id').value)} className="w-full bg-cyber-blue text-black font-black py-6 text-2xl uppercase hover:bg-white hover:scale-[1.01] transition-all">INICIAR ENLACE</button>
                                    </div>
                                    <div className="mt-8">
                                        <button onClick={downloadCSV} className="text-xs text-gray-500 hover:text-cyber-gold transition-colors font-mono tracking-widest">[ DESCARGAR DATOS EJEMPLO .CSV ]</button>
                                    </div>
                                </div>

                                <div>
                                    <button onClick={() => setGameState(s => ({...s, stage: 'admin-setup'}))} className="text-cyber-green/50 hover:text-cyber-green text-sm font-bold uppercase tracking-[0.3em] border-b border-transparent hover:border-cyber-green transition-all pb-1">
                                        // CREAR NUEVA MISI√ìN (ADMIN)
                                    </button>
                                </div>
                                <p className="mt-8 text-[10px] text-gray-600 uppercase italic font-mono opacity-50">v1.2.4 // AUDIO SYSTEMS ONLINE</p>
                            </div>
                        );
                    case 'admin-setup':
                        return (
                            <div className="cyber-border p-10 bg-black max-w-lg w-full z-10 relative">
                                <h2 className="text-3xl text-cyber-green mb-10 font-black uppercase border-b border-cyber-green/30 pb-4">Configurar Misi√≥n</h2>
                                <div className="mb-8">
                                    <label className="block text-cyber-blue text-sm mb-2 font-bold uppercase">Archivo de Preguntas (.CSV)</label>
                                    <input id="admin-file" type="file" accept=".csv" className="text-xs block w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:border-0 file:text-sm file:font-semibold file:bg-cyber-green/20 file:text-cyber-green hover:file:bg-cyber-green/30" />
                                </div>
                                <button onClick={() => {
                                    const file = document.getElementById('admin-file').files[0];
                                    handleStartAdmin(file);
                                }} className="w-full bg-cyber-green text-black font-black py-5 text-xl uppercase hover:scale-[1.02] transition-transform shadow-[0_0_20px_rgba(0,255,65,0.2)]">Establecer Nodo</button>
                                <button onClick={resetGame} className="w-full mt-6 text-xs text-gray-600 uppercase hover:text-white transition-colors">Cancelar y Volver</button>
                            </div>
                        );
                    case 'admin-lobby':
                        return (
                            <div className="flex flex-col items-center z-10 w-full max-w-5xl px-4">
                                <p className="text-cyber-blue text-sm uppercase tracking-widest mb-4 font-mono">COMPARTIR ID CON ESCUADRONES</p>
                                <div className="huge-text font-black text-cyber-green border-4 border-cyber-green px-12 py-10 bg-cyber-green/5 mb-16 shadow-[0_0_50px_rgba(0,255,65,0.2)] tracking-wider">{gameState.roomId}</div>
                                <div className="grid md:grid-cols-2 gap-8 w-full">
                                    <div className="cyber-border p-8 bg-black/80 font-mono h-64 overflow-y-auto">
                                        <h3 className="text-cyber-blue uppercase mb-6 font-bold text-sm sticky top-0 bg-black pb-2 border-b border-cyber-blue/20">Unidades Conectadas: {gameState.connectedSquads.length}</h3>
                                        <div className="flex flex-wrap gap-3">{gameState.connectedSquads.map(s => <div key={s} className="px-4 py-2 border border-cyber-green bg-cyber-green/10 text-xl font-bold animate-pulse">{s}</div>)}</div>
                                    </div>
                                    <button onClick={() => {
                                        playSFX('access');
                                        startTimeRef.current = Date.now();
                                        
                                        // Generar sectores √∫nicos y mezclados para cada escuadr√≥n conectado
                                        adminConns.current.forEach(c => {
                                            const shuffled = [...gameState.rawQuestions].sort(() => Math.random() - 0.5);
                                            const sectors = [1,2,3,4,5].map(i => ({
                                                id: i, questions: shuffled.slice((i-1)*4, i*4), isSolved: false, accessCode: Math.floor(Math.random()*90+10).toString()
                                            }));
                                            c.send({type:'GO', sectors});
                                        });

                                        // Para el monitor del admin, usamos un set gen√©rico (aunque no se use en detalle)
                                        setGameState(s => ({...s, stage: 'admin-monitor', sectors: []}));
                                    }} disabled={gameState.connectedSquads.length === 0} className={`w-full h-full text-5xl font-black uppercase transition-all ${gameState.connectedSquads.length > 0 ? 'bg-cyber-green text-black shadow-[0_0_40px_#00ff41] hover:bg-white' : 'bg-gray-900 text-gray-700 cursor-not-allowed border border-gray-800'}`}>INICIAR MISI√ìN</button>
                                </div>
                            </div>
                        );
                    case 'squad-selection':
                        return (
                            <div className="z-10 w-full max-w-6xl px-4 text-center">
                                <h2 className="text-4xl text-cyber-blue mb-16 font-black uppercase tracking-widest font-mono">Selecci√≥n de Unidad Operativa</h2>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                    {SQUADS.map(s => {
                                        const isTaken = gameState.takenSquads.includes(s.name);
                                        const isSelected = gameState.squadAnimal === s.name;
                                        
                                        let btnClass = "cyber-border p-8 flex flex-col items-center gap-4 transition-all duration-500 ";
                                        if (gameState.isSquadSelecting) {
                                            if (isSelected) btnClass += "opacity-100 scale-110 border-cyber-blue bg-cyber-blue/10 shadow-[0_0_30px_#00f3ff] z-20";
                                            else btnClass += "opacity-10 grayscale scale-90 blur-sm";
                                        } else {
                                            if (isTaken) btnClass += "opacity-20 grayscale cursor-not-allowed border-gray-800";
                                            else btnClass += "hover:border-cyber-blue hover:scale-105 hover:bg-cyber-blue/5 cursor-pointer";
                                        }

                                        return (
                                            <button key={s.name} 
                                                disabled={gameState.isSquadSelecting || isTaken} 
                                                onClick={() => {
                                                    playSFX('click');
                                                    setGameState(prev => ({...prev, isSquadSelecting: true, squadAnimal: s.name}));
                                                    if(connRef.current) connRef.current.send({type:'REQ', name:s.name});
                                                }}
                                                className={btnClass}>
                                                <span className="text-7xl mb-2 filter drop-shadow-[0_0_10px_rgba(0,255,65,0.5)]">{s.icon}</span>
                                                <span className={`font-bold uppercase tracking-widest ${isTaken && !isSelected ? 'line-through' : ''}`}>
                                                    {isTaken && !isSelected ? 'BLOQUEADO' : s.name}
                                                </span>
                                            </button>
                                        );
                                    })}
                                </div>
                                
                                {gameState.isSquadSelecting && (
                                    <div className="fixed bottom-10 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-2xl px-6">
                                        <div className="bg-black/90 border-2 border-cyber-blue p-6 text-center shadow-[0_0_50px_rgba(0,243,255,0.3)] backdrop-blur-md animate-pulse">
                                            <div className="text-cyber-blue text-2xl font-black uppercase font-mono tracking-widest mb-2">VERIFICANDO ENLACE: {gameState.squadAnimal}</div>
                                            <div className="w-full bg-gray-900 h-1 mt-2 overflow-hidden">
                                                <div className="h-full bg-cyber-blue w-1/3 animate-[shimmer_1s_infinite_linear]"></div>
                                            </div>
                                            <p className="text-white text-[10px] mt-2 opacity-70 uppercase tracking-[0.5em] font-mono">Esperando confirmaci√≥n del servidor central...</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    case 'squad-lobby':
                        return (
                            <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-6 text-center">
                                <div className="scan-animation"></div>
                                <div className="text-[12rem] mb-12 animate-pulse">üì°</div>
                                <h2 className="text-5xl font-black text-cyber-green mb-6 uppercase max-w-4xl leading-tight">ESPERANDO SE√ëAL DEL MANDO CENTRAL</h2>
                                <p className="text-cyber-blue font-mono text-sm tracking-widest uppercase opacity-50">UNIDAD {gameState.squadAnimal?.toUpperCase()} EN L√çNEA</p>
                            </div>
                        );
                    case 'squad-intro':
                        return (
                            <div className="cyber-border max-w-3xl p-16 bg-cyber-dark z-10">
                                <Typewriter text={`>>> OBJETIVO: HACKEO RED HYDRA.\n>>> UNIDAD: ${gameState.squadAnimal?.toUpperCase()}\n>>> MISI√ìN: DESBLOQUEAR 5 SECTORES.\n>>> CIFRADO DE SALIDA: REQUERIDO.\n\nSISTEMA LISTO.`} className="text-2xl text-cyber-green whitespace-pre-wrap mb-12 font-bold font-mono" />
                                <button onClick={() => setGameState(s => ({...s, stage: 'squad-game'}))} className="px-16 py-6 bg-cyber-green text-black font-black uppercase text-2xl shadow-[0_0_20px_#00ff41]">INFILTRARSE</button>
                            </div>
                        );
                    case 'squad-game':
                        const active = gameState.sectors.find(s => s.id === activeSectorId);
                        return (
                            <div className="min-h-screen w-full flex flex-col lg:flex-row gap-8 p-10 z-10 bg-matrix">
                                <div className="flex-1 flex flex-col gap-8">
                                    <header className="cyber-border bg-black p-6 flex justify-between items-center shadow-lg">
                                        <h1 className="text-3xl font-black text-cyber-green font-mono uppercase">AGENTE_{gameState.squadAnimal?.toUpperCase()}</h1>
                                        <div className="flex gap-4">
                                            {[1,2,3,4,5].map(i => <div key={i} className={`w-3 h-3 rounded-full ${gameState.sectors.find(s=>s.id===i)?.isSolved ? 'led-green' : 'bg-gray-800 animate-pulse'}`}></div>)}
                                        </div>
                                    </header>
                                    <div className="grid md:grid-cols-3 gap-6 flex-1">
                                        {gameState.sectors.map(s => (
                                            <div key={s.id} onClick={() => !s.isSolved && setActiveSectorId(s.id)} className={`cyber-border p-8 cursor-pointer transition-all ${s.isSolved ? 'bg-cyber-green/10 border-cyber-green' : 'hover:border-cyber-blue hover:bg-cyber-blue/5'}`}>
                                                <div className="text-[10px] text-cyber-blue mb-4 font-bold uppercase">Sector_{s.id.toString().padStart(2,'0')}</div>
                                                <div className="text-7xl text-center font-black font-mono">{s.isSolved ? s.accessCode : '??'}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="lg:w-96 flex">
                                    <div className="cyber-border p-8 bg-black flex-1 flex flex-col shadow-2xl">
                                        <h2 className="text-xl text-cyber-blue font-black mb-10 border-b border-cyber-blue/20 pb-4 text-center uppercase tracking-widest">B√≥veda Hydra</h2>
                                        {/* Ajuste de inputs */}
                                        <div className="grid grid-cols-5 gap-2 mb-10">
                                            {vaultCodes.map((v, i) => (
                                                <input key={i} maxLength={2} value={v} onChange={e => {
                                                    const n = [...vaultCodes]; n[i] = e.target.value; setVaultCodes(n);
                                                }} className="vault-input font-mono font-black rounded-sm" placeholder="--" />
                                            ))}
                                        </div>
                                        <button onClick={() => {
                                            if(gameState.sectors.every((s, i) => vaultCodes[i] === s.accessCode)) {
                                                playSFX('success');
                                                if(connRef.current) connRef.current.send({type:'FIN', name:gameState.squadAnimal});
                                                setGameState(s => ({...s, isLoadingRank: true}));
                                            } else {
                                                playSFX('error'); setLockout(10);
                                            }
                                        }} disabled={gameState.isLoadingRank} className="w-full bg-cyber-blue text-black font-black py-6 text-2xl uppercase shadow-[0_0_30px_#00f3ff] hover:bg-white transition-all disabled:opacity-50">
                                            {gameState.isLoadingRank ? 'SUBIENDO DATOS...' : 'CONFIRMAR'}
                                        </button>
                                    </div>
                                </div>
                                {active && (
                                    <SectorModal 
                                        sector={active} 
                                        playSFX={playSFX}
                                        onSolved={(id) => {
                                            playSFX('success');
                                            setGameState(s => ({...s, sectors: s.sectors.map(sec => sec.id === id ? {...sec, isSolved: true} : sec)}));
                                            setActiveSectorId(null);
                                        }}
                                        onLocked={() => { playSFX('error'); setActiveSectorId(null); setLockout(10); }}
                                    />
                                )}
                            </div>
                        );
                    case 'squad-win':
                        return (
                            <div className="text-center z-10 px-6 w-full max-w-4xl">
                                <h2 className="text-6xl md:text-8xl font-black text-cyber-green mb-8 animate-glitch uppercase font-mono tracking-tighter">MISI√ìN CUMPLIDA</h2>
                                
                                <div className="grid md:grid-cols-2 gap-8 mb-12">
                                    <div className="cyber-border p-10 bg-black/50 flex flex-col items-center justify-center">
                                        <div className="text-cyber-blue text-sm uppercase tracking-widest mb-2">TIEMPO TOTAL</div>
                                        <div className="text-6xl font-black text-white font-mono">{formatTime(gameState.finalTime)}</div>
                                    </div>
                                    <div className="cyber-border p-10 bg-black/50 flex flex-col items-center justify-center relative overflow-hidden">
                                        <div className="absolute inset-0 bg-cyber-gold/10 animate-pulse"></div>
                                        <div className="text-cyber-gold text-sm uppercase tracking-widest mb-2 relative z-10">CLASIFICACI√ìN</div>
                                        <div className="text-6xl font-black text-cyber-gold font-mono relative z-10">
                                            #{gameState.finalRank}
                                        </div>
                                    </div>
                                </div>

                                <button onClick={resetGame} className="px-16 py-6 border-4 border-cyber-green text-cyber-green font-black text-3xl uppercase hover:bg-cyber-green hover:text-black transition-all shadow-[0_0_30px_rgba(0,255,65,0.3)]">NUEVA INFILTRACI√ìN</button>
                            </div>
                        );
                    case 'admin-monitor':
                        return (
                            <div className="w-full h-screen p-10 z-10 flex flex-col bg-cyber-dark bg-matrix">
                                <header className="flex justify-between items-center border-b border-cyber-green/20 pb-8 mb-16">
                                    <h1 className="text-5xl font-black text-cyber-green font-mono uppercase tracking-tighter">CENTRO DE CONTROL HYDRA</h1>
                                    <button onClick={resetGame} className="px-10 py-4 border border-cyber-red text-cyber-red font-black uppercase hover:bg-cyber-red hover:text-white transition-all">TERMINAR SESI√ìN</button>
                                </header>
                                <div className="grid md:grid-cols-2 gap-12 flex-1 overflow-hidden">
                                    <div className="cyber-border p-8 bg-black/50 overflow-y-auto relative">
                                        <div className="absolute top-0 right-0 p-2 text-[10px] text-cyber-gold font-mono">LIVE FEED</div>
                                        <h2 className="text-cyber-gold text-2xl mb-10 font-black uppercase border-b border-cyber-gold/20 pb-4 tracking-widest">RANKING EN TIEMPO REAL</h2>
                                        <div className="space-y-4">
                                            {gameState.finishedSquads.map((s, i) => (
                                                <div key={i} className="flex items-center justify-between p-6 border-l-4 border-cyber-gold bg-cyber-gold/5 text-4xl font-black uppercase">
                                                    <div className="flex items-center gap-6">
                                                        <span className="text-cyber-gold/50">#{i + 1}</span>
                                                        <span>{s.name}</span>
                                                    </div>
                                                    <span className="text-white font-mono text-3xl">{formatTime(s.time)}</span>
                                                </div>
                                            ))}
                                            {gameState.finishedSquads.length === 0 && <p className="text-gray-700 text-center py-20 animate-pulse uppercase tracking-[0.3em] font-mono">Esperando confirmaciones de extracci√≥n...</p>}
                                        </div>
                                    </div>
                                    <div className="cyber-border p-8 bg-black/50">
                                        <h2 className="text-cyber-blue text-2xl mb-10 font-black uppercase border-b border-cyber-blue/20 pb-4 tracking-widest">ESTADO DE UNIDADES</h2>
                                        <div className="space-y-4">
                                            {gameState.connectedSquads.filter(s => !gameState.finishedSquads.find(f => f.name === s)).map(s => (
                                                <div key={s} className="p-6 text-3xl font-black bg-cyber-blue/10 border-l-[12px] border-cyber-blue uppercase font-mono flex justify-between items-center">
                                                    <span>{s}</span>
                                                    <span className="text-xs text-cyber-blue animate-pulse">HACKEANDO...</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    default: return <div className="text-4xl text-cyber-green">RELOADING...</div>;
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center relative bg-matrix overflow-hidden">
                    {showAudioControls && (
                        <div className="fixed top-8 right-8 z-[3000] flex flex-col items-end gap-3 group">
                            <div className="bg-black/90 border border-cyber-green p-5 rounded opacity-0 group-hover:opacity-100 transition-all shadow-xl">
                                <input type="range" min="0" max="1" step="0.01" value={volume} onChange={e => setVolume(parseFloat(e.target.value))} className="w-32 cursor-pointer" />
                            </div>
                            <button onClick={() => {
                                getAudioContext(); // Ensure context is live
                                if (!audioRef.current) initMusic();
                                setIsMuted(!isMuted);
                            }} className={`w-14 h-14 border-2 flex items-center justify-center text-2xl transition-all ${isMuted ? 'border-cyber-red text-cyber-red' : 'border-cyber-green text-cyber-green shadow-[0_0_15px_#00ff41]'}`}>
                                {isMuted ? 'üîá' : 'üîä'}
                            </button>
                        </div>
                    )}
                    {renderContent()}
                </div>
            );
        }

        const SectorModal = ({ sector, onSolved, onLocked, playSFX }) => {
            const [qIndex, setQIndex] = useState(0);
            const [selected, setSelected] = useState(null);
            const [feedback, setFeedback] = useState('neutral');
            const [shuffledOptions, setShuffledOptions] = useState([]);
            
            const currentQ = sector.questions[qIndex];

            // Mezclar opciones al cargar pregunta
            useEffect(() => {
                if (currentQ) {
                    const options = [...currentQ.options];
                    for (let i = options.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [options[i], options[j]] = [options[j], options[i]];
                    }
                    setShuffledOptions(options);
                }
            }, [currentQ]);

            const handleSelect = (idx) => {
                if (selected !== null) return;
                setSelected(idx);

                // Validamos comparando el texto de la opci√≥n seleccionada con la respuesta correcta original
                const selectedText = shuffledOptions[idx];
                const correctText = currentQ.options[currentQ.correctIndex];

                if (selectedText === correctText) {
                    playSFX('success'); setFeedback('correct');
                    setTimeout(() => {
                        if (qIndex + 1 < sector.questions.length) { setQIndex(p => p+1); setSelected(null); setFeedback('neutral'); }
                        else onSolved(sector.id);
                    }, 800);
                } else {
                    playSFX('error'); setFeedback('wrong');
                    setTimeout(() => onLocked(), 1000);
                }
            };

            if (!currentQ) return null;
            return (
                <div className="fixed inset-0 z-[2000] flex items-center justify-center bg-black/95 p-4 backdrop-blur-sm">
                    <div className="cyber-border w-full max-w-3xl p-10 bg-cyber-dark shadow-[0_0_100px_rgba(0,255,65,0.2)]">
                        <div className="mb-8 w-full">
                            <div className="flex justify-between items-end mb-2">
                                <h3 className="text-3xl text-cyber-green font-black uppercase font-mono tracking-widest leading-none">SECTOR_0{sector.id}</h3>
                                <span className="text-cyber-green/60 font-mono text-xs tracking-widest">SECUENCIA_DE_NODO</span>
                            </div>
                            
                            {/* Barra de Progreso Gr√°fica */}
                            <div className="flex gap-1 w-full h-3">
                                {sector.questions.map((_, i) => {
                                    const status = i < qIndex ? 'done' : (i === qIndex ? 'active' : 'pending');
                                    return (
                                        <div key={i} className={`flex-1 relative transition-all duration-300 transform skew-x-[-20deg] border
                                            ${status === 'done' ? 'bg-cyber-green border-cyber-green shadow-[0_0_8px_#00ff41]' : ''}
                                            ${status === 'active' ? 'bg-cyber-blue/20 border-cyber-blue shadow-[0_0_10px_#00f3ff] animate-pulse' : ''}
                                            ${status === 'pending' ? 'bg-transparent border-gray-800 opacity-30' : ''}
                                        `}>
                                            {/* Indicador de posici√≥n actual */}
                                            {status === 'active' && (
                                                 <div className="absolute -top-5 left-0 w-full text-center text-[10px] text-cyber-blue font-bold tracking-wider skew-x-[20deg]">
                                                    {i + 1}/{sector.questions.length}
                                                 </div>
                                            )}
                                        </div>
                                    )
                                })}
                            </div>
                            <div className="h-px w-full bg-gradient-to-r from-cyber-green/0 via-cyber-green/50 to-cyber-green/0 mt-4"></div>
                        </div>

                        {currentQ.imageUrl && <img src={currentQ.imageUrl} className="w-full h-56 object-cover mb-8 border border-cyber-green/30 grayscale contrast-125 shadow-lg" />}
                        <p className="text-3xl text-white mb-12 leading-relaxed font-black font-mono">{currentQ.question}</p>
                        <div className="grid gap-5">
                            {shuffledOptions.map((opt, i) => (
                                <button key={i} onClick={() => handleSelect(i)} disabled={selected !== null} className={`p-6 text-left border-2 transition-all font-black text-xl font-mono ${selected === i ? (feedback === 'correct' ? 'bg-cyber-green text-black border-white' : 'bg-cyber-red text-white border-white animate-shake') : (selected !== null ? 'opacity-30' : 'border-cyber-green/20 text-cyber-green hover:border-cyber-green hover:bg-cyber-green/10 hover:translate-x-2')}`}>{opt}</button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>