<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scape Room - Protocolo Cyberpunk</title>
    <link rel="icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text y=%22.9em%22 font-size=%2290%22&gt;üê∫&lt;/text&gt;&lt;/svg&gt;">
    
    <!-- Librer√≠as UMD -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            black: '#020202',
                            green: '#00ff41',
                            blue: '#00f3ff',
                            red: '#ff003c',
                            gold: '#ffd700',
                            dark: '#0a0a0a'
                        }
                    },
                    fontFamily: { mono: ['"Share Tech Mono"', 'monospace'] },
                    animation: {
                        'glitch': 'glitch 1s linear infinite',
                        'scanline': 'scanline 8s linear infinite',
                        'flicker': 'flicker 3s linear infinite',
                        'pulse-soft': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'alarm': 'alarm 0.5s ease-in-out infinite alternate',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'float': 'float 4s ease-in-out infinite',
                    },
                    keyframes: {
                        glitch: {
                            '2%, 64%': { transform: 'translate(2px,0) skew(0deg)' },
                            '4%, 60%': { transform: 'translate(-2px,0) skew(0deg)' },
                            '62%': { transform: 'translate(0,0) skew(5deg)' },
                        },
                        scanline: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' }
                        },
                        alarm: {
                            'from': { backgroundColor: 'rgba(255, 0, 60, 0.1)' },
                            'to': { backgroundColor: 'rgba(255, 0, 60, 0.5)' }
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #020202;
            color: #00ff41;
            overflow-x: hidden;
            font-family: 'Share Tech Mono', monospace;
        }
        .bg-matrix {
            background-image: linear-gradient(rgba(0, 255, 65, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0, 255, 65, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none;
            z-index: 999;
        }
        .cyber-border {
            position: relative;
            border: 1px solid rgba(0, 255, 65, 0.2);
            box-sizing: border-box;
        }
        .cyber-border::before, .cyber-border::after,
        .cyber-border > .corner::before, .cyber-border > .corner::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            border: 2px solid #00ff41;
            box-shadow: 0 0 10px #00ff41;
            pointer-events: none;
        }
        .cyber-border::before { top: -2px; left: -2px; border-right: 0; border-bottom: 0; }
        .cyber-border::after { top: -2px; right: -2px; border-left: 0; border-bottom: 0; }
        .cyber-border > .corner::before { bottom: -2px; left: -2px; border-right: 0; border-top: 0; }
        .cyber-border > .corner::after { bottom: -2px; right: -2px; border-left: 0; border-top: 0; }

        .glitch-effect { text-shadow: 3px 0 #ff003c, -3px 0 #00f3ff; }
        
        input[type=range] {
          -webkit-appearance: none;
          width: 100%;
          background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
          width: 100%; height: 12px; cursor: pointer; background: #111; border-radius: 6px; border: 1px solid #00ff4155;
        }
        input[type=range]::-webkit-slider-thumb {
          border: 2px solid #00ff41; height: 32px; width: 18px; border-radius: 3px; background: #00ff41; cursor: pointer; -webkit-appearance: none; margin-top: -11px; box-shadow: 0 0 20px #00ff41;
        }
        
        .huge-text { font-size: clamp(4rem, 15vw, 12rem); line-height: 0.8; }

        .vault-input {
            background: #000;
            border: 2px solid #00f3ff;
            color: #00f3ff;
            text-shadow: 0 0 10px #00f3ff;
            font-family: 'Share Tech Mono', monospace;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
        }
        .vault-input:focus {
            box-shadow: 0 0 20px #00f3ff;
            outline: none;
            border-color: #fff;
        }

        .admin-keyword-input {
            background: rgba(0,0,0,0.8);
            border: 2px solid rgba(0, 255, 65, 0.4);
            color: #00ff41;
            font-family: 'Share Tech Mono', monospace;
            width: 100%;
            padding: 1rem;
            font-size: 1.5rem;
            outline: none;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        .admin-keyword-input:focus {
            border-color: #00ff41;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }
        
        .led-green { background: #00ff41; box-shadow: 0 0 10px #00ff41; }
        .led-blue { background: #00f3ff; box-shadow: 0 0 10px #00f3ff; }

        .scan-animation {
            background: linear-gradient(0deg, transparent 0%, rgba(0, 243, 255, 0.1) 50%, transparent 100%);
            background-size: 100% 200%;
            animation: scan 3s linear infinite;
        }
        @keyframes scan {
            0% { background-position: 0 -100%; }
            100% { background-position: 0 100%; }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>
    <div class="crt-overlay"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MUSIC_URL = "https://cdn.pixabay.com/audio/2023/12/03/audio_82c610484a.mp3";
        const SQUADS = [
            { name: 'Cobra', icon: 'üêç' }, { name: 'Tigre', icon: 'üêÖ' },
            { name: 'Halc√≥n', icon: 'ü¶Ö' }, { name: 'Lobo', icon: 'üê∫' },
            { name: 'Tibur√≥n', icon: 'ü¶à' }, { name: '√Åguila', icon: 'ü¶Ö' },
            { name: 'Pantera', icon: 'üêÜ' }, { name: 'Oso', icon: 'üêª' },
        ];

        const INITIAL_STATE = { 
            stage: 'selection', 
            roomId: '', 
            adminKeyword: '', 
            sectors: [], 
            connectedSquads: [], 
            finishedSquads: [], 
            takenSquads: [], 
            rawQuestions: [],
            squadAnimal: null
        };

        const EXAMPLE_CSV_CONTENT = `Tipo;Pregunta;R1;R2;R3;R4;Tiempo;Correcta;URL Imagen
quiz;¬øQu√© operador repite cadenas en Python?;*;x;repeat();**;30;1;
quiz;¬øQu√© m√©todo especial se ejecuta al crear un objeto?;__init__;__start__;constructor;__new__;30;1;
quiz;¬øQu√© operador concatena cadenas en Python?;+;concat();join;.;30;1;
quiz;¬øC√≥mo se define una funci√≥n en Python?;def;func;function;define;30;1;
quiz;¬øQu√© tipo de dato es [1, 2, 3]?;Lista;Tupla;Diccionario;Set;30;1;
quiz;¬øC√≥mo se importa un m√≥dulo?;import;use;require;include;30;1;
quiz;¬øQu√© palabra clave maneja excepciones?;try;catch;handle;error;30;1;
quiz;¬øCu√°l es el valor de 3**2 en Python?;9;6;27;3;30;1;
quiz;¬øC√≥mo se llama la librer√≠a est√°ndar para mate?;math;maths;mat;calc;30;1;
quiz;¬øQu√© funci√≥n mide la longitud de una lista?;len();size();count();length();30;1;
quiz;¬øCu√°l es el valor booleano de 0 en Python?;False;True;None;Undefined;30;1;
quiz;¬øC√≥mo se agrega un elemento a una lista?;append();add();push();insert();30;1;
quiz;¬øQu√© s√≠mbolo inicia un comentario?;#;//;--;/*;30;1;
quiz;¬øQu√© palabra clave crea un bucle?;for;while;both;repeat;30;3;
quiz;¬øQu√© funci√≥n muestra texto en consola?;print();echo();write();log();30;1;
quiz;¬øC√≥mo se sale de un bucle prematuramente?;break;exit;stop;return;30;1;
quiz;¬øQu√© operador comprueba igualdad?;==;=;equals;is;30;1;
quiz;¬øC√≥mo se obtiene la entrada del usuario?;input();get();read();prompt();30;1;
quiz;¬øQu√© palabra define una clase?;class;struct;type;obj;30;1;
quiz;¬øQu√© valor devuelve una funci√≥n por defecto?;None;Null;0;False;30;1;`;

        const parseCSV = (csvText) => {
            const lines = csvText.trim().split('\n');
            const startIndex = lines[0].toLowerCase().includes('tipo') ? 1 : 0;
            return lines.slice(startIndex).map((line, i) => {
                const parts = line.split(';').map(p => p.trim().replace(/^"|"$/g, ''));
                if (parts.length < 8) return null;
                return {
                    id: `q-${i}`,
                    question: parts[1],
                    options: [parts[2], parts[3], parts[4], parts[5]].filter(o => o !== ''),
                    correctIndex: (parseInt(parts[7], 10) || 1) - 1,
                    imageUrl: parts[8] || null
                };
            }).filter(q => q !== null);
        };

        const downloadExampleCSV = () => {
            const blob = new Blob([EXAMPLE_CSV_CONTENT], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "mision_python_20_preguntas.csv");
            link.click();
        };

        const Typewriter = ({ text, speed = 30, className }) => {
            const [disp, setDisp] = useState('');
            useEffect(() => {
                let i = 0;
                const timer = setInterval(() => {
                    if (i < text.length) { setDisp(t => t + text.charAt(i)); i++; }
                    else clearInterval(timer);
                }, speed);
                return () => clearInterval(timer);
            }, [text]);
            return <div className={className}>{disp}<span className="animate-pulse inline-block w-2 h-5 bg-cyber-green ml-1 align-middle"></span></div>;
        };

        const SectorModal = ({ sector, onSolved, onLocked }) => {
            const [qIndex, setQIndex] = useState(0);
            const [selected, setSelected] = useState(null);
            const [feedback, setFeedback] = useState('neutral');
            const [shuffledOptions, setShuffledOptions] = useState([]);
            const currentQ = sector.questions[qIndex];

            useEffect(() => {
                if (currentQ) {
                    const optionsWithMeta = currentQ.options.map((text, i) => ({
                        text,
                        isCorrect: i === currentQ.correctIndex
                    }));
                    const copy = [...optionsWithMeta];
                    for (let i = copy.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [copy[i], copy[j]] = [copy[j], copy[i]];
                    }
                    setShuffledOptions(copy);
                    setSelected(null);
                    setFeedback('neutral');
                }
            }, [currentQ]);

            const handleSelect = (idx) => {
                if (selected !== null) return;
                setSelected(idx);
                if (shuffledOptions[idx].isCorrect) {
                    setFeedback('correct');
                    setTimeout(() => {
                        if (qIndex + 1 < sector.questions.length) setQIndex(prev => prev + 1);
                        else onSolved(sector.id);
                    }, 800);
                } else {
                    setFeedback('wrong');
                    setTimeout(() => onLocked(), 1000);
                }
            };

            if (!currentQ) return null;

            return (
                <div className="fixed inset-0 z-[2000] flex items-center justify-center bg-black/95 p-4 backdrop-blur-sm">
                    <div className="cyber-border w-full max-w-2xl p-8 bg-cyber-dark shadow-[0_0_60px_rgba(0,255,65,0.2)]">
                        <div className="corner"></div>
                        <div className="flex justify-between items-center mb-6 border-b border-cyber-green/30 pb-4">
                            <h3 className="text-xl text-cyber-green font-black uppercase tracking-widest font-mono">
                                NODO 0{sector.id} // SECCI√ìN {qIndex + 1}/4
                            </h3>
                            <div className="flex gap-1">
                                {[0,1,2,3].map(i => <div key={i} className={`w-3 h-3 rounded-full ${i < qIndex ? 'led-green' : i === qIndex ? 'led-blue animate-pulse' : 'bg-gray-800'}`}></div>)}
                            </div>
                        </div>
                        {currentQ.imageUrl && <img src={currentQ.imageUrl} className="w-full h-48 object-cover mb-6 border border-cyber-green/30 grayscale contrast-125" />}
                        <p className="text-2xl text-white mb-10 leading-relaxed font-bold font-mono">{currentQ.question}</p>
                        <div className="grid gap-4">
                            {shuffledOptions.map((opt, i) => (
                                <button key={i} onClick={() => handleSelect(i)} disabled={selected !== null} className={`p-5 text-left border-2 transition-all font-bold tracking-wider ${selected === i ? (feedback === 'correct' ? 'bg-cyber-green text-black border-white scale-95' : 'bg-cyber-red text-white border-white animate-shake') : (selected !== null ? 'opacity-50 border-gray-800 text-gray-700' : 'border-cyber-green/20 text-cyber-green hover:border-cyber-green hover:bg-cyber-green/10')}`}>
                                    <span className="opacity-50 mr-2 text-sm font-mono">{">"}</span>{opt.text}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const AudioControl = ({ volume, setVolume, isMuted, setIsMuted }) => (
            <div className="fixed top-6 right-6 z-[3000] flex flex-col items-end gap-3 group">
                <div className="bg-black/90 border-2 border-cyber-green/40 p-5 rounded-lg opacity-0 group-hover:opacity-100 transition-all shadow-[0_0_30px_rgba(0,255,65,0.2)] translate-x-4 group-hover:translate-x-0">
                    <div className="flex flex-col items-center gap-4">
                        <input type="range" min="0" max="1" step="0.01" value={volume} onChange={e => setVolume(parseFloat(e.target.value))} className="w-32 cursor-pointer" />
                        <span className="text-xs font-black text-cyber-green tracking-tighter font-mono">{Math.round(volume * 100)}% VOL</span>
                    </div>
                </div>
                <button onClick={() => setIsMuted(!isMuted)} className={`w-12 h-12 rounded-sm border-2 flex items-center justify-center text-xl transition-all ${isMuted ? 'border-cyber-red text-cyber-red' : 'border-cyber-green text-cyber-green shadow-[0_0_15px_#00ff41]'}`}>{isMuted ? '√ó' : '‚àΩ'}</button>
            </div>
        );

        function App() {
            const [gameState, setGameState] = useState(INITIAL_STATE);
            const [volume, setVolume] = useState(0.3);
            const [isMuted, setIsMuted] = useState(true);
            const [activeSectorId, setActiveSectorId] = useState(null);
            const [vaultCodes, setVaultCodes] = useState(['','','','','']);
            const [keywordInput, setKeywordInput] = useState('');
            const [csvFile, setCsvFile] = useState(null);
            const [joinRoomId, setJoinRoomId] = useState('');
            const [isConnecting, setIsConnecting] = useState(false);
            const [isSquadSelecting, setIsSquadSelecting] = useState(false);
            const [lockout, setLockout] = useState(0);
            
            const audioRef = useRef(null);
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const adminConns = useRef([]);
            const startTimeRef = useRef(null);
            const gameStateRef = useRef(gameState);

            useEffect(() => { gameStateRef.current = gameState; }, [gameState]);
            useEffect(() => {
                if (lockout <= 0) return;
                const timer = setInterval(() => setLockout(p => p - 1), 1000);
                return () => clearInterval(timer);
            }, [lockout]);
            useEffect(() => {
                audioRef.current = new Audio(MUSIC_URL);
                audioRef.current.loop = true;
                return () => { if(audioRef.current) audioRef.current.pause(); };
            }, []);
            useEffect(() => {
                if (!audioRef.current) return;
                audioRef.current.volume = volume;
                if(isMuted) audioRef.current.pause(); else audioRef.current.play().catch(() => {});
            }, [isMuted, volume]);

            const startAdmin = () => {
                if (!keywordInput || !csvFile) return alert("PALABRA MAESTRA Y CSV REQUERIDOS");
                const reader = new FileReader();
                reader.onload = (e) => {
                    const questions = parseCSV(e.target.result);
                    const id = Math.random().toString(36).substring(2, 7).toUpperCase();
                    const peer = new Peer(`sr-host-${id}`);
                    peer.on('open', () => setGameState(s => ({...s, stage: 'admin-lobby', roomId: id, adminKeyword: keywordInput.toUpperCase(), rawQuestions: questions})));
                    peer.on('connection', c => {
                        c.on('open', () => { 
                            adminConns.current.push(c); 
                            c.send({type: 'SYNC', taken: gameStateRef.current.connectedSquads}); 
                        });
                        c.on('data', d => {
                            if (d.type === 'REQ') {
                                setGameState(s => {
                                    if (s.connectedSquads.includes(d.name)) { c.send({type:'NO'}); return s; }
                                    c.send({type:'OK'});
                                    const newSquads = [...s.connectedSquads, d.name];
                                    adminConns.current.forEach(conn => conn.send({type:'SYNC', taken: newSquads}));
                                    return {...s, connectedSquads: newSquads};
                                });
                            }
                            if (d.type === 'FIN') setGameState(s => ({...s, finishedSquads: [...s.finishedSquads, {name: d.name, time: Date.now() - startTimeRef.current}]}));
                        });
                    });
                    peerRef.current = peer;
                };
                reader.readAsText(csvFile);
            };

            const connectSquad = () => {
                if (!joinRoomId) return;
                setIsConnecting(true);
                const peer = new Peer();
                peer.on('open', () => {
                    const c = peer.connect(`sr-host-${joinRoomId.toUpperCase()}`);
                    c.on('open', () => connRef.current = c);
                    c.on('data', d => {
                        if (d.type === 'SYNC') { setGameState(s => ({...s, stage: 'squad-selection', takenSquads: d.taken})); setIsConnecting(false); }
                        if (d.type === 'OK') setGameState(s => ({...s, stage: 'squad-lobby'}));
                        if (d.type === 'GO') setGameState(s => ({...s, stage: 'squad-intro', adminKeyword: d.kw, sectors: d.sectors}));
                    });
                    c.on('error', () => { alert("NODO NO ENCONTRADO"); setIsConnecting(false); });
                });
                peerRef.current = peer;
            };

            const launchMission = () => {
                startTimeRef.current = Date.now();
                const shuffled = [...gameState.rawQuestions].sort(() => Math.random() - 0.5);
                const sectors = [1,2,3,4,5].map(i => {
                    const startIdx = (i - 1) * 4;
                    let sq = shuffled.slice(startIdx, startIdx + 4);
                    while (sq.length < 4) sq.push(shuffled[Math.floor(Math.random() * shuffled.length)]);
                    return { id: i, questions: sq, isSolved: false, accessCode: Math.floor(Math.random()*90+10).toString() };
                });
                adminConns.current.forEach(c => c.send({type:'GO', kw: gameState.adminKeyword, sectors}));
                setGameState(s => ({...s, stage: 'admin-monitor'}));
            };

            const formatTime = (ms) => {
                const s = Math.floor(ms / 1000);
                return `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
            };

            const resetGame = () => {
                if(peerRef.current) peerRef.current.destroy();
                adminConns.current = [];
                setGameState(INITIAL_STATE);
                setVaultCodes(['','','','','']);
                setKeywordInput('');
                setJoinRoomId('');
                setActiveSectorId(null);
                setIsSquadSelecting(false);
            };

            if (lockout > 0) return (
                <div className="fixed inset-0 z-[5000] bg-black animate-alarm flex flex-col items-center justify-center text-center p-4">
                    <div className="text-cyber-red text-6xl md:text-8xl font-black mb-8 glitch-effect animate-glitch uppercase tracking-tighter font-mono">SISTEMA BLOQUEADO</div>
                    <div className="text-white text-xl md:text-2xl font-bold uppercase tracking-[0.5em] mb-12 font-mono">Protocolo de Purga en curso...</div>
                    <div className="text-cyber-red text-[12rem] font-black leading-none tabular-nums animate-pulse font-mono">{lockout}</div>
                </div>
            );

            if (gameState.stage === 'selection') return (
                <div className="min-h-screen flex items-center justify-center relative bg-matrix">
                    <AudioControl volume={volume} setVolume={setVolume} isMuted={isMuted} setIsMuted={setIsMuted} />
                    <div className="absolute inset-0 bg-black/60"></div>
                    <div className="z-10 text-center px-4 w-full max-w-4xl">
                        <h1 className="text-7xl md:text-[11rem] font-black text-cyber-green glitch-effect animate-glitch mb-12 uppercase tracking-tighter leading-none font-mono">Scape room</h1>
                        <div className="flex flex-col md:flex-row gap-6 justify-center mt-12">
                            <button onClick={() => setGameState(s => ({...s, stage: 'admin-setup'}))} className="cyber-border px-10 py-5 text-xl font-black uppercase hover:bg-cyber-green hover:text-black transition-all font-mono">Administrador <div className="corner"></div></button>
                            <button onClick={() => setGameState(s => ({...s, stage: 'squad-setup'}))} className="cyber-border border-cyber-blue text-cyber-blue px-10 py-5 text-xl font-black uppercase hover:bg-cyber-blue hover:text-black transition-all font-mono">Escuadr√≥n <div className="corner" style={{borderColor:'#00f3ff'}}></div></button>
                        </div>
                        <div className="mt-20"><button onClick={downloadExampleCSV} className="text-cyber-gold text-[10px] font-black uppercase tracking-[0.4em] border border-cyber-gold/20 px-4 py-2 hover:bg-cyber-gold/10 transition-all opacity-60 hover:opacity-100 font-mono">[ Descargar Banco de Datos ]</button></div>
                    </div>
                </div>
            );

            if (gameState.stage === 'admin-setup') return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-matrix">
                    <div className="cyber-border max-w-lg w-full p-8 md:p-12 bg-black shadow-[0_0_50px_rgba(0,255,65,0.1)]">
                        <div className="corner"></div>
                        <h2 className="text-2xl text-cyber-green mb-10 font-black uppercase tracking-widest border-b border-cyber-green/20 pb-4 font-mono">Protocolo de Enlace</h2>
                        <div className="space-y-8">
                            <div className="w-full">
                                <label className="block text-cyber-blue text-[10px] uppercase mb-3 font-black tracking-widest font-mono">Keyword Maestra (Capa de Cifrado Final)</label>
                                <input 
                                    type="password" 
                                    value={keywordInput} 
                                    onChange={e => setKeywordInput(e.target.value)} 
                                    className="admin-keyword-input"
                                    placeholder="INTRODUCIR CLAVE..."
                                />
                            </div>
                            <div className="w-full">
                                <label className="block text-cyber-blue text-[10px] uppercase mb-3 font-black tracking-widest font-mono">Protocolos de Misi√≥n (.CSV)</label>
                                <input type="file" accept=".csv" onChange={e => setCsvFile(e.target.files[0])} className="w-full text-[10px] text-gray-500 font-black file:bg-cyber-green/10 file:text-cyber-green file:border file:border-cyber-green file:px-4 file:py-2 file:rounded-none file:mr-4 file:uppercase hover:file:bg-cyber-green hover:file:text-black transition-all font-mono" />
                            </div>
                            <button onClick={startAdmin} className="w-full bg-cyber-green text-black font-black py-5 text-xl uppercase shadow-[0_0_25px_rgba(0,255,65,0.4)] hover:scale-[1.02] transition-transform font-mono">Establecer Frecuencia</button>
                            <button onClick={() => setGameState(s => ({...s, stage: 'selection'}))} className="w-full text-center text-[10px] text-gray-600 uppercase font-black tracking-widest font-mono">Abortar Operaci√≥n</button>
                        </div>
                    </div>
                </div>
            );

            if (gameState.stage === 'admin-lobby') return (
                <div className="min-h-screen p-10 flex flex-col items-center bg-black">
                    <p className="text-cyber-blue text-sm uppercase tracking-[1em] mb-4 font-black font-mono">ID DE FRECUENCIA</p>
                    <div className="huge-text font-black text-cyber-green animate-pulse-soft border-4 border-cyber-green/50 px-12 py-8 bg-cyber-green/5 mb-16 shadow-[0_0_40px_rgba(0,255,65,0.1)] font-mono">{gameState.roomId}</div>
                    <div className="w-full max-w-5xl grid md:grid-cols-2 gap-8">
                        <div className="cyber-border p-8 bg-cyber-dark">
                            <h3 className="text-cyber-blue uppercase mb-6 font-black text-xs tracking-widest font-mono">Unidades Sincronizadas</h3>
                            <div className="flex flex-wrap gap-3 font-mono">{gameState.connectedSquads.map(s => <div key={s} className="px-5 py-3 border border-cyber-green text-lg font-black uppercase bg-cyber-green/5 shadow-[0_0_10px_rgba(0,255,65,0.2)] font-mono">{s}</div>)}</div>
                        </div>
                        <button onClick={launchMission} disabled={gameState.connectedSquads.length === 0} className={`w-full py-10 text-5xl font-black uppercase transition-all font-mono ${gameState.connectedSquads.length > 0 ? 'bg-cyber-green text-black shadow-[0_0_50px_#00ff41] hover:scale-105' : 'bg-gray-800 text-gray-600 cursor-not-allowed'}`}>Lanzar Misi√≥n</button>
                    </div>
                </div>
            );

            if (gameState.stage === 'squad-setup') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-matrix">
                    <div className="cyber-border p-12 bg-black/90 text-center max-w-md w-full shadow-[0_0_50px_rgba(0,243,255,0.1)]">
                        <div className="corner" style={{borderColor:'#00f3ff'}}></div>
                        <h2 className="text-3xl text-cyber-blue mb-10 uppercase font-black tracking-widest font-mono">Unirse a la Red</h2>
                        <input type="text" maxLength={5} value={joinRoomId} onChange={e => setJoinRoomId(e.target.value.toUpperCase())} placeholder="-----" className="bg-black border-4 border-cyber-blue p-6 text-center text-2xl mb-10 outline-none uppercase font-black text-white focus:shadow-[0_0_20px_#00f3ff] font-mono w-full" />
                        <button onClick={connectSquad} className="w-full bg-cyber-blue text-black font-black py-5 text-xl uppercase hover:bg-white transition-all font-mono">{isConnecting ? 'ESTABLECIENDO V√çNCULO...' : 'Conectar'}</button>
                    </div>
                </div>
            );

            if (gameState.stage === 'squad-selection') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-10 bg-cyber-dark">
                    <h2 className="text-4xl text-cyber-blue mb-16 uppercase font-black tracking-[0.4em] glitch-effect font-mono">Elegir Unidad Operativa</h2>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-5xl w-full">
                        {SQUADS.map(s => (
                            <button 
                                key={s.name} 
                                disabled={gameState.takenSquads.includes(s.name) || isSquadSelecting} 
                                onClick={() => { 
                                    setIsSquadSelecting(true);
                                    if(connRef.current) connRef.current.send({type:'REQ', name:s.name}); 
                                    setGameState(gs => ({...gs, squadAnimal: s.name}));
                                }} 
                                className={`cyber-border p-8 flex flex-col items-center gap-4 transition-all group ${gameState.takenSquads.includes(s.name) || isSquadSelecting ? 'opacity-10 grayscale cursor-not-allowed' : 'hover:border-cyber-blue hover:bg-cyber-blue/5 hover:scale-105'}`}
                            >
                                <div className="corner" style={{borderColor: (gameState.takenSquads.includes(s.name) || isSquadSelecting) ? '#333' : '#00f3ff'}}></div>
                                <span className="text-7xl group-hover:animate-float">{s.icon}</span>
                                <span className="font-black uppercase text-xs tracking-widest border-t border-cyber-blue/20 pt-4 w-full text-center font-mono">{s.name}</span>
                            </button>
                        ))}
                    </div>
                    {isSquadSelecting && <div className="mt-10 text-cyber-blue animate-pulse font-mono uppercase tracking-widest">Sincronizando con el servidor central...</div>}
                </div>
            );

            if (gameState.stage === 'squad-lobby') return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-black text-center fixed inset-0 z-[4000] overflow-hidden">
                    <div className="scan-animation absolute inset-0 opacity-10 pointer-events-none"></div>
                    <div className="cyber-border p-12 md:p-20 bg-cyber-green/5 max-w-4xl w-full shadow-[0_0_100px_rgba(0,255,65,0.1)]">
                        <div className="corner"></div>
                        <div className="text-[10rem] mb-12 animate-pulse drop-shadow-[0_0_30px_#00ff41]">üì°</div>
                        <h2 className="text-4xl md:text-5xl font-black text-cyber-green mb-10 uppercase tracking-[0.2em] leading-tight glitch-effect font-mono">
                            ESPERAR LAS √ìRDENES DEL MANDO SUPERIOR PARA EMPEZAR
                        </h2>
                        <div className="flex justify-center gap-4 mb-10">
                            <div className="w-4 h-4 rounded-full led-green"></div>
                            <div className="w-4 h-4 rounded-full led-green"></div>
                            <div className="w-4 h-4 rounded-full bg-gray-800 animate-pulse"></div>
                        </div>
                        <p className="text-cyber-blue font-black uppercase text-xs tracking-[0.8em] font-mono opacity-50">Sincronizaci√≥n de unidad en curso...</p>
                    </div>
                </div>
            );

            if (gameState.stage === 'squad-intro') return (
                <div className="min-h-screen flex items-center justify-center p-10 bg-black">
                    <div className="cyber-border max-w-3xl p-14 bg-cyber-dark shadow-[0_0_80px_rgba(0,255,65,0.1)]">
                        <div className="corner"></div>
                        <Typewriter speed={20} text={`>>> ANALIZANDO OBJETIVO...\n>>> UNIDAD ASIGNADA: ${gameState.squadAnimal ? gameState.squadAnimal.toUpperCase() : '??'}\n>>> MISI√ìN: HACKEO DE LA RED CENTRAL HYDRA.\n>>> ESTRUCTURA: 5 SECTORES DE SEGURIDAD.\n>>> REQUISITO: 4 NODOS POR SECTOR.\n\nSISTEMA LISTO PARA INFILTRACI√ìN. BUENA SUERTE.`} className="text-xl text-cyber-green whitespace-pre-wrap mb-12 font-black leading-relaxed font-mono" />
                        <button onClick={() => setGameState(p => ({...p, stage:'squad-game'}))} className="px-16 py-6 bg-cyber-green text-black font-black uppercase text-2xl hover:bg-white transition-all shadow-[0_0_30px_rgba(0,255,65,0.2)] font-mono">Ejecutar Protocolo</button>
                    </div>
                </div>
            );

            if (gameState.stage === 'squad-game') {
                const active = gameState.sectors.find(s => s.id === activeSectorId);
                return (
                    <div className="min-h-screen p-6 md:p-10 flex flex-col lg:flex-row gap-8 bg-cyber-dark overflow-hidden">
                        <div className="flex-1 flex flex-col gap-8">
                            <header className="cyber-border bg-black/80 p-6 flex justify-between items-center relative overflow-hidden">
                                <div className="scan-animation absolute inset-0 pointer-events-none opacity-20"></div>
                                <div>
                                    <div className="text-[10px] text-cyber-blue uppercase font-black font-mono tracking-widest">Agente_Activo</div>
                                    <h1 className="text-3xl font-black text-cyber-green uppercase tracking-tighter font-mono">UNIDAD_{gameState.squadAnimal ? gameState.squadAnimal.toUpperCase() : '??'}</h1>
                                </div>
                                <div className="hidden md:flex gap-10">
                                    <div className="text-right">
                                        <div className="text-[10px] text-cyber-gold font-black uppercase font-mono tracking-widest">Se√±al_Red</div>
                                        <div className="flex gap-1 h-4">
                                            <div className="w-1.5 h-full led-green"></div>
                                            <div className="w-1.5 h-full led-green"></div>
                                            <div className="w-1.5 h-full led-green"></div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-[10px] text-cyber-blue font-black uppercase font-mono tracking-widest">CPU_Load</div>
                                        <div className="w-24 h-4 bg-gray-900 border border-cyber-blue/30 relative">
                                            <div className="absolute inset-y-0 left-0 bg-cyber-blue w-2/3 animate-pulse shadow-[0_0_10px_#00f3ff]"></div>
                                        </div>
                                    </div>
                                </div>
                            </header>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {gameState.sectors.map((s) => (
                                    <div key={s.id} onClick={() => !s.isSolved && setActiveSectorId(s.id)} className={`cyber-border p-6 cursor-pointer group transition-all ${s.isSolved ? 'border-cyber-green bg-cyber-green/5' : 'border-cyber-blue/20 hover:border-cyber-blue hover:bg-cyber-blue/5'}`}>
                                        <div className="flex justify-between mb-4">
                                            <span className="text-[10px] font-black uppercase font-mono tracking-widest">Sector_0{s.id}</span>
                                            <span className={`px-2 text-[8px] font-black uppercase font-mono ${s.isSolved ? 'bg-cyber-green text-black' : 'bg-cyber-red/20 text-cyber-red border border-cyber-red animate-pulse'}`}>{s.isSolved ? 'Desbloqueado' : 'Encriptado'}</span>
                                        </div>
                                        <div className="flex items-center justify-center h-20 mb-4">
                                            {s.isSolved ? (
                                                <div className="text-6xl font-black text-cyber-green drop-shadow-[0_0_15px_#00ff41] font-mono">{s.accessCode}</div>
                                            ) : (
                                                <div className="text-5xl font-black text-gray-800 font-mono tracking-widest animate-pulse">??</div>
                                            )}
                                        </div>
                                        <div className="w-full h-1 bg-gray-900">
                                            <div className={`h-full transition-all duration-1000 ${s.isSolved ? 'w-full bg-cyber-green shadow-[0_0_10px_#00ff41]' : 'w-0'}`}></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="w-full lg:w-96 flex">
                            <div className="cyber-border p-8 bg-black/90 relative flex-1 flex flex-col min-h-0">
                                <div className="corner" style={{borderColor:'#00f3ff'}}></div>
                                <h2 className="text-xl text-cyber-blue font-black mb-10 uppercase tracking-[0.2em] border-b border-cyber-blue/30 pb-4 font-mono">B√≥veda Central</h2>
                                <div className="grid grid-cols-5 gap-3 mb-10 w-full overflow-hidden">
                                    {vaultCodes.map((v, i) => (
                                        <div key={i} className="flex flex-col gap-2 min-w-0">
                                            <label className="text-[8px] text-cyber-blue font-black uppercase text-center font-mono tracking-widest">S{i+1}</label>
                                            <input 
                                                maxLength={2} 
                                                value={v} 
                                                onChange={e => { const n = [...vaultCodes]; n[i] = e.target.value; setVaultCodes(n); }} 
                                                className="vault-input py-4 text-xl font-black font-mono" 
                                                placeholder="--" 
                                            />
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => {
                                    if(gameState.sectors.every((s, i) => vaultCodes[i] === s.accessCode)) {
                                        if (connRef.current) connRef.current.send({type:'FIN', name:gameState.squadAnimal});
                                        setGameState(s => ({...s, stage:'squad-win'}));
                                    } else setLockout(10);
                                }} className="w-full bg-cyber-blue text-black font-black py-6 uppercase text-xl shadow-[0_0_20px_#00f3ff] font-mono mb-4 hover:bg-white transition-all active:scale-95">Confirmar Acceso</button>
                                <button onClick={() => setVaultCodes(['','','','',''])} className="w-full border border-cyber-blue/20 text-cyber-blue/50 font-black py-2 uppercase text-[10px] font-mono hover:text-cyber-blue transition-colors">Resetear Secuencia</button>
                                <div className="mt-auto pt-8 text-[9px] text-cyber-blue font-black uppercase font-mono opacity-50 leading-relaxed italic border-t border-cyber-blue/10">
                                    <span className="text-cyber-gold">ADVERTENCIA:</span> Protocolo Hydra detectar√° cualquier intento fallido. Bloqueo de terminal en 1 error.
                                </div>
                            </div>
                        </div>
                        {active && <SectorModal sector={active} onSolved={id => { setGameState(s => ({...s, sectors: s.sectors.map(sec => sec.id === id ? {...sec, isSolved:true} : sec)})); setActiveSectorId(null); }} onLocked={() => { setActiveSectorId(null); setLockout(10); }} />}
                    </div>
                );
            }

            if (gameState.stage === 'squad-win') return (
                <div className="min-h-screen flex items-center justify-center p-10 bg-matrix bg-black text-center">
                    <div className="cyber-border p-16 bg-cyber-dark max-w-4xl shadow-[0_0_100px_rgba(0,255,65,0.2)]">
                        <div className="corner"></div>
                        <h2 className="text-6xl md:text-7xl font-black text-cyber-green mb-10 uppercase italic animate-glitch font-mono tracking-tighter">Infiltraci√≥n Exitosa</h2>
                        <div className="text-[8rem] md:text-[12rem] bg-cyber-green text-black font-black py-10 px-16 mb-12 shadow-[0_0_80px_#fff] border-8 border-white leading-none tracking-widest font-mono animate-glitch">{gameState.adminKeyword}</div>
                        <p className="text-white text-3xl font-black uppercase italic tracking-widest font-mono mb-12">¬°Comunica la clave al Mando Superior!</p>
                        <button onClick={resetGame} className="px-10 py-5 border-2 border-cyber-green text-cyber-green font-black uppercase hover:bg-cyber-green hover:text-black transition-all font-mono shadow-[0_0_20px_rgba(0,255,65,0.3)]">Nueva Misi√≥n</button>
                    </div>
                </div>
            );

            if (gameState.stage === 'admin-monitor') return (
                <div className="min-h-screen p-10 bg-cyber-dark relative flex flex-col">
                    <div className="scan-animation absolute inset-0 opacity-5 pointer-events-none"></div>
                    <header className="flex flex-col md:flex-row justify-between items-center border-b border-cyber-green/20 pb-8 mb-16 gap-4">
                        <h1 className="text-4xl font-black text-cyber-green uppercase flex items-center gap-6 font-mono tracking-tighter">
                            <span className="w-8 h-8 bg-cyber-red rounded-full animate-pulse shadow-[0_0_10px_#ff003c]"></span>
                            Monitoreo T√°ctico Hydra
                        </h1>
                        <button onClick={resetGame} className="px-8 py-3 bg-cyber-red/10 border border-cyber-red text-cyber-red font-black uppercase hover:bg-cyber-red hover:text-white transition-all font-mono text-sm shadow-[0_0_20px_rgba(255,0,60,0.2)]">Nueva Misi√≥n</button>
                    </header>
                    <div className="grid md:grid-cols-2 gap-10 flex-1">
                        <div className="cyber-border p-8 bg-black">
                            <h2 className="text-cyber-gold mb-10 uppercase font-black text-2xl tracking-[0.2em] font-mono border-b border-cyber-gold/20 pb-4">Objetivos Cumplidos</h2>
                            <div className="space-y-6">
                                {gameState.finishedSquads.map((s, i) => (
                                    <div key={i} className="flex justify-between items-center p-6 border border-cyber-green/30 text-4xl font-black uppercase bg-cyber-green/5 shadow-[0_0_15px_rgba(0,255,65,0.1)]">
                                        <span className="text-cyber-green font-mono">{s.name}</span>
                                        <span className="text-white font-mono tracking-tighter">{formatTime(s.time)}</span>
                                    </div>
                                ))}
                                {gameState.finishedSquads.length === 0 && <p className="text-gray-800 text-sm font-mono uppercase tracking-widest italic text-center py-10 border border-dashed border-gray-900">Esperando finalizaci√≥n de unidades...</p>}
                            </div>
                        </div>
                        <div className="cyber-border p-8 bg-black">
                            <h2 className="text-cyber-blue mb-10 uppercase font-black text-2xl tracking-[0.2em] font-mono border-b border-cyber-blue/20 pb-4">Unidades en Campo</h2>
                            <div className="grid gap-4">
                                {gameState.connectedSquads.filter(s => !gameState.finishedSquads.find(f => f.name === s)).map(s => (
                                    <div key={s} className="p-6 text-2xl font-black flex items-center gap-5 bg-cyber-blue/5 border-l-8 border-cyber-blue uppercase font-mono shadow-[0_0_10px_rgba(0,243,255,0.05)]">
                                        <div className="w-3 h-3 bg-cyber-blue rounded-full animate-pulse"></div> {s}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
